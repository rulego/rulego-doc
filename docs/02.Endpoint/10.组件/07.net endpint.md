---
title: Net Endpoint
article: false
author: 
  name: rulego
  link: https://github.com/rulego/rulego
date: 2023-11-08 22:52:33
permalink: /pages/b7050c/
---

***Net Endpoint*** ç”¨äºåˆ›å»ºå’Œå¯åŠ¨ç½‘ç»œåè®®æœåŠ¡å™¨ï¼Œæ”¯æŒå¤šç§åè®®å’Œæ•°æ®åŒ…å¤„ç†æ¨¡å¼ã€‚é€‚ç”¨äºç‰©è”ç½‘è®¾å¤‡æ¥å…¥ã€ä¼ æ„Ÿå™¨æ•°æ®æ”¶é›†ã€ç½‘ç»œåè®®ä»£ç†ç­‰åœºæ™¯ã€‚

## Type

endpoint/net

## æ ¸å¿ƒç‰¹æ€§

### ğŸŒ å¤šåè®®æ”¯æŒ
- **TCP/UDP**: æ ‡å‡†ç½‘ç»œåè®®
- **IPv4/IPv6**: æ”¯æŒ ip4:1, ip6:ipv6-icmp, ip6:58 ç­‰
- **Unix Socket**: unix, unixgram æœ¬åœ°é€šä¿¡
- **æ‰©å±•åè®®**: Go net åŒ…æ”¯æŒçš„æ‰€æœ‰åè®®ç±»å‹

### ğŸ“¦ æ™ºèƒ½æ•°æ®åŒ…åˆ†å‰²
- **line**: æŒ‰è¡Œåˆ†å‰²ï¼ˆ\n æˆ– \r\nï¼‰- é»˜è®¤æ¨¡å¼
- **fixed**: å›ºå®šé•¿åº¦åˆ†å‰²
- **delimiter**: è‡ªå®šä¹‰åˆ†éš”ç¬¦ï¼ˆæ”¯æŒåå…­è¿›åˆ¶æ ¼å¼ï¼‰
- **length_prefix**: é•¿åº¦å‰ç¼€æ¨¡å¼ï¼ˆæ”¯æŒå¤§å°ç«¯åºã€åŒ…å«/ä¸åŒ…å«å‰ç¼€é•¿åº¦ï¼‰

### ğŸ”„ æ•°æ®ç±»å‹å¤„ç†
**é»˜è®¤è¡Œä¸º**: æ‰€æœ‰ç½‘ç»œæ•°æ®é»˜è®¤ä¸º **BINARY** ç±»å‹ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚

**ç±»å‹è½¬æ¢**: é€šè¿‡å†…ç½®å¤„ç†å™¨å¯ä»¥æ”¹å˜æ•°æ®ç±»å‹ï¼š
```javascript
// åœ¨è·¯ç”±é…ç½®ä¸­ä½¿ç”¨å¤„ç†å™¨
router := impl.NewRouter().From("").
  Process("setJsonDataType").    // è®¾ç½®ä¸º JSON ç±»å‹
  To("chain:jsonProcessor").End()
```

**å¯ç”¨å¤„ç†å™¨**ï¼š
- `setJsonDataType`: é€‚ç”¨äº JSON API å’Œ REST æœåŠ¡
- `setTextDataType`: é€‚ç”¨äºæ–‡æœ¬åè®®ï¼ˆHTTPã€SMTP ç­‰ï¼‰
- `setBinaryDataType`: æ˜ç¡®è®¾ç½®ä¸ºäºŒè¿›åˆ¶ï¼ˆé»˜è®¤ï¼‰

### âš¡ çƒ­æ›´æ–°æ”¯æŒ
æ”¯æŒè§„åˆ™é“¾çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡å™¨å³å¯æ›´æ–°å¤„ç†é€»è¾‘ã€‚

## å¯åŠ¨é…ç½®

| å­—æ®µ           | ç±»å‹     | æ˜¯å¦å¿…å¡« | è¯´æ˜                                                   | é»˜è®¤å€¼   |
|--------------|--------|------|------------------------------------------------------|-------|
| protocol     | string | å¦    | ç½‘ç»œåè®®: tcp/udp/unix ç­‰                               | tcp   |
| server       | string | æ˜¯    | æœåŠ¡å™¨åœ°å€ï¼Œæ ¼å¼ä¸º host:portï¼Œå¦‚ ":8888"                      | -     |
| readTimeout  | int    | å¦    | è¯»å–è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ0 è¡¨ç¤ºæ— è¶…æ—¶                                 | 60    |
| packetMode   | string | å¦    | æ•°æ®åŒ…åˆ†å‰²æ¨¡å¼                                            | line  |
| packetSize   | int    | å¦    | æ•°æ®åŒ…å¤§å°ï¼ˆæ ¹æ®æ¨¡å¼å«ä¹‰ä¸åŒï¼‰                                  | 0     |
| delimiter    | string | å¦    | è‡ªå®šä¹‰åˆ†éš”ç¬¦ï¼ˆæ”¯æŒ 0x0A åå…­è¿›åˆ¶æ ¼å¼ï¼‰                           | -     |
| maxPacketSize| int    | å¦    | æœ€å¤§æ•°æ®åŒ…å¤§å°ï¼Œé˜²æ­¢æ¶æ„æ”»å‡»                                   | 64KB  |
| encode       | string | å¦    | âš ï¸ å·²å¼ƒç”¨ï¼šhex/base64 ç¼–ç ï¼Œå»ºè®®åœ¨è§„åˆ™é“¾ä¸­å¤„ç†                  | -     |

## æ•°æ®åŒ…åˆ†å‰²æ¨¡å¼è¯¦è§£

### Line æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
```json
{
  "packetMode": "line"
}
```
é€‚ç”¨äºæ–‡æœ¬åè®®ï¼ŒæŒ‰ `\n` æˆ– `\r\n` åˆ†å‰²æ¶ˆæ¯ã€‚

### Fixed æ¨¡å¼
```json
{
  "packetMode": "fixed",
  "packetSize": 16
}
```
å›ºå®šé•¿åº¦æ•°æ®åŒ…ï¼Œé€‚ç”¨äºäºŒè¿›åˆ¶åè®®ã€‚

### Delimiter æ¨¡å¼
```json
{
  "packetMode": "delimiter",
  "delimiter": "0x0D0A"
}
```
è‡ªå®šä¹‰åˆ†éš”ç¬¦ï¼Œæ”¯æŒåå…­è¿›åˆ¶æ ¼å¼ã€‚

### Length Prefix æ¨¡å¼
```json
{
  "packetMode": "length_prefix_be",
  "packetSize": 2,
  "maxPacketSize": 4096
}
```
é•¿åº¦å‰ç¼€åè®®ï¼Œæ”¯æŒï¼š
- `length_prefix_le`: å°ç«¯åºï¼Œé•¿åº¦ä¸å«å‰ç¼€
- `length_prefix_be`: å¤§ç«¯åºï¼Œé•¿åº¦ä¸å«å‰ç¼€  
- `length_prefix_le_inc`: å°ç«¯åºï¼Œé•¿åº¦å«å‰ç¼€
- `length_prefix_be_inc`: å¤§ç«¯åºï¼Œé•¿åº¦å«å‰ç¼€

## è·¯ç”±é…ç½®

### æ¨èé…ç½®ï¼ˆå•è·¯ç”±æ¨¡å¼ï¼‰
```go
// ç®€å•é…ç½®
router := impl.NewRouter().From("").To("chain:main").End()
ep.AddRouter(router)

// å¸¦æ•°æ®ç±»å‹å¤„ç†å™¨
router := impl.NewRouter().From("").
  Process("setJsonDataType").
  To("chain:jsonProcessor").End()
ep.AddRouter(router)
```

### é«˜çº§è·¯ç”±é…ç½®
```go
// è·¯ç”±åŒ¹é…é€‰é¡¹
options := &net.RouterMatchOptions{
  MatchRawData:   true,           // åŒ¹é…åŸå§‹æ•°æ®
  DataTypeFilter: "JSON",         // æ•°æ®ç±»å‹è¿‡æ»¤
  MinDataLength:  10,             // æœ€å°æ•°æ®é•¿åº¦
  MaxDataLength:  1024,           // æœ€å¤§æ•°æ®é•¿åº¦
}
router := impl.NewRouter().From("^sensor.*").To("chain:sensor").End()
routerId, err := ep.AddRouter(router, options)
```

## å®Œæ•´é…ç½®ç¤ºä¾‹

### IoT ä¼ æ„Ÿå™¨æ¥å…¥
```json
{
  "id": "iot_gateway",
  "type": "endpoint/net", 
  "configuration": {
    "protocol": "tcp",
    "server": ":8080",
    "packetMode": "length_prefix_be",
    "packetSize": 2,
    "maxPacketSize": 1024,
    "readTimeout": 30
  },
  "routers": [
    {
      "from": {
        "path": ".*",
        "processors": ["setBinaryDataType"]
      },
      "to": {
        "path": "chain:iotProcessor"
      }
    }
  ]
}
```

### JSON API æœåŠ¡
```json
{
  "id": "json_api", 
  "type": "endpoint/net",
  "configuration": {
    "protocol": "tcp",
    "server": ":9090",
    "packetMode": "line",
    "readTimeout": 60
  },
  "routers": [
    {
      "from": {
        "path": ".*",
        "processors": ["setJsonDataType"]
      },
      "to": {
        "path": "chain:apiProcessor"
      }
    }
  ]
}
```

### UDP å¹¿æ’­æ¥æ”¶
```json
{
  "id": "udp_receiver",
  "type": "endpoint/net",
  "configuration": {
    "protocol": "udp", 
    "server": ":8888",
    "maxPacketSize": 2048
  },
  "routers": [
    {
      "from": {
        "path": ".*",
        "processors": ["setTextDataType"]
      },
      "to": {
        "path": "chain:udpProcessor"
      }
    }
  ]
}
```

## çƒ­æ›´æ–°ç¤ºä¾‹

```go
// åˆå§‹ DSL é…ç½®
initialDSL := `{
  "ruleChain": {
    "id": "iotProcessor", 
    "root": true
  },
  "metadata": {
    "endpoints": [...],
    "nodes": [...]
  }
}`

// å¯åŠ¨è§„åˆ™å¼•æ“
ruleEngine, _ := rulego.New("iotProcessor", []byte(initialDSL))

// çƒ­æ›´æ–°é…ç½®
updatedDSL := `{...}` // æ–°çš„é…ç½®
err := ruleEngine.ReloadSelf([]byte(updatedDSL))
```

## åº”ç”¨åœºæ™¯

### ğŸ­ å·¥ä¸šç‰©è”ç½‘
- ä¼ æ„Ÿå™¨æ•°æ®æ”¶é›†
- PLC è®¾å¤‡é€šä¿¡
- Modbus TCP ä»£ç†

### ğŸŒ ç½‘ç»œæœåŠ¡
- TCP/UDP ä»£ç†
- åè®®è½¬æ¢ç½‘å…³
- å®æ—¶æ•°æ®æ¨é€

### ğŸ“¡ è®¾å¤‡æ¥å…¥
- MQTT ç½‘å…³
- è®¾å¤‡æ³¨å†ŒæœåŠ¡
- å¿ƒè·³ç›‘æ§

## æœ€ä½³å®è·µ

1. **æ•°æ®ç±»å‹é€‰æ‹©**
   - ç‰©è”ç½‘ä¼ æ„Ÿå™¨ï¼šä¿æŒ BINARY ç±»å‹
   - JSON APIï¼šä½¿ç”¨ `setJsonDataType` å¤„ç†å™¨
   - æ–‡æœ¬åè®®ï¼šä½¿ç”¨ `setTextDataType` å¤„ç†å™¨

2. **è·¯ç”±è®¾è®¡**  
   - æ¨èå•ä¸€é»˜è®¤è·¯ç”±ï¼Œåœ¨è§„åˆ™é“¾ä¸­å¤„ç†å¤æ‚é€»è¾‘
   - é¿å…è¿‡å¤šæ­£åˆ™è¡¨è¾¾å¼è·¯ç”±

3. **æ€§èƒ½ä¼˜åŒ–**
   - åˆç†è®¾ç½® `maxPacketSize` é˜²æ­¢æ¶æ„æ”»å‡»
   - é€‚å½“é…ç½® `readTimeout` é¿å…è¿æ¥å ç”¨

4. **å®‰å…¨è€ƒè™‘**
   - åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é™åˆ¶æœåŠ¡å™¨ç»‘å®šåœ°å€
   - ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®æ¥æº

## ç¤ºä¾‹ä»£ç 

å‚è€ƒå®Œæ•´ç¤ºä¾‹ï¼š
- [Net Endpoint åŸºç¡€ç”¨æ³•](https://github.com/rulego/rulego/tree/main/endpoint/net/net_test.go)
- [å›ºå®šé•¿åº¦åè®®å¤„ç†](https://github.com/rulego/rulego/tree/main/examples/net_endpoint_example/)
- [çƒ­æ›´æ–°æ¼”ç¤º](https://github.com/rulego/rulego/tree/main/test/integration/)