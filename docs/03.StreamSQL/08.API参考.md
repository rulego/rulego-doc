---
title: API参考
date: 2025-07-26 10:08:00
permalink: /pages/streamsql-api/
article: false
author: 
  name: StreamSQL
  link: https://github.com/rulego/streamsql
---

# API参考

本章提供了StreamSQL的完整API参考文档，包括核心接口、配置选项、函数库等详细信息。

## 核心API

### Streamsql 主类

#### 构造函数

```go
func New(options ...Option) *Streamsql
```

创建新的StreamSQL实例。

**参数：**
- `options` - 可选配置项

**返回值：**
- `*Streamsql` - StreamSQL实例

**示例：**
```go
// 默认配置
ssql := streamsql.New()

// 高性能配置
ssql := streamsql.New(streamsql.WithHighPerformance())

// 零数据丢失配置
ssql := streamsql.New(streamsql.WithZeroDataLoss())

// 自定义配置
ssql := streamsql.New(
    streamsql.WithLogLevel(logger.DEBUG),
    streamsql.WithDiscardLog(),
)
```

#### Execute

```go
func (s *Streamsql) Execute(sql string) error
```

执行SQL查询，启动流处理。

**参数：**
- `sql` - SQL查询语句

**返回值：**
- `error` - 执行错误，成功时为nil

**示例：**
```go
sql := "SELECT deviceId, AVG(temperature) FROM stream GROUP BY deviceId, TumblingWindow('5m')"
err := ssql.Execute(sql)
if err != nil {
    log.Fatal(err)
}
```

#### Emit

```go
func (s *Streamsql) Emit(data interface{})
```

向数据流添加数据。

**参数：**
- `data` - 数据记录，通常为`map[string]interface{}`

**示例：**
```go
data := map[string]interface{}{
    "deviceId": "sensor001",
    "temperature": 25.5,
    "timestamp": time.Now(),
}
ssql.Emit(data)
```

#### Stream

```go
func (s *Streamsql) Stream() *stream.Stream
```

获取底层流处理实例。

**返回值：**
- `*stream.Stream` - 流处理实例

**示例：**
```go
stream := ssql.Stream()
stream.AddSink(func(result interface{}) {
    fmt.Printf("结果: %v\n", result)
})
```

#### GetStats

```go
func (s *Streamsql) GetStats() map[string]int64
```

获取流处理统计信息。

**返回值：**
- `map[string]int64` - 统计信息映射

**示例：**
```go
stats := ssql.GetStats()
fmt.Printf("处理数据量: %d\n", stats["processed_count"])
```

#### GetDetailedStats

```go
func (s *Streamsql) GetDetailedStats() map[string]interface{}
```

获取详细的性能统计信息。

**返回值：**
- `map[string]interface{}` - 详细统计信息

#### Stop

```go
func (s *Streamsql) Stop()
```

停止流处理并清理资源。

**示例：**
```go
defer ssql.Stop()
```

## 配置选项

### 性能配置

#### WithHighPerformance

```go
func WithHighPerformance() Option
```

使用高性能配置，适用于需要最大吞吐量的场景。

**示例：**
```go
ssql := streamsql.New(streamsql.WithHighPerformance())
```

#### WithLowLatency

```go
func WithLowLatency() Option
```

使用低延迟配置，适用于实时交互应用。

**示例：**
```go
ssql := streamsql.New(streamsql.WithLowLatency())
```

#### WithZeroDataLoss

```go
func WithZeroDataLoss() Option
```

使用零数据丢失配置，适用于关键业务数据。

**示例：**
```go
ssql := streamsql.New(streamsql.WithZeroDataLoss())
```

#### WithCustomPerformance

```go
func WithCustomPerformance(config types.PerformanceConfig) Option
```

使用自定义性能配置。

**参数：**
- `config` - 自定义性能配置

**示例：**
```go
config := types.DefaultPerformanceConfig()
config.BufferConfig.DataChannelSize = 2000
ssql := streamsql.New(streamsql.WithCustomPerformance(config))
```

### 日志配置

#### WithLogLevel

```go
func WithLogLevel(level logger.Level) Option
```

设置日志级别。

**参数：**
- `level` - 日志级别（DEBUG, INFO, WARN, ERROR, OFF）

**示例：**
```go
ssql := streamsql.New(streamsql.WithLogLevel(logger.DEBUG))
```

#### WithDiscardLog

```go
func WithDiscardLog() Option
```

禁用日志输出（生产环境推荐）。

**示例：**
```go
ssql := streamsql.New(streamsql.WithDiscardLog())
```

### 持久化配置

#### WithPersistence

```go
func WithPersistence() Option
```

使用持久化配置预设。

**示例：**
```go
ssql := streamsql.New(streamsql.WithPersistence())
```

#### WithCustomPersistence

```go
func WithCustomPersistence(dataDir string, maxFileSize int64, flushInterval time.Duration) Option
```

使用自定义持久化配置。

**参数：**
- `dataDir` - 数据目录
- `maxFileSize` - 最大文件大小
- `flushInterval` - 刷新间隔

**示例：**
```go
ssql := streamsql.New(streamsql.WithCustomPersistence("/data", 100*1024*1024, 5*time.Second))
```

### 缓冲区配置

#### WithBufferSizes

```go
func WithBufferSizes(dataChannelSize, resultChannelSize, windowOutputSize int) Option
```

设置自定义缓冲区大小。

**参数：**
- `dataChannelSize` - 数据通道大小
- `resultChannelSize` - 结果通道大小
- `windowOutputSize` - 窗口输出大小

**示例：**
```go
ssql := streamsql.New(streamsql.WithBufferSizes(2000, 1000, 500))
```

### 溢出策略配置

#### WithOverflowStrategy

```go
func WithOverflowStrategy(strategy string, blockTimeout time.Duration) Option
```

设置溢出策略。

**参数：**
- `strategy` - 溢出策略（"drop", "block", "persist"）
- `blockTimeout` - 阻塞超时时间

**示例：**
```go
ssql := streamsql.New(streamsql.WithOverflowStrategy("drop", 5*time.Second))
```

### 工作池配置

#### WithWorkerConfig

```go
func WithWorkerConfig(sinkPoolSize, sinkWorkerCount, maxRetryRoutines int) Option
```

设置工作池配置。

**参数：**
- `sinkPoolSize` - 结果处理池大小
- `sinkWorkerCount` - 工作线程数
- `maxRetryRoutines` - 最大重试协程数

**示例：**
```go
ssql := streamsql.New(streamsql.WithWorkerConfig(100, 10, 5))
```

### 监控配置

#### WithMonitoring

```go
func WithMonitoring(updateInterval time.Duration, enableDetailedStats bool) Option
```

启用详细监控。

**参数：**
- `updateInterval` - 统计更新间隔
- `enableDetailedStats` - 是否启用详细统计

**示例：**
```go
ssql := streamsql.New(streamsql.WithMonitoring(10*time.Second, true))
```

## 流处理API

### Stream 类

#### AddSink

```go
func (s *Stream) AddSink(sink func(interface{}))
```

添加结果处理函数。

**参数：**
- `sink` - 结果处理回调函数

**示例：**
```go
ssql.Stream().AddSink(func(result interface{}) {
    // 处理结果
    fmt.Printf("处理结果: %v\n", result)
})
```

#### .Emit

```go
func (s *Stream) .Emit(data interface{})
```

向流中添加数据。

**参数：**
- `data` - 数据记录

#### GetWindow

```go
func (s *Stream) GetWindow() window.Window
```

获取窗口实例。

**返回值：**
- `window.Window` - 窗口接口

#### Stop

```go
func (s *Stream) Stop()
```

停止流处理。

## 窗口API

### 窗口类型

#### TumblingWindow

```go
func NewTumblingWindow(size time.Duration, timeUnit time.Duration, tsProp string) *TumblingWindow
```

创建滚动窗口。

**参数：**
- `size` - 窗口大小
- `timeUnit` - 时间单位
- `tsProp` - 时间戳字段名

#### SlidingWindow

```go
func NewSlidingWindow(size, slide time.Duration, timeUnit time.Duration, tsProp string) *SlidingWindow
```

创建滑动窗口。

**参数：**
- `size` - 窗口大小
- `slide` - 滑动间隔
- `timeUnit` - 时间单位
- `tsProp` - 时间戳字段名

#### CountingWindow

```go
func NewCountingWindow(count int) *CountingWindow
```

创建计数窗口。

**参数：**
- `count` - 触发计数

#### SessionWindow

```go
func NewSessionWindow(timeout time.Duration, groupByKey string) *SessionWindow
```

创建会话窗口。

**参数：**
- `timeout` - 会话超时时间
- `groupByKey` - 分组字段

### 窗口接口

#### Window 接口

```go
type Window interface {
    Add(data interface{})
    Trigger() []types.WindowResult
    GetType() WindowType
    Stop()
}
```

**方法说明：**

##### Add

```go
Add(data interface{})
```

向窗口添加数据。

##### Trigger

```go
Trigger() []types.WindowResult
```

手动触发窗口计算。

**返回值：**
- `[]types.WindowResult` - 窗口结果列表

##### GetType

```go
GetType() WindowType
```

获取窗口类型。

**返回值：**
- `WindowType` - 窗口类型枚举

##### Stop

```go
Stop()
```

停止窗口处理。

## 函数系统API

### 函数注册

#### RegisterCustomFunction

```go
func RegisterCustomFunction(
    name string,
    funcType FunctionType,
    category string,
    description string,
    minArgs int,
    maxArgs int,
    handler FunctionHandler,
) error
```

注册自定义函数。

**参数：**
- `name` - 函数名
- `funcType` - 函数类型
- `category` - 函数分类
- `description` - 函数描述
- `minArgs` - 最小参数数量
- `maxArgs` - 最大参数数量
- `handler` - 函数处理器

**返回值：**
- `error` - 注册错误

**示例：**
```go
err := functions.RegisterCustomFunction(
    "my_function",
    functions.TypeMath,
    "数学计算",
    "自定义数学函数",
    2, 2,
    func(ctx *functions.FunctionContext, args []interface{}) (interface{}, error) {
        // 函数实现
        return result, nil
    },
)
```

#### Unregister

```go
func Unregister(name string)
```

注销函数。

**参数：**
- `name` - 函数名

**示例：**
```go
functions.Unregister("my_function")
```

#### Exists

```go
func Exists(name string) bool
```

检查函数是否存在。

**参数：**
- `name` - 函数名

**返回值：**
- `bool` - 是否存在

#### Get

```go
func Get(name string) (Function, bool)
```

获取函数实例。

**参数：**
- `name` - 函数名

**返回值：**
- `Function` - 函数实例
- `bool` - 是否存在

#### ListCustomFunctions

```go
func ListCustomFunctions() map[string]Function
```

列出所有自定义函数。

**返回值：**
- `map[string]Function` - 函数名到函数实例的映射

### 函数类型

```go
type FunctionType string

const (
    TypeMath        FunctionType = "math"
    TypeString      FunctionType = "string"
    TypeConversion  FunctionType = "conversion"
    TypeDateTime    FunctionType = "datetime"
    TypeAggregation FunctionType = "aggregation"
    TypeAnalytical  FunctionType = "analytical"
    TypeWindow      FunctionType = "window"
    TypeCustom      FunctionType = "custom"
)
```

### 函数处理器

```go
type FunctionHandler func(ctx *FunctionContext, args []interface{}) (interface{}, error)
```

#### FunctionContext

```go
type FunctionContext struct {
    CurrentRow   map[string]interface{}
    WindowInfo   *WindowInfo
    CustomData   map[string]interface{}
}
```

**字段说明：**
- `CurrentRow` - 当前处理的数据行
- `WindowInfo` - 窗口信息
- `CustomData` - 自定义数据

#### WindowInfo

```go
type WindowInfo struct {
    StartTime time.Time
    EndTime   time.Time
    Size      time.Duration
    Type      string
}
```

### 工具函数

#### ConvertToFloat64

```go
func ConvertToFloat64(value interface{}) (float64, error)
```

转换值为float64类型。

#### ConvertToInt

```go
func ConvertToInt(value interface{}) (int, error)
```

转换值为int类型。

#### ConvertToString

```go
func ConvertToString(value interface{}) (string, error)
```

转换值为string类型。

#### ConvertToTime

```go
func ConvertToTime(value interface{}) (time.Time, error)
```

转换值为time.Time类型。

#### ConvertToFloat64Array

```go
func ConvertToFloat64Array(value interface{}) ([]float64, error)
```

转换值为float64数组。

## 聚合器API

### 聚合类型

```go
type AggregateType string

const (
    AggregateSum        AggregateType = "sum"
    AggregateAvg        AggregateType = "avg"
    AggregateMin        AggregateType = "min"
    AggregateMax        AggregateType = "max"
    AggregateCount      AggregateType = "count"
    AggregateStddev     AggregateType = "stddev"
    AggregateMedian     AggregateType = "median"
    AggregatePercentile AggregateType = "percentile"
    // ... 其他聚合类型
)
```

### Aggregator 接口

```go
type Aggregator interface {
    Add(value interface{}) error
    GetResult() interface{}
    Reset()
    GetType() AggregateType
}
```

## 表达式API

### Expression 接口

```go
type Expression interface {
    Evaluate(data map[string]interface{}) (interface{}, error)
    GetFields() []string
}
```

#### NewExpression

```go
func NewExpression(expr string) (Expression, error)
```

创建表达式实例。

**参数：**
- `expr` - 表达式字符串

**返回值：**
- `Expression` - 表达式实例
- `error` - 创建错误

## 日志API

### Logger 接口

```go
type Logger interface {
    Debug(format string, args ...interface{})
    Info(format string, args ...interface{})
    Warn(format string, args ...interface{})
    Error(format string, args ...interface{})
    SetLevel(level Level)
    SetOutput(writer io.Writer)
}
```

### 日志级别

```go
type Level int

const (
    DEBUG Level = iota
    INFO
    WARN
    ERROR
    OFF
)
```

### 创建日志器

#### New

```go
func New(output io.Writer, level Level) Logger
```

创建新的日志器。

#### NewDiscard

```go
func NewDiscard() Logger
```

创建丢弃日志器。

## 类型定义

### Config

```go
type Config struct {
    WindowConfig     WindowConfig
    GroupFields      []string
    SelectFields     map[string]aggregator.AggregateType
    FieldAlias       map[string]string
    Distinct         bool
    Limit            int
    NeedWindow       bool
    SimpleFields     []string
    Having           string
    FieldExpressions map[string]FieldExpression
}
```

### WindowConfig

```go
type WindowConfig struct {
    Type       window.WindowType
    Params     map[string]interface{}
    TsProp     string
    TimeUnit   time.Duration
    GroupByKey string
}
```

### FieldExpression

```go
type FieldExpression struct {
    Field      string
    Expression string
    Fields     []string
}
```

### WindowResult

```go
type WindowResult struct {
    GroupKey  string
    Results   []map[string]interface{}
    StartTime time.Time
    EndTime   time.Time
}
```

## 错误类型

### 常见错误

```go
var (
    ErrInvalidSQL           = errors.New("无效的SQL语句")
    ErrUnsupportedOperation = errors.New("不支持的操作")
    ErrInvalidParameter     = errors.New("无效的参数")
    ErrFunctionNotFound     = errors.New("函数未找到")
    ErrTypeConversion       = errors.New("类型转换失败")
    ErrWindowNotInitialized = errors.New("窗口未初始化")
)
```

## 使用示例

### 完整示例

```go
package main

import (
    "fmt"
    "log"
    "time"
    "github.com/rulego/streamsql"
    "github.com/rulego/streamsql/functions"
    "github.com/rulego/streamsql/logger"
)

func main() {
    // 1. 创建StreamSQL实例
    ssql := streamsql.New(
        streamsql.WithLogLevel(logger.INFO),
    )
    defer ssql.Stop()
    
    // 2. 注册自定义函数
    err := functions.RegisterCustomFunction(
        "celsius_to_fahrenheit",
        functions.TypeConversion,
        "温度转换",
        "摄氏度转华氏度",
        1, 1,
        func(ctx *functions.FunctionContext, args []interface{}) (interface{}, error) {
            celsius, err := functions.ConvertToFloat64(args[0])
            if err != nil {
                return nil, err
            }
            fahrenheit := celsius*9/5 + 32
            return fahrenheit, nil
        },
    )
    if err != nil {
        log.Fatal(err)
    }
    defer functions.Unregister("celsius_to_fahrenheit")
    
    // 3. 执行SQL查询
    sql := `SELECT deviceId,
                   AVG(temperature) as avg_celsius,
                   AVG(celsius_to_fahrenheit(temperature)) as avg_fahrenheit,
                   COUNT(*) as sample_count,
                   window_start() as window_start
            FROM stream
            WHERE temperature > 0
            GROUP BY deviceId, TumblingWindow('1m')`
    
    err = ssql.Execute(sql)
    if err != nil {
        log.Fatal(err)
    }
    
    // 4. 添加结果处理
    ssql.Stream().AddSink(func(result interface{}) {
        fmt.Printf("聚合结果: %v\n", result)
    })
    
    // 5. 发送数据
    devices := []string{"sensor001", "sensor002", "sensor003"}
    go func() {
        for i := 0; i < 100; i++ {
            for _, device := range devices {
                data := map[string]interface{}{
                    "deviceId":    device,
                    "temperature": 20.0 + rand.Float64()*15,
                    "timestamp":   time.Now(),
                }
                ssql..Emit(data)
            }
            time.Sleep(5 * time.Second)
        }
    }()
    
    // 6. 等待结果
    time.Sleep(5 * time.Minute)
}
```

## 最佳实践

### 错误处理

```go
// 检查SQL执行错误
err := ssql.Execute(sql)
if err != nil {
    log.Printf("SQL执行失败: %v", err)
    return
}

// 检查函数注册错误
err = functions.RegisterCustomFunction(...)
if err != nil {
    log.Printf("函数注册失败: %v", err)
    return
}
```

### 资源管理

```go
// 确保资源释放
ssql := streamsql.New()
defer ssql.Stop()

// 函数注册和注销
err := functions.RegisterCustomFunction(...)
if err == nil {
    defer functions.Unregister("function_name")
}
```

### 并发安全

```go
// StreamSQL实例是并发安全的
var ssql = streamsql.New()

go func() {
    for {
        ssql.Emit(generateData())
        time.Sleep(100 * time.Millisecond)
    }
}()

go func() {
    for {
        ssql..Emit(generateData())
        time.Sleep(200 * time.Millisecond)
    }
}()
```

## 性能配置

### 生产环境配置

```go
// 生产环境推荐配置
ssql := streamsql.New(
    streamsql.WithDiscardLog(),  // 禁用日志提升性能
)
```

### 开发环境配置

```go
// 开发环境调试配置
ssql := streamsql.New(
    streamsql.WithLogLevel(logger.DEBUG),
)
```

## 版本兼容性

### API稳定性

- ✅ **稳定API**：核心StreamSQL类、基础配置选项
- ⚠️ **实验性API**：部分高级功能可能在未来版本中变更
- ❌ **内部API**：以`internal`包开头的API不保证兼容性

### 升级指南

查看[CHANGELOG.md](https://github.com/rulego/streamsql/blob/main/CHANGELOG.md)了解版本变更详情。

## 下一步

- 📖 [最佳实践](/pages/streamsql-best-practices/) - 生产环境使用建议
- 💡 [示例集合](/pages/streamsql-examples/) - 更多实际应用案例
- 🔧 [自定义函数](/pages/streamsql-custom-functions/) - 深入了解函数开发
- 🏠 [返回首页](/pages/streamsql-overview/) - 回到文档首页
