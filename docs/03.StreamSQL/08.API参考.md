---
title: APIå‚è€?
date: 2024-01-15 10:08:00
permalink: /pages/streamsql/08/
article: false
author: 
  name: StreamSQL
  link: https://github.com/rulego/streamsql
---

# APIå‚è€?

æœ¬ç« æä¾›äº†StreamSQLçš„å®Œæ•´APIå‚è€ƒæ–‡æ¡£ï¼ŒåŒ…æ‹¬æ ¸å¿ƒæ¥å£ã€é…ç½®é€‰é¡¹ã€å‡½æ•°åº“ç­‰è¯¦ç»†ä¿¡æ¯ã€?

## æ ¸å¿ƒAPI

### StreamSQL ä¸»ç±»

#### æ„é€ å‡½æ•?

```go
func New(options ...Option) *StreamSQL
```

åˆ›å»ºæ–°çš„StreamSQLå®ä¾‹ã€?

**å‚æ•°ï¼?*
- `options` - å¯é€‰é…ç½®é¡¹

**è¿”å›å€¼ï¼š**
- `*StreamSQL` - StreamSQLå®ä¾‹

**ç¤ºä¾‹ï¼?*
```go
// é»˜è®¤é…ç½®
ssql := streamsql.New()

// è‡ªå®šä¹‰é…ç½?
ssql := streamsql.New(
    streamsql.WithLogLevel(logger.DEBUG),
    streamsql.WithDiscardLog(),
)
```

#### Execute

```go
func (s *StreamSQL) Execute(sql string) error
```

æ‰§è¡ŒSQLæŸ¥è¯¢ï¼Œå¯åŠ¨æµå¤„ç†ã€?

**å‚æ•°ï¼?*
- `sql` - SQLæŸ¥è¯¢è¯­å¥

**è¿”å›å€¼ï¼š**
- `error` - æ‰§è¡Œé”™è¯¯ï¼ŒæˆåŠŸæ—¶ä¸ºnil

**ç¤ºä¾‹ï¼?*
```go
sql := "SELECT deviceId, AVG(temperature) FROM stream GROUP BY deviceId, TumblingWindow('5m')"
err := ssql.Execute(sql)
if err != nil {
    log.Fatal(err)
}
```

#### AddData

```go
func (s *StreamSQL) AddData(data interface{})
```

å‘æ•°æ®æµæ·»åŠ æ•°æ®ã€?

**å‚æ•°ï¼?*
- `data` - æ•°æ®è®°å½•ï¼Œé€šå¸¸ä¸º`map[string]interface{}`

**ç¤ºä¾‹ï¼?*
```go
data := map[string]interface{}{
    "deviceId": "sensor001",
    "temperature": 25.5,
    "timestamp": time.Now(),
}
ssql.AddData(data)
```

#### Stream

```go
func (s *StreamSQL) Stream() *stream.Stream
```

è·å–åº•å±‚æµå¤„ç†å®ä¾‹ã€?

**è¿”å›å€¼ï¼š**
- `*stream.Stream` - æµå¤„ç†å®ä¾?

**ç¤ºä¾‹ï¼?*
```go
stream := ssql.Stream()
stream.AddSink(func(result interface{}) {
    fmt.Printf("ç»“æœ: %v\n", result)
})
```

#### Stop

```go
func (s *StreamSQL) Stop()
```

åœæ­¢æµå¤„ç†å¹¶æ¸…ç†èµ„æºã€?

**ç¤ºä¾‹ï¼?*
```go
defer ssql.Stop()
```

## é…ç½®é€‰é¡¹

### æ—¥å¿—é…ç½®

#### WithLogLevel

```go
func WithLogLevel(level logger.Level) Option
```

è®¾ç½®æ—¥å¿—çº§åˆ«ã€?

**å‚æ•°ï¼?*
- `level` - æ—¥å¿—çº§åˆ«ï¼ˆDEBUG, INFO, WARN, ERROR, OFFï¼?

**ç¤ºä¾‹ï¼?*
```go
ssql := streamsql.New(streamsql.WithLogLevel(logger.DEBUG))
```

#### WithLogOutput

```go
func WithLogOutput(writer io.Writer, level logger.Level) Option
```

è®¾ç½®æ—¥å¿—è¾“å‡ºç›®æ ‡å’Œçº§åˆ«ã€?

**å‚æ•°ï¼?*
- `writer` - è¾“å‡ºç›®æ ‡
- `level` - æ—¥å¿—çº§åˆ«

**ç¤ºä¾‹ï¼?*
```go
logFile, _ := os.OpenFile("app.log", os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0644)
ssql := streamsql.New(streamsql.WithLogOutput(logFile, logger.INFO))
```

#### WithDiscardLog

```go
func WithDiscardLog() Option
```

ç¦ç”¨æ—¥å¿—è¾“å‡ºï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰ã€?

**ç¤ºä¾‹ï¼?*
```go
ssql := streamsql.New(streamsql.WithDiscardLog())
```

#### WithLogger

```go
func WithLogger(logger logger.Logger) Option
```

ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—å™¨ã€?

**å‚æ•°ï¼?*
- `logger` - è‡ªå®šä¹‰æ—¥å¿—å™¨å®ä¾‹

**ç¤ºä¾‹ï¼?*
```go
customLogger := logger.New(os.Stdout, logger.INFO)
ssql := streamsql.New(streamsql.WithLogger(customLogger))
```

## æµå¤„ç†API

### Stream ç±?

#### AddSink

```go
func (s *Stream) AddSink(sink func(interface{}))
```

æ·»åŠ ç»“æœå¤„ç†å‡½æ•°ã€?

**å‚æ•°ï¼?*
- `sink` - ç»“æœå¤„ç†å›è°ƒå‡½æ•°

**ç¤ºä¾‹ï¼?*
```go
ssql.Stream().AddSink(func(result interface{}) {
    // å¤„ç†ç»“æœ
    fmt.Printf("å¤„ç†ç»“æœ: %v\n", result)
})
```

#### AddData

```go
func (s *Stream) AddData(data interface{})
```

å‘æµä¸­æ·»åŠ æ•°æ®ã€?

**å‚æ•°ï¼?*
- `data` - æ•°æ®è®°å½•

#### GetWindow

```go
func (s *Stream) GetWindow() window.Window
```

è·å–çª—å£å®ä¾‹ã€?

**è¿”å›å€¼ï¼š**
- `window.Window` - çª—å£æ¥å£

#### Stop

```go
func (s *Stream) Stop()
```

åœæ­¢æµå¤„ç†ã€?

## çª—å£API

### çª—å£ç±»å‹

#### TumblingWindow

```go
func NewTumblingWindow(size time.Duration, timeUnit time.Duration, tsProp string) *TumblingWindow
```

åˆ›å»ºæ»šåŠ¨çª—å£ã€?

**å‚æ•°ï¼?*
- `size` - çª—å£å¤§å°
- `timeUnit` - æ—¶é—´å•ä½
- `tsProp` - æ—¶é—´æˆ³å­—æ®µå

#### SlidingWindow

```go
func NewSlidingWindow(size, slide time.Duration, timeUnit time.Duration, tsProp string) *SlidingWindow
```

åˆ›å»ºæ»‘åŠ¨çª—å£ã€?

**å‚æ•°ï¼?*
- `size` - çª—å£å¤§å°
- `slide` - æ»‘åŠ¨é—´éš”
- `timeUnit` - æ—¶é—´å•ä½
- `tsProp` - æ—¶é—´æˆ³å­—æ®µå

#### CountingWindow

```go
func NewCountingWindow(count int) *CountingWindow
```

åˆ›å»ºè®¡æ•°çª—å£ã€?

**å‚æ•°ï¼?*
- `count` - è§¦å‘è®¡æ•°

#### SessionWindow

```go
func NewSessionWindow(timeout time.Duration, groupByKey string) *SessionWindow
```

åˆ›å»ºä¼šè¯çª—å£ã€?

**å‚æ•°ï¼?*
- `timeout` - ä¼šè¯è¶…æ—¶æ—¶é—´
- `groupByKey` - åˆ†ç»„å­—æ®µ

### çª—å£æ¥å£

#### Window æ¥å£

```go
type Window interface {
    Add(data interface{})
    Trigger() []types.WindowResult
    GetType() WindowType
    Stop()
}
```

**æ–¹æ³•è¯´æ˜ï¼?*

##### Add

```go
Add(data interface{})
```

å‘çª—å£æ·»åŠ æ•°æ®ã€?

##### Trigger

```go
Trigger() []types.WindowResult
```

æ‰‹åŠ¨è§¦å‘çª—å£è®¡ç®—ã€?

**è¿”å›å€¼ï¼š**
- `[]types.WindowResult` - çª—å£ç»“æœåˆ—è¡¨

##### GetType

```go
GetType() WindowType
```

è·å–çª—å£ç±»å‹ã€?

**è¿”å›å€¼ï¼š**
- `WindowType` - çª—å£ç±»å‹æšä¸¾

##### Stop

```go
Stop()
```

åœæ­¢çª—å£å¤„ç†ã€?

## å‡½æ•°ç³»ç»ŸAPI

### å‡½æ•°æ³¨å†Œ

#### RegisterCustomFunction

```go
func RegisterCustomFunction(
    name string,
    funcType FunctionType,
    category string,
    description string,
    minArgs int,
    maxArgs int,
    handler FunctionHandler,
) error
```

æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°ã€?

**å‚æ•°ï¼?*
- `name` - å‡½æ•°å?
- `funcType` - å‡½æ•°ç±»å‹
- `category` - å‡½æ•°åˆ†ç±»
- `description` - å‡½æ•°æè¿°
- `minArgs` - æœ€å°å‚æ•°æ•°é‡?
- `maxArgs` - æœ€å¤§å‚æ•°æ•°é‡?
- `handler` - å‡½æ•°å¤„ç†å™?

**è¿”å›å€¼ï¼š**
- `error` - æ³¨å†Œé”™è¯¯

**ç¤ºä¾‹ï¼?*
```go
err := functions.RegisterCustomFunction(
    "my_function",
    functions.TypeMath,
    "æ•°å­¦è®¡ç®—",
    "è‡ªå®šä¹‰æ•°å­¦å‡½æ•?,
    2, 2,
    func(ctx *functions.FunctionContext, args []interface{}) (interface{}, error) {
        // å‡½æ•°å®ç°
        return result, nil
    },
)
```

#### Unregister

```go
func Unregister(name string)
```

æ³¨é”€å‡½æ•°ã€?

**å‚æ•°ï¼?*
- `name` - å‡½æ•°å?

**ç¤ºä¾‹ï¼?*
```go
functions.Unregister("my_function")
```

#### Exists

```go
func Exists(name string) bool
```

æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨ã€?

**å‚æ•°ï¼?*
- `name` - å‡½æ•°å?

**è¿”å›å€¼ï¼š**
- `bool` - æ˜¯å¦å­˜åœ¨

#### Get

```go
func Get(name string) (Function, bool)
```

è·å–å‡½æ•°å®ä¾‹ã€?

**å‚æ•°ï¼?*
- `name` - å‡½æ•°å?

**è¿”å›å€¼ï¼š**
- `Function` - å‡½æ•°å®ä¾‹
- `bool` - æ˜¯å¦å­˜åœ¨

#### ListCustomFunctions

```go
func ListCustomFunctions() map[string]Function
```

åˆ—å‡ºæ‰€æœ‰è‡ªå®šä¹‰å‡½æ•°ã€?

**è¿”å›å€¼ï¼š**
- `map[string]Function` - å‡½æ•°ååˆ°å‡½æ•°å®ä¾‹çš„æ˜ å°?

### å‡½æ•°ç±»å‹

```go
type FunctionType string

const (
    TypeMath        FunctionType = "math"
    TypeString      FunctionType = "string"
    TypeConversion  FunctionType = "conversion"
    TypeDateTime    FunctionType = "datetime"
    TypeAggregation FunctionType = "aggregation"
    TypeAnalytical  FunctionType = "analytical"
    TypeWindow      FunctionType = "window"
    TypeCustom      FunctionType = "custom"
)
```

### å‡½æ•°å¤„ç†å™?

```go
type FunctionHandler func(ctx *FunctionContext, args []interface{}) (interface{}, error)
```

#### FunctionContext

```go
type FunctionContext struct {
    CurrentRow   map[string]interface{}
    WindowInfo   *WindowInfo
    CustomData   map[string]interface{}
}
```

**å­—æ®µè¯´æ˜ï¼?*
- `CurrentRow` - å½“å‰å¤„ç†çš„æ•°æ®è¡Œ
- `WindowInfo` - çª—å£ä¿¡æ¯
- `CustomData` - è‡ªå®šä¹‰æ•°æ?

#### WindowInfo

```go
type WindowInfo struct {
    StartTime time.Time
    EndTime   time.Time
    Size      time.Duration
    Type      string
}
```

### å·¥å…·å‡½æ•°

#### ConvertToFloat64

```go
func ConvertToFloat64(value interface{}) (float64, error)
```

è½¬æ¢å€¼ä¸ºfloat64ç±»å‹ã€?

#### ConvertToInt

```go
func ConvertToInt(value interface{}) (int, error)
```

è½¬æ¢å€¼ä¸ºintç±»å‹ã€?

#### ConvertToString

```go
func ConvertToString(value interface{}) (string, error)
```

è½¬æ¢å€¼ä¸ºstringç±»å‹ã€?

#### ConvertToTime

```go
func ConvertToTime(value interface{}) (time.Time, error)
```

è½¬æ¢å€¼ä¸ºtime.Timeç±»å‹ã€?

#### ConvertToFloat64Array

```go
func ConvertToFloat64Array(value interface{}) ([]float64, error)
```

è½¬æ¢å€¼ä¸ºfloat64æ•°ç»„ã€?

## èšåˆå™¨API

### èšåˆç±»å‹

```go
type AggregateType string

const (
    AggregateSum        AggregateType = "sum"
    AggregateAvg        AggregateType = "avg"
    AggregateMin        AggregateType = "min"
    AggregateMax        AggregateType = "max"
    AggregateCount      AggregateType = "count"
    AggregateStddev     AggregateType = "stddev"
    AggregateMedian     AggregateType = "median"
    AggregatePercentile AggregateType = "percentile"
    // ... å…¶ä»–èšåˆç±»å‹
)
```

### Aggregator æ¥å£

```go
type Aggregator interface {
    Add(value interface{}) error
    GetResult() interface{}
    Reset()
    GetType() AggregateType
}
```

## è¡¨è¾¾å¼API

### Expression æ¥å£

```go
type Expression interface {
    Evaluate(data map[string]interface{}) (interface{}, error)
    GetFields() []string
}
```

#### NewExpression

```go
func NewExpression(expr string) (Expression, error)
```

åˆ›å»ºè¡¨è¾¾å¼å®ä¾‹ã€?

**å‚æ•°ï¼?*
- `expr` - è¡¨è¾¾å¼å­—ç¬¦ä¸²

**è¿”å›å€¼ï¼š**
- `Expression` - è¡¨è¾¾å¼å®ä¾?
- `error` - åˆ›å»ºé”™è¯¯

## æ—¥å¿—API

### Logger æ¥å£

```go
type Logger interface {
    Debug(format string, args ...interface{})
    Info(format string, args ...interface{})
    Warn(format string, args ...interface{})
    Error(format string, args ...interface{})
    SetLevel(level Level)
    SetOutput(writer io.Writer)
}
```

### æ—¥å¿—çº§åˆ«

```go
type Level int

const (
    DEBUG Level = iota
    INFO
    WARN
    ERROR
    OFF
)
```

### åˆ›å»ºæ—¥å¿—å™?

#### New

```go
func New(output io.Writer, level Level) Logger
```

åˆ›å»ºæ–°çš„æ—¥å¿—å™¨ã€?

#### NewDiscard

```go
func NewDiscard() Logger
```

åˆ›å»ºä¸¢å¼ƒæ—¥å¿—å™¨ã€?

## ç±»å‹å®šä¹‰

### Config

```go
type Config struct {
    WindowConfig     WindowConfig
    GroupFields      []string
    SelectFields     map[string]aggregator.AggregateType
    FieldAlias       map[string]string
    Distinct         bool
    Limit            int
    NeedWindow       bool
    SimpleFields     []string
    Having           string
    FieldExpressions map[string]FieldExpression
}
```

### WindowConfig

```go
type WindowConfig struct {
    Type       window.WindowType
    Params     map[string]interface{}
    TsProp     string
    TimeUnit   time.Duration
    GroupByKey string
}
```

### FieldExpression

```go
type FieldExpression struct {
    Field      string
    Expression string
    Fields     []string
}
```

### WindowResult

```go
type WindowResult struct {
    GroupKey  string
    Results   []map[string]interface{}
    StartTime time.Time
    EndTime   time.Time
}
```

## é”™è¯¯ç±»å‹

### å¸¸è§é”™è¯¯

```go
var (
    ErrInvalidSQL           = errors.New("æ— æ•ˆçš„SQLè¯­å¥")
    ErrUnsupportedOperation = errors.New("ä¸æ”¯æŒçš„æ“ä½œ")
    ErrInvalidParameter     = errors.New("æ— æ•ˆçš„å‚æ•?)
    ErrFunctionNotFound     = errors.New("å‡½æ•°æœªæ‰¾åˆ?)
    ErrTypeConversion       = errors.New("ç±»å‹è½¬æ¢å¤±è´¥")
    ErrWindowNotInitialized = errors.New("çª—å£æœªåˆå§‹åŒ–")
)
```

## ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´ç¤ºä¾‹

```go
package main

import (
    "fmt"
    "log"
    "time"
    "github.com/rulego/streamsql"
    "github.com/rulego/streamsql/functions"
    "github.com/rulego/streamsql/logger"
)

func main() {
    // 1. åˆ›å»ºStreamSQLå®ä¾‹
    ssql := streamsql.New(
        streamsql.WithLogLevel(logger.INFO),
    )
    defer ssql.Stop()
    
    // 2. æ³¨å†Œè‡ªå®šä¹‰å‡½æ•?
    err := functions.RegisterCustomFunction(
        "celsius_to_fahrenheit",
        functions.TypeConversion,
        "æ¸©åº¦è½¬æ¢",
        "æ‘„æ°åº¦è½¬åæ°åº?,
        1, 1,
        func(ctx *functions.FunctionContext, args []interface{}) (interface{}, error) {
            celsius, err := functions.ConvertToFloat64(args[0])
            if err != nil {
                return nil, err
            }
            fahrenheit := celsius*9/5 + 32
            return fahrenheit, nil
        },
    )
    if err != nil {
        log.Fatal(err)
    }
    defer functions.Unregister("celsius_to_fahrenheit")
    
    // 3. æ‰§è¡ŒSQLæŸ¥è¯¢
    sql := `SELECT deviceId,
                   AVG(temperature) as avg_celsius,
                   AVG(celsius_to_fahrenheit(temperature)) as avg_fahrenheit,
                   COUNT(*) as sample_count,
                   window_start() as window_start
            FROM stream
            WHERE temperature > 0
            GROUP BY deviceId, TumblingWindow('1m')`
    
    err = ssql.Execute(sql)
    if err != nil {
        log.Fatal(err)
    }
    
    // 4. æ·»åŠ ç»“æœå¤„ç†
    ssql.Stream().AddSink(func(result interface{}) {
        fmt.Printf("èšåˆç»“æœ: %v\n", result)
    })
    
    // 5. å‘é€æ•°æ?
    devices := []string{"sensor001", "sensor002", "sensor003"}
    go func() {
        for i := 0; i < 100; i++ {
            for _, device := range devices {
                data := map[string]interface{}{
                    "deviceId":    device,
                    "temperature": 20.0 + rand.Float64()*15,
                    "timestamp":   time.Now(),
                }
                ssql.AddData(data)
            }
            time.Sleep(5 * time.Second)
        }
    }()
    
    // 6. ç­‰å¾…ç»“æœ
    time.Sleep(5 * time.Minute)
}
```

## æœ€ä½³å®è·?

### é”™è¯¯å¤„ç†

```go
// æ£€æŸ¥SQLæ‰§è¡Œé”™è¯¯
err := ssql.Execute(sql)
if err != nil {
    log.Printf("SQLæ‰§è¡Œå¤±è´¥: %v", err)
    return
}

// æ£€æŸ¥å‡½æ•°æ³¨å†Œé”™è¯?
err = functions.RegisterCustomFunction(...)
if err != nil {
    log.Printf("å‡½æ•°æ³¨å†Œå¤±è´¥: %v", err)
    return
}
```

### èµ„æºç®¡ç†

```go
// ç¡®ä¿èµ„æºé‡Šæ”¾
ssql := streamsql.New()
defer ssql.Stop()

// å‡½æ•°æ³¨å†Œå’Œæ³¨é”€
err := functions.RegisterCustomFunction(...)
if err == nil {
    defer functions.Unregister("function_name")
}
```

### å¹¶å‘å®‰å…¨

```go
// StreamSQLå®ä¾‹æ˜¯å¹¶å‘å®‰å…¨çš„
var ssql = streamsql.New()

go func() {
    for {
        ssql.AddData(generateData())
        time.Sleep(100 * time.Millisecond)
    }
}()

go func() {
    for {
        ssql.AddData(generateData())
        time.Sleep(200 * time.Millisecond)
    }
}()
```

## æ€§èƒ½é…ç½®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```go
// ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
ssql := streamsql.New(
    streamsql.WithDiscardLog(),  // ç¦ç”¨æ—¥å¿—æå‡æ€§èƒ½
)
```

### å¼€å‘ç¯å¢ƒé…ç½?

```go
// å¼€å‘ç¯å¢ƒè°ƒè¯•é…ç½?
ssql := streamsql.New(
    streamsql.WithLogLevel(logger.DEBUG),
)
```

## ç‰ˆæœ¬å…¼å®¹æ€?

### APIç¨³å®šæ€?

- âœ?**ç¨³å®šAPI**ï¼šæ ¸å¿ƒStreamSQLç±»ã€åŸºç¡€é…ç½®é€‰é¡¹
- âš ï¸ **å®éªŒæ€§API**ï¼šéƒ¨åˆ†é«˜çº§åŠŸèƒ½å¯èƒ½åœ¨æœªæ¥ç‰ˆæœ¬ä¸­å˜åŒ?
- â?**å†…éƒ¨API**ï¼šä»¥`internal`åŒ…å¼€å¤´çš„APIä¸ä¿è¯å…¼å®¹æ€?

### å‡çº§æŒ‡å—

æŸ¥çœ‹[CHANGELOG.md](https://github.com/rulego/streamsql/blob/main/CHANGELOG.md)äº†è§£ç‰ˆæœ¬å˜æ›´è¯¦æƒ…ã€?

## ä¸‹ä¸€æ­?

- ğŸ“– [æœ€ä½³å®è·µ](../09.æœ€ä½³å®è·?) - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å»ºè®®
- ğŸ’¡ [ç¤ºä¾‹é›†åˆ](../07.ç¤ºä¾‹/) - æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹
- ğŸ”§ [è‡ªå®šä¹‰å‡½æ•°](../06.è‡ªå®šä¹‰å‡½æ•?) - æ·±å…¥äº†è§£å‡½æ•°å¼€å?
- ğŸ  [è¿”å›é¦–é¡µ](../) - å›åˆ°æ–‡æ¡£é¦–é¡µ
