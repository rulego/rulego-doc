---
title: å¿«é€Ÿå¼€å§‹
date: 2024-01-15 10:02:00
permalink: /pages/streamsql/02/
article: false
author: 
  name: StreamSQL
  link: https://github.com/rulego/streamsql
---

# å¿«é€Ÿå¼€å§‹

æœ¬æŒ‡å—å°†åœ¨5åˆ†é’Ÿå†…å¸¦æ‚¨ä½“éªŒStreamSQLçš„åŸºæœ¬åŠŸèƒ½ï¼Œä»å®‰è£…åˆ°è¿è¡Œç¬¬ä¸€ä¸ªæµå¤„ç†ç¨‹åºã€‚

## ç¯å¢ƒè¦æ±‚

* Go 1.18 æˆ–æ›´é«˜ç‰ˆæœ¬

* åŸºæœ¬çš„Goè¯­è¨€å¼€å‘ç»éªŒ

* äº†è§£SQLåŸºç¡€è¯­æ³•ï¼ˆå¯é€‰ï¼Œä½†æœ‰åŠ©äºç†è§£ï¼‰

## å®‰è£…

### 1. åˆ›å»ºæ–°é¡¹ç›®

```bash
mkdir my-streamsql-app
cd my-streamsql-app
go mod init my-streamsql-app
```

### 2. æ·»åŠ ä¾èµ–

```bash
go get github.com/rulego/streamsql
```

### 3. éªŒè¯å®‰è£…

åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶éªŒè¯å®‰è£…ï¼š

```go
package main

import (
    "fmt"
    "github.com/rulego/streamsql"
)

func main() {
    ssql := streamsql.New()
    fmt.Println("StreamSQL å®‰è£…æˆåŠŸï¼")
    ssql.Stop()
}
```

## æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ

åœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œäº†è§£å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

* **æµï¼ˆStreamï¼‰**ï¼šè¿ç»­çš„æ•°æ®åºåˆ—ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„è¡¨

* **çª—å£ï¼ˆWindowï¼‰**ï¼šå°†æ— ç•Œæµåˆ†å‰²æˆæœ‰ç•Œæ•°æ®é›†çš„æœºåˆ¶

* **èšåˆï¼ˆAggregationï¼‰**ï¼šå¯¹çª—å£å†…æ•°æ®è¿›è¡Œç»Ÿè®¡è®¡ç®—

* **Sink**ï¼šå¤„ç†æŸ¥è¯¢ç»“æœçš„å›è°ƒå‡½æ•°

## ç¬¬ä¸€ä¸ªStreamSQLç¨‹åº

### 1. åŸºç¡€ç¤ºä¾‹ - ç®€å•æ•°æ®è¿‡æ»¤

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºå¦‚ä½•è¿‡æ»¤å®æ—¶æ•°æ®æµï¼š

åˆ›å»º `main.go` æ–‡ä»¶ï¼š

```go
package main

import (
    "fmt"
    "time"
    "github.com/rulego/streamsql"
)

func main() {
    // 1. åˆ›å»ºStreamSQLå®ä¾‹
    ssql := streamsql.New()
    defer ssql.Stop()
    
    // 2. å®šä¹‰SQLæŸ¥è¯¢ - è¿‡æ»¤æ¸©åº¦å¤§äº25åº¦çš„æ•°æ®
    sql := "SELECT deviceId, temperature FROM stream WHERE temperature > 25"
    
    // 3. æ‰§è¡ŒSQLæŸ¥è¯¢
    err := ssql.Execute(sql)
    if err != nil {
        panic(err)
    }
    
    // 4. æ·»åŠ ç»“æœå¤„ç†å‡½æ•°
    ssql.Stream().AddSink(func(result interface{}) {
        fmt.Printf("é«˜æ¸©å‘Šè­¦: %v\n", result)
    })
    
    // 5. å‘é€æµ‹è¯•æ•°æ®
    testData := []map[string]interface{}{
        {"deviceId": "sensor001", "temperature": 23.5}, // ä¸ä¼šè§¦å‘å‘Šè­¦
        {"deviceId": "sensor002", "temperature": 28.3}, // ä¼šè§¦å‘å‘Šè­¦
        {"deviceId": "sensor003", "temperature": 31.2}, // ä¼šè§¦å‘å‘Šè­¦
    }
    
    for _, data := range testData {
        ssql.AddData(data)
        time.Sleep(100 * time.Millisecond)
    }
    
    // ç­‰å¾…å¤„ç†å®Œæˆ
    time.Sleep(1 * time.Second)
}
```

è¿è¡Œç¨‹åºï¼š

```bash
go run main.go
```

æœŸæœ›è¾“å‡ºï¼š

```
é«˜æ¸©å‘Šè­¦: [map[deviceId:sensor002 temperature:28.3]]
é«˜æ¸©å‘Šè­¦: [map[deviceId:sensor003 temperature:31.2]]
```

**ä»£ç è§£æï¼š**

1. `streamsql.New()` - åˆ›å»ºStreamSQLå®ä¾‹
2. `Execute(sql)` - è§£æå¹¶æ‰§è¡ŒSQLæŸ¥è¯¢
3. `AddSink()` - æ³¨å†Œç»“æœå¤„ç†å‡½æ•°
4. `AddData()` - å‘æµä¸­æ·»åŠ æ•°æ®
5. `WHERE temperature > 25` - è¿‡æ»¤æ¡ä»¶ï¼Œåªå¤„ç†æ¸©åº¦å¤§äº25åº¦çš„æ•°æ®

### 2. èšåˆåˆ†æç¤ºä¾‹ - è®¡ç®—å¹³å‡æ¸©åº¦

```go
package main

import (
    "fmt"
    "math/rand"
    "time"
    "github.com/rulego/streamsql"
)

func main() {
    ssql := streamsql.New()
    defer ssql.Stop()
    
    // æ¯5ç§’è®¡ç®—ä¸€æ¬¡å„è®¾å¤‡çš„å¹³å‡æ¸©åº¦
    sql := `SELECT deviceId, 
                   AVG(temperature) as avg_temp,
                   COUNT(*) as sample_count,
                   window_start() as window_start,
                   window_end() as window_end
            FROM stream 
            GROUP BY deviceId, TumblingWindow('5s')`
    
    err := ssql.Execute(sql)
    if err != nil {
        panic(err)
    }
    
    // å¤„ç†èšåˆç»“æœ
    ssql.Stream().AddSink(func(result interface{}) {
        fmt.Printf("èšåˆç»“æœ: %v\n", result)
    })
    
    // æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®æµ
    go func() {
        devices := []string{"sensor001", "sensor002", "sensor003"}
        for i := 0; i < 20; i++ {
            for _, device := range devices {
                data := map[string]interface{}{
                    "deviceId":    device,
                    "temperature": 20.0 + rand.Float64()*15, // 20-35åº¦éšæœºæ¸©åº¦
                    "timestamp":   time.Now(),
                }
                ssql.AddData(data)
            }
            time.Sleep(1 * time.Second)
        }
    }()
    
    // è¿è¡Œ10ç§’
    time.Sleep(10 * time.Second)
}
```

## è¿›é˜¶ç¤ºä¾‹

### 3. æ»‘åŠ¨çª—å£åˆ†æ

```go
package main

import (
    "fmt"
    "math/rand"
    "time"
    "github.com/rulego/streamsql"
)

func main() {
    ssql := streamsql.New()
    defer ssql.Stop()
    
    // 30ç§’æ»‘åŠ¨çª—å£ï¼Œæ¯10ç§’æ»‘åŠ¨ä¸€æ¬¡
    sql := `SELECT deviceId,
                   AVG(temperature) as avg_temp,
                   MAX(temperature) as max_temp,
                   MIN(temperature) as min_temp
            FROM stream 
            WHERE temperature > 0
            GROUP BY deviceId, SlidingWindow('30s', '10s')`
    
    err := ssql.Execute(sql)
    if err != nil {
        panic(err)
    }
    
    ssql.Stream().AddSink(func(result interface{}) {
        fmt.Printf("æ»‘åŠ¨çª—å£åˆ†æ: %v\n", result)
    })
    
    // æŒç»­å‘é€æ•°æ®
    go func() {
        for i := 0; i < 50; i++ {
            data := map[string]interface{}{
                "deviceId":    "sensor001",
                "temperature": 20.0 + rand.Float64()*10,
            }
            ssql.AddData(data)
            time.Sleep(2 * time.Second)
        }
    }()
    
    time.Sleep(2 * time.Minute)
}
```

### 4. åµŒå¥—å­—æ®µè®¿é—®ç¤ºä¾‹

```go
package main

import (
    "fmt"
    "time"
    "github.com/rulego/streamsql"
)

func main() {
    ssql := streamsql.New()
    defer ssql.Stop()
    
    // è®¿é—®åµŒå¥—å­—æ®µçš„SQLæŸ¥è¯¢
    sql := `SELECT device.info.name as device_name,
                   device.location.building as building,
                   sensor.temperature as temp,
                   UPPER(device.info.type) as device_type
            FROM stream 
            WHERE sensor.temperature > 25 AND device.info.status = 'active'`
    
    err := ssql.Execute(sql)
    if err != nil {
        panic(err)
    }
    
    ssql.Stream().AddSink(func(result interface{}) {
        fmt.Printf("åµŒå¥—å­—æ®µç»“æœ: %v\n", result)
    })
    
    // å‘é€åµŒå¥—ç»“æ„æ•°æ®
    complexData := map[string]interface{}{
        "device": map[string]interface{}{
            "info": map[string]interface{}{
                "name":   "æ¸©åº¦ä¼ æ„Ÿå™¨001",
                "type":   "temperature",
                "status": "active",
            },
            "location": map[string]interface{}{
                "building": "Aæ ‹",
                "floor":    "3F",
            },
        },
        "sensor": map[string]interface{}{
            "temperature": 28.5,
            "humidity":    65.0,
        },
    }
    
    ssql.AddData(complexData)
    time.Sleep(500 * time.Millisecond)
}
```

### 5. æ€§èƒ½æ¨¡å¼ç¤ºä¾‹

StreamSQLæä¾›å¤šç§æ€§èƒ½æ¨¡å¼ä»¥é€‚åº”ä¸åŒåœºæ™¯ï¼š

```go
package main

import (
    "fmt"
    "time"
    "github.com/rulego/streamsql"
)

func main() {
    // é«˜æ€§èƒ½æ¨¡å¼ - é€‚åˆé«˜ååé‡åœºæ™¯
    ssqlHighPerf := streamsql.New(streamsql.WithHighPerformance())
    defer ssqlHighPerf.Stop()
    
    // ä½å»¶è¿Ÿæ¨¡å¼ - é€‚åˆå®æ—¶å“åº”åœºæ™¯
    ssqlLowLatency := streamsql.New(streamsql.WithLowLatency())
    defer ssqlLowLatency.Stop()
    
    // é›¶æ•°æ®ä¸¢å¤±æ¨¡å¼ - é€‚åˆå…³é”®æ•°æ®åœºæ™¯
    ssqlZeroLoss := streamsql.New(streamsql.WithZeroDataLoss())
    defer ssqlZeroLoss.Stop()
    
    sql := "SELECT deviceId, AVG(temperature) FROM stream GROUP BY deviceId, TumblingWindow('5s')"
    
    // ä¸ºæ¯ä¸ªå®ä¾‹æ‰§è¡Œç›¸åŒçš„SQL
    ssqlHighPerf.Execute(sql)
    ssqlLowLatency.Execute(sql)
    ssqlZeroLoss.Execute(sql)
    
    fmt.Println("ä¸åŒæ€§èƒ½æ¨¡å¼å·²å¯åŠ¨")
}
```

## å¸¸è§é—®é¢˜è§£ç­”

### Q: å¦‚ä½•å¤„ç†æ•°æ®æ ¼å¼é”™è¯¯ï¼Ÿ

```go
ssql.Stream().AddSink(func(result interface{}) {
    if result == nil {
        fmt.Println("æ”¶åˆ°ç©ºç»“æœï¼Œå¯èƒ½æ˜¯æ•°æ®æ ¼å¼é”™è¯¯")
        return
    }
    fmt.Printf("æ­£å¸¸ç»“æœ: %v\n", result)
})
```

### Q: å¦‚ä½•åœæ­¢æµå¤„ç†ï¼Ÿ

```go
// æ–¹æ³•1: ä½¿ç”¨deferç¡®ä¿èµ„æºæ¸…ç†
defer ssql.Stop()

// æ–¹æ³•2: æ‰‹åŠ¨åœæ­¢
ssql.Stop()
```

### Q: å¦‚ä½•å¤„ç†å¤§é‡æ•°æ®ï¼Ÿ

```go
// ä½¿ç”¨é«˜æ€§èƒ½æ¨¡å¼
ssql := streamsql.New(streamsql.WithHighPerformance())

// æ‰¹é‡å‘é€æ•°æ®
for i := 0; i < 10000; i++ {
    data := map[string]interface{}{
        "id": i,
        "value": rand.Float64() * 100,
    }
    ssql.AddData(data)
    
    // é¿å…è¿‡å¿«å‘é€å¯¼è‡´å†…å­˜å‹åŠ›
    if i%1000 == 0 {
        time.Sleep(10 * time.Millisecond)
    }
}
```

## ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆå¿«é€Ÿå¼€å§‹åï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºæ·±å…¥å­¦ä¹ ï¼š

1. **[æ ¸å¿ƒæ¦‚å¿µ](../03.æ ¸å¿ƒæ¦‚å¿µ/)** - æ·±å…¥ç†è§£æµå¤„ç†åŸç†
2. **[çª—å£å‡½æ•°](../05.çª—å£å‡½æ•°/)** - æŒæ¡æ—¶é—´çª—å£çš„ä½¿ç”¨
3. **[SQLå‚è€ƒ](../04.SQLå‚è€ƒ/)** - å­¦ä¹ å®Œæ•´çš„SQLè¯­æ³•
4. **[ç¤ºä¾‹é›†åˆ](../07.ç¤ºä¾‹/)** - æŸ¥çœ‹æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹

## æ€§èƒ½æç¤º

* **é€‰æ‹©åˆé€‚çš„çª—å£å¤§å°**ï¼šè¿‡å°çš„çª—å£ä¼šå¢åŠ è®¡ç®—å¼€é”€ï¼Œè¿‡å¤§çš„çª—å£ä¼šå¢åŠ å†…å­˜ä½¿ç”¨

* **åˆç†ä½¿ç”¨è¿‡æ»¤æ¡ä»¶**ï¼šåœ¨WHEREå­å¥ä¸­å°½æ—©è¿‡æ»¤æ•°æ®å¯ä»¥æé«˜æ€§èƒ½

* **é¿å…å¤æ‚çš„åµŒå¥—æŸ¥è¯¢**ï¼šStreamSQLé’ˆå¯¹ç®€å•é«˜æ•ˆçš„æŸ¥è¯¢è¿›è¡Œäº†ä¼˜åŒ–

* **ç›‘æ§å†…å­˜ä½¿ç”¨**ï¼šåœ¨é«˜é¢‘æ•°æ®åœºæ™¯ä¸‹æ³¨æ„ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

***

**æ­å–œï¼** æ‚¨å·²ç»æŒæ¡äº†StreamSQLçš„åŸºç¡€ä½¿ç”¨æ–¹æ³•ã€‚ç°åœ¨å¯ä»¥å¼€å§‹æ„å»ºæ‚¨çš„å®æ—¶æ•°æ®å¤„ç†åº”ç”¨äº†ã€‚

````

## æ—¥å¿—é…ç½®

StreamSQLæ”¯æŒçµæ´»çš„æ—¥å¿—é…ç½®ï¼š

```go
package main

import (
    "os"
    "github.com/rulego/streamsql"
    "github.com/rulego/streamsql/logger"
)

func main() {
    // æ–¹æ³•1ï¼šè®¾ç½®æ—¥å¿—çº§åˆ«
    ssql := streamsql.New(
        streamsql.WithLogLevel(logger.DEBUG),
    )
    
    // æ–¹æ³•2ï¼šè¾“å‡ºåˆ°æ–‡ä»¶
    logFile, _ := os.OpenFile("streamsql.log", os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0644)
    ssql2 := streamsql.New(
        streamsql.WithLogOutput(logFile, logger.INFO),
    )
    
    // æ–¹æ³•3ï¼šç¦ç”¨æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
    ssql3 := streamsql.New(
        streamsql.WithDiscardLog(),
    )
    
    defer ssql.Stop()
    defer ssql2.Stop()
    defer ssql3.Stop()
    
    // ... å…¶ä»–ä»£ç 
}
````

## å¸¸è§é—®é¢˜

### Q: æ•°æ®æ²¡æœ‰è¾“å‡ºç»“æœï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. ç¡®ä¿è°ƒç”¨äº† `AddSink()` æ·»åŠ ç»“æœå¤„ç†å‡½æ•°
2. å¦‚æœä½¿ç”¨çª—å£å‡½æ•°ï¼Œç¡®ä¿çª—å£å·²è§¦å‘ï¼ˆæ—¶é—´å·²åˆ°æˆ–æ‰‹åŠ¨è§¦å‘ï¼‰
3. æ£€æŸ¥WHEREæ¡ä»¶æ˜¯å¦è¿‡æ»¤äº†æ‰€æœ‰æ•°æ®

### Q: çª—å£å‡½æ•°ä½•æ—¶è§¦å‘ï¼Ÿ

**A:**

* **æ»šåŠ¨çª—å£**ï¼šåˆ°è¾¾çª—å£ç»“æŸæ—¶é—´æ—¶è‡ªåŠ¨è§¦å‘

* **æ»‘åŠ¨çª—å£**ï¼šæ¯ä¸ªæ»‘åŠ¨é—´éš”è§¦å‘ä¸€æ¬¡

* **è®¡æ•°çª—å£**ï¼šç´¯ç§¯åˆ°æŒ‡å®šæ•°é‡æ—¶è§¦å‘

* **ä¼šè¯çª—å£**ï¼šä¼šè¯è¶…æ—¶åè§¦å‘

### Q: å¦‚ä½•å¤„ç†å¼‚å¸¸æ•°æ®ï¼Ÿ

**A:** ä½¿ç”¨WHEREå­å¥è¿‡æ»¤å¼‚å¸¸æ•°æ®ï¼š

```sql
SELECT * FROM stream 
WHERE temperature IS NOT NULL 
  AND temperature BETWEEN -50 AND 100
```

## ä¸‹ä¸€æ­¥

ç°åœ¨æ‚¨å·²ç»æŒæ¡äº†StreamSQLçš„åŸºæœ¬ç”¨æ³•ï¼Œå»ºè®®ç»§ç»­å­¦ä¹ ï¼š

* ğŸ“– [æ ¸å¿ƒæ¦‚å¿µ](../03.æ ¸å¿ƒæ¦‚å¿µ/) - æ·±å…¥ç†è§£æµå¤„ç†æ¦‚å¿µ

* ğŸªŸ [çª—å£å‡½æ•°](../05.çª—å£å‡½æ•°/) - æŒæ¡å„ç§çª—å£ç±»å‹

* ğŸ”§ [è‡ªå®šä¹‰å‡½æ•°](../06.è‡ªå®šä¹‰å‡½æ•°/) - æ‰©å±•å¤„ç†èƒ½åŠ›

* ğŸ’¡ [ç¤ºä¾‹é›†åˆ](../07.ç¤ºä¾‹/) - æ›´å¤šå®é™…åº”ç”¨æ¡ˆä¾‹

* ğŸ“š [SQLå‚è€ƒ](../04.SQLå‚è€ƒ/) - å®Œæ•´è¯­æ³•æ‰‹å†Œ

***

## å®Œæ•´ç¤ºä¾‹ä»£ç 

æ‰€æœ‰ç¤ºä¾‹ä»£ç éƒ½å¯ä»¥åœ¨é¡¹ç›®çš„ `examples/` ç›®å½•ä¸­æ‰¾åˆ°ï¼š

* `examples/simple-custom-functions/` - åŸºç¡€ç”¨æ³•ç¤ºä¾‹

* `examples/custom-functions-demo/` - å®Œæ•´åŠŸèƒ½æ¼”ç¤º

* `examples/function-integration-demo/` - é›†æˆä½¿ç”¨æ¡ˆä¾‹

* `examples/advanced-functions/` - é«˜çº§ç‰¹æ€§å±•ç¤º

