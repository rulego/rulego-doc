---

title: çª—å£å‡½æ•°
date: 2024-01-15 10:05:00
permalink: /pages/streamsql/05/
article: false
author:
    name: StreamSQL
    link: https://github.com/rulego/streamsql
---

# çª—å£å‡½æ•°

çª—å£å‡½æ•°æ˜¯æµå¤„ç†çš„æ ¸å¿ƒæ¦‚å¿µï¼Œç”¨äºå°†æ— ç•Œæ•°æ®æµåˆ†å‰²æˆæœ‰ç•Œçš„æ•°æ®é›†è¿›è¡Œèšåˆåˆ†æã€‚StreamSQLæä¾›äº†å››ç§çª—å£ç±»å‹ï¼Œæ»¡è¶³ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€æ±‚ï¿½?
## çª—å£åŸºç¡€æ¦‚å¿µ

### ä¸ºä»€ä¹ˆéœ€è¦çª—ï¿½?
åœ¨æµå¤„ç†ä¸­ï¼Œæ•°æ®æ˜¯è¿ç»­ä¸æ–­çš„ï¼Œæˆ‘ä»¬æ— æ³•ç­‰ï¿½?æ‰€æœ‰æ•°ï¿½?åˆ°è¾¾åå†è¿›è¡Œè®¡ç®—ã€‚çª—å£å‡½æ•°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¿½?
```mermaid
graph TB
    A[æ— ç•Œæ•°æ®æµ] --> B[çª—å£åˆ†å‰²]
    B --> C[æœ‰ç•Œæ•°æ®é›†]
    C --> D[èšåˆè®¡ç®—]
    D --> E[ç»“æœè¾“å‡º]
    
    subgraph "æ•°æ®ï¿½?
        F[æ•°æ®1] --> G[æ•°æ®2] --> H[æ•°æ®3] --> I[...]
    end
    
    subgraph "çª—å£å¤„ç†"
        J[çª—å£1: æ•°æ®1,2] --> K[çª—å£2: æ•°æ®3,4] --> L[çª—å£3: æ•°æ®5,6]
    end
```

### çª—å£çš„å…³é”®å±ï¿½?
| å±ï¿½?    | è¯´æ˜            | å½±å“      |
| ------ | ------------- | ------- |
| **å¤§å°** | çª—å£åŒ…å«çš„æ—¶é—´èŒƒå›´æˆ–æ•°æ®ï¿½?| åˆ†æç²¾åº¦å’Œå»¶ï¿½?|
| **è§¦å‘** | çª—å£ä½•æ—¶æ‰§è¡Œè®¡ç®—      | ç»“æœäº§ç”Ÿé¢‘ç‡  |
| **é‡å ** | çª—å£ä¹‹é—´æ˜¯å¦æœ‰æ•°æ®é‡ï¿½?  | è®¡ç®—å¤æ‚ï¿½?  |
| **å¯¹é½** | çª—å£è¾¹ç•Œçš„æ—¶é—´å¯¹é½æ–¹ï¿½?  | ç»“æœä¸€è‡´ï¿½?  |

## æ»šåŠ¨çª—å£ (TumblingWindow)

### ç‰¹ç‚¹

æ»šåŠ¨çª—å£ï¿½?*å›ºå®šå¤§å°ã€æ— é‡å **çš„æ—¶é—´çª—å£ï¼Œæ¯ä¸ªæ•°æ®ç‚¹åªå±äºä¸€ä¸ªçª—å£ï¿½?
```mermaid
gantt
    title æ»šåŠ¨çª—å£ç¤ºä¾‹ (5åˆ†é’Ÿçª—å£)
    dateFormat X
    axisFormat %H:%M
    
    section çª—å£1
    10:00-10:05    :done, w1, 0, 5
    section çª—å£2
    10:05-10:10    :done, w2, 5, 10
    section çª—å£3
    10:10-10:15    :active, w3, 10, 15
    section çª—å£4
    10:15-10:20    :w4, 15, 20
```

### è¯­æ³•

```sql
GROUP BY [field1, field2, ...], TumblingWindow('duration')
```

### å‚æ•°è¯´æ˜

| å‚æ•°         | ç±»å‹     | è¯´æ˜   | ç¤ºä¾‹                             |
| ---------- | ------ | ---- | ------------------------------ |
| `duration` | string | çª—å£å¤§å° | `'5s'`, `'1m'`, `'1h'`, `'1d'` |

### åŸºç¡€ç¤ºä¾‹

```sql
-- æ¯åˆ†é’Ÿè®¡ç®—è®¾å¤‡å¹³å‡æ¸©ï¿½?SELECT deviceId, 
       AVG(temperature) as avg_temp,
       COUNT(*) as sample_count,
       window_start() as start_time,
       window_end() as end_time
FROM stream
GROUP BY deviceId, TumblingWindow('1m')
```

### å®é™…åº”ç”¨

#### 1. è®¾å¤‡ç›‘æ§

```sql
-- ï¿½?åˆ†é’Ÿç›‘æ§è®¾å¤‡çŠ¶ï¿½?SELECT deviceId,
       COUNT(*) as total_events,
       SUM(CASE WHEN status = 'error' THEN 1 ELSE 0 END) as error_count,
       AVG(cpu_usage) as avg_cpu,
       MAX(memory_usage) as max_memory
FROM stream
WHERE deviceId IS NOT NULL
GROUP BY deviceId, TumblingWindow('5m')
HAVING error_count > 0  -- åªè¾“å‡ºæœ‰é”™è¯¯çš„è®¾ï¿½?```

#### 2. æµé‡ç»Ÿè®¡

```sql
-- æ¯å°æ—¶APIè°ƒç”¨ç»Ÿè®¡
SELECT api_endpoint,
       COUNT(*) as request_count,
       SUM(CASE WHEN status_code >= 400 THEN 1 ELSE 0 END) as error_count,
       AVG(response_time) as avg_response_time,
       PERCENTILE(response_time, 0.95) as p95_response_time
FROM stream
GROUP BY api_endpoint, TumblingWindow('1h')
```

#### 3. ä¸šåŠ¡æŒ‡æ ‡

```sql
-- æ¯æ—¥é”€å”®ç»Ÿï¿½?SELECT product_category,
       SUM(amount) as total_sales,
       COUNT(DISTINCT customer_id) as unique_customers,
       AVG(amount) as avg_order_value
FROM stream
GROUP BY product_category, TumblingWindow('1d')
```

### ä¼˜ç¼ºï¿½?
**ä¼˜ç‚¹ï¿½?*

* è®¡ç®—å¼€é”€ï¿½?
* æ¯ä¸ªæ•°æ®ç‚¹åªå¤„ç†ä¸€ï¿½?
* é€‚åˆå‘¨æœŸæ€§æŠ¥ï¿½?
**ç¼ºç‚¹ï¿½?*

* çª—å£è¾¹ç•Œå¯èƒ½åˆ‡æ–­ç›¸å…³äº‹ä»¶

* ç»“æœä¸å¤Ÿå¹³æ»‘

### é€‚ç”¨åœºæ™¯

* ï¿½?å‘¨æœŸæ€§æŠ¥å‘Šï¼ˆæ¯å°æ—¶ã€æ¯å¤©ï¼‰

* ï¿½?èµ„æºä½¿ç”¨ç›‘æ§

* ï¿½?ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡

* ï¿½?æ‰¹å¤„ç†é£æ ¼çš„åˆ†æ

## æ»‘åŠ¨çª—å£ (SlidingWindow)

### ç‰¹ç‚¹

æ»‘åŠ¨çª—å£ï¿½?*å›ºå®šå¤§å°ã€æœ‰é‡å **çš„æ—¶é—´çª—å£ï¼Œæ¯ä¸ªæ•°æ®ç‚¹å¯èƒ½å±äºå¤šä¸ªçª—å£ï¿½?
```mermaid
gantt
    title æ»‘åŠ¨çª—å£ç¤ºä¾‹ (5åˆ†é’Ÿçª—å£ï¿½?åˆ†é’Ÿæ»‘åŠ¨)
    dateFormat X
    axisFormat %H:%M
    
    section çª—å£1
    10:00-10:05    :done, w1, 0, 5
    section çª—å£2
    10:02-10:07    :done, w2, 2, 7
    section çª—å£3
    10:04-10:09    :active, w3, 4, 9
    section çª—å£4
    10:06-10:11    :w4, 6, 11
```

### è¯­æ³•

```sql
GROUP BY [field1, field2, ...], SlidingWindow('window_size', 'slide_interval')
```

### å‚æ•°è¯´æ˜

| å‚æ•°               | ç±»å‹     | è¯´æ˜   | ç¤ºä¾‹              |
| ---------------- | ------ | ---- | --------------- |
| `window_size`    | string | çª—å£å¤§å° | `'5m'`, `'1h'`  |
| `slide_interval` | string | æ»‘åŠ¨é—´éš” | `'1m'`, `'30s'` |

### åŸºç¡€ç¤ºä¾‹

```sql
-- 5åˆ†é’Ÿçª—å£ï¼Œæ¯åˆ†é’Ÿæ»‘åŠ¨ä¸€ï¿½?SELECT deviceId,
       AVG(temperature) as avg_temp,
       STDDEV(temperature) as temp_stddev,
       window_start() as start_time
FROM stream
GROUP BY deviceId, SlidingWindow('5m', '1m')
```

### å®é™…åº”ç”¨

#### 1. å®æ—¶å¼‚å¸¸æ£€ï¿½?
```sql
-- æ£€æµ‹æ¸©åº¦å¼‚å¸¸ï¼š5åˆ†é’Ÿçª—å£å†…çš„æ ‡å‡†å·®å¼‚ï¿½?SELECT deviceId,
       AVG(temperature) as current_avg,
       STDDEV(temperature) as current_stddev,
       CASE 
           WHEN STDDEV(temperature) > 5.0 THEN 'UNSTABLE'
           WHEN AVG(temperature) > 35.0 THEN 'OVERHEAT'
           ELSE 'NORMAL'
       END as device_status
FROM stream
WHERE temperature IS NOT NULL
GROUP BY deviceId, SlidingWindow('5m', '30s')
HAVING STDDEV(temperature) > 2.0 OR AVG(temperature) > 30.0
```

#### 2. æ€§èƒ½è¶‹åŠ¿åˆ†æ

```sql
-- ç³»ç»Ÿæ€§èƒ½è¶‹åŠ¿ï¿½?0åˆ†é’Ÿçª—å£ï¼Œæ¯2åˆ†é’Ÿæ›´æ–°
SELECT server_id,
       AVG(cpu_usage) as avg_cpu,
       AVG(memory_usage) as avg_memory,
       AVG(disk_io) as avg_disk_io,
       -- è®¡ç®—å˜åŒ–è¶‹åŠ¿
       CASE 
           WHEN AVG(cpu_usage) > LAG(AVG(cpu_usage)) THEN 'INCREASING'
           WHEN AVG(cpu_usage) < LAG(AVG(cpu_usage)) THEN 'DECREASING'
           ELSE 'STABLE'
       END as cpu_trend
FROM stream
GROUP BY server_id, SlidingWindow('10m', '2m')
```

#### 3. ç§»åŠ¨å¹³å‡åˆ†æ

```sql
-- è‚¡ä»·ç§»åŠ¨å¹³å‡ï¿½?0åˆ†é’Ÿçª—å£ï¼Œæ¯5åˆ†é’Ÿæ›´æ–°
SELECT symbol,
       AVG(price) as moving_avg_30m,
       MIN(price) as min_price_30m,
       MAX(price) as max_price_30m,
       COUNT(*) as trade_count,
       window_start() as window_start
FROM stream
WHERE price > 0
GROUP BY symbol, SlidingWindow('30m', '5m')
ORDER BY moving_avg_30m DESC
```

### é…ç½®å»ºè®®

#### çª—å£å¤§å°ä¸æ»‘åŠ¨é—´éš”çš„å…³ç³»

```sql
-- é«˜é¢‘æ›´æ–°ï¼ˆå»¶è¿Ÿä½ï¼Œå¼€é”€å¤§ï¼‰
SlidingWindow('5m', '30s')   -- ï¿½?0ç§’æ›´ï¿½?åˆ†é’Ÿæ•°æ®

-- ä¸­é¢‘æ›´æ–°ï¼ˆå¹³è¡¡ï¼‰
SlidingWindow('10m', '2m')   -- ï¿½?åˆ†é’Ÿæ›´æ–°10åˆ†é’Ÿæ•°æ®

-- ä½é¢‘æ›´æ–°ï¼ˆå»¶è¿Ÿé«˜ï¼Œå¼€é”€å°ï¼‰
SlidingWindow('1h', '10m')   -- ï¿½?0åˆ†é’Ÿæ›´æ–°1å°æ—¶æ•°æ®
```

### ä¼˜ç¼ºï¿½?
**ä¼˜ç‚¹ï¿½?*

* æä¾›å¹³æ»‘çš„åˆ†æç»“ï¿½?
* èƒ½å¤Ÿæ›´å¿«åœ°å“åº”æ•°æ®å˜ï¿½?
* é€‚åˆè¶‹åŠ¿åˆ†æ

**ç¼ºç‚¹ï¿½?*

* è®¡ç®—å¼€é”€è¾ƒå¤§

* åŒä¸€æ•°æ®è¢«å¤šæ¬¡å¤„ï¿½?
* å†…å­˜ä½¿ç”¨è¾ƒå¤š

### é€‚ç”¨åœºæ™¯

* ï¿½?å®æ—¶ç›‘æ§å’Œå‘Šï¿½?
* ï¿½?è¶‹åŠ¿åˆ†æ

* ï¿½?ç§»åŠ¨å¹³å‡è®¡ç®—

* ï¿½?å¼‚å¸¸æ£€ï¿½?
## è®¡æ•°çª—å£ (CountingWindow)

### ç‰¹ç‚¹

è®¡æ•°çª—å£åŸºäº**æ•°æ®æ¡æ•°**è€Œéæ—¶é—´ï¼Œå½“ç´¯ç§¯æ•°æ®è¾¾åˆ°æŒ‡å®šæ•°é‡æ—¶è§¦å‘è®¡ç®—ï¿½?
```mermaid
graph TB
    A[æ•°æ®æµ] --> B[è®¡æ•°å™¨]
    B --> C{è¾¾åˆ°é˜ˆï¿½?}
    C -->|æ˜¯| D[è§¦å‘çª—å£]
    C -->|å¦| E[ç»§ç»­ç´¯ç§¯]
    D --> F[æ‰§è¡Œèšåˆ]
    F --> G[è¾“å‡ºç»“æœ]
    G --> H[é‡ç½®è®¡æ•°å™¨]
    E --> B
    H --> B
```

### è¯­æ³•

```sql
GROUP BY [field1, field2, ...], CountingWindow(count)
```

### å‚æ•°è¯´æ˜

| å‚æ•°      | ç±»å‹      | è¯´æ˜   | ç¤ºä¾‹                    |
| ------- | ------- | ---- | --------------------- |
| `count` | integer | è§¦å‘é˜ˆï¿½?| `100`, `1000`, `5000` |

### åŸºç¡€ç¤ºä¾‹

```sql
-- ï¿½?00æ¡æ•°æ®è®¡ç®—ä¸€æ¬¡è®¾å¤‡å¹³å‡ï¿½?SELECT deviceId,
       AVG(temperature) as avg_temp,
       COUNT(*) as batch_size,
       MIN(timestamp) as batch_start,
       MAX(timestamp) as batch_end
FROM stream
GROUP BY deviceId, CountingWindow(100)
```

### å®é™…åº”ç”¨

#### 1. æ‰¹é‡æ•°æ®å¤„ç†

```sql
-- ï¿½?000æ¡æ•°æ®è¿›è¡Œä¸€æ¬¡æ•°æ®è´¨é‡æ£€ï¿½?SELECT data_source,
       COUNT(*) as total_records,
       SUM(CASE WHEN value IS NULL THEN 1 ELSE 0 END) as null_count,
       SUM(CASE WHEN value < 0 THEN 1 ELSE 0 END) as negative_count,
       AVG(value) as avg_value,
       STDDEV(value) as value_stddev
FROM stream
GROUP BY data_source, CountingWindow(1000)
HAVING null_count > 50 OR negative_count > 100  -- æ•°æ®è´¨é‡å‘Šè­¦
```

#### 2. é‡‡æ ·åˆ†æ

```sql
-- ï¿½?00æ¡æ¶ˆæ¯åˆ†æä¸€æ¬¡ç”¨æˆ·è¡Œä¸ºæ¨¡ï¿½?SELECT user_category,
       COUNT(DISTINCT user_id) as unique_users,
       AVG(session_duration) as avg_session_time,
       SUM(page_views) as total_page_views,
       COUNT(DISTINCT page_url) as unique_pages
FROM stream
WHERE session_duration > 0
GROUP BY user_category, CountingWindow(500)
```

#### 3. æ€§èƒ½åŸºå‡†æµ‹è¯•

```sql
-- ï¿½?0000ä¸ªè¯·æ±‚åˆ†æä¸€æ¬¡APIæ€§èƒ½
SELECT api_endpoint,
       COUNT(*) as request_count,
       AVG(response_time) as avg_response_time,
       PERCENTILE(response_time, 0.50) as median_response_time,
       PERCENTILE(response_time, 0.95) as p95_response_time,
       PERCENTILE(response_time, 0.99) as p99_response_time,
       MAX(response_time) as max_response_time
FROM stream
WHERE response_time > 0
GROUP BY api_endpoint, CountingWindow(10000)
```

### åŠ¨æ€é˜ˆï¿½?
```sql
-- æ ¹æ®æ•°æ®æºè°ƒæ•´è®¡æ•°é˜ˆï¿½?SELECT device_type,
       CASE device_type
           WHEN 'high_frequency' THEN 1000
           WHEN 'medium_frequency' THEN 500  
           WHEN 'low_frequency' THEN 100
           ELSE 200
       END as optimal_count
FROM stream
GROUP BY device_type, CountingWindow(200)  -- åŸºç¡€é˜ˆï¿½?```

### ä¼˜ç¼ºï¿½?
**ä¼˜ç‚¹ï¿½?*

* ä¿è¯å›ºå®šçš„æ•°æ®å¤„ç†é‡

* é€‚åˆæ•°æ®é‡‡æ ·åˆ†æ

* ä¸å—æ—¶é—´æ³¢åŠ¨å½±å“

**ç¼ºç‚¹ï¿½?*

* è§¦å‘æ—¶é—´ä¸å¯é¢„æµ‹

* æ•°æ®ç¨€å°‘æ—¶å»¶è¿Ÿè¾ƒå¤§

* ä¸é€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºï¿½?
### é€‚ç”¨åœºæ™¯

* ï¿½?æ‰¹é‡æ•°æ®å¤„ç†

* ï¿½?æ•°æ®é‡‡æ ·åˆ†æ

* ï¿½?æ€§èƒ½åŸºå‡†æµ‹è¯•

* ï¿½?æ•°æ®è´¨é‡æ£€ï¿½?
## ä¼šè¯çª—å£ (SessionWindow)

### ç‰¹ç‚¹

ä¼šè¯çª—å£ï¿½?*åŠ¨æ€å¤§ï¿½?*çš„çª—å£ï¼Œæ ¹æ®æ•°æ®åˆ°è¾¾çš„é—´éš”æ—¶é—´è‡ªåŠ¨è°ƒæ•´çª—å£è¾¹ç•Œã€‚å½“æ•°æ®é—´éš”è¶…è¿‡è®¾å®šçš„è¶…æ—¶æ—¶é—´æ—¶ï¼Œä¼šè¯ç»“æŸï¿½?
```mermaid
gantt
    title ä¼šè¯çª—å£ç¤ºä¾‹ (5åˆ†é’Ÿè¶…æ—¶)
    dateFormat X
    axisFormat %H:%M
    
    section ä¼šè¯1
    æ´»è·ƒï¿½?   :done, s1, 0, 8
    section è¶…æ—¶
    ç©ºé—²ï¿½?   :crit, gap1, 8, 10
    section ä¼šè¯2  
    æ´»è·ƒï¿½?   :done, s2, 10, 15
    section è¶…æ—¶
    ç©ºé—²ï¿½?   :crit, gap2, 15, 18
    section ä¼šè¯3
    æ´»è·ƒï¿½?   :active, s3, 18, 22
```

### è¯­æ³•

```sql
GROUP BY [session_key, ...], SessionWindow('timeout_duration')
```

### å‚æ•°è¯´æ˜

| å‚æ•°                 | ç±»å‹     | è¯´æ˜     | ç¤ºä¾‹                      |
| ------------------ | ------ | ------ | ----------------------- |
| `timeout_duration` | string | ä¼šè¯è¶…æ—¶æ—¶é—´ | `'5m'`, `'30s'`, `'1h'` |
| `session_key`      | string | ä¼šè¯åˆ†ç»„å­—æ®µ | `user_id`, `device_id`  |

### åŸºç¡€ç¤ºä¾‹

```sql
-- ç”¨æˆ·ä¼šè¯åˆ†æï¿½?åˆ†é’Ÿæ— æ´»åŠ¨åˆ™è®¤ä¸ºä¼šè¯ç»“æŸ
SELECT user_id,
       COUNT(*) as page_views,
       SUM(duration) as total_session_time,
       MIN(timestamp) as session_start,
       MAX(timestamp) as session_end,
       COUNT(DISTINCT page_url) as unique_pages
FROM stream
GROUP BY user_id, SessionWindow('5m')
HAVING total_session_time > 60  -- åªåˆ†æè¶…ï¿½?åˆ†é’Ÿçš„ä¼šï¿½?```

### å®é™…åº”ç”¨

#### 1. ç”¨æˆ·è¡Œä¸ºåˆ†æ

```sql
-- ç½‘ç«™ç”¨æˆ·ä¼šè¯åˆ†æ
SELECT user_id,
       COUNT(*) as actions_count,
       COUNT(DISTINCT action_type) as unique_actions,
       SUM(CASE WHEN action_type = 'purchase' THEN 1 ELSE 0 END) as purchases,
       SUM(CASE WHEN action_type = 'add_to_cart' THEN 1 ELSE 0 END) as cart_adds,
       AVG(page_load_time) as avg_load_time,
       -- è®¡ç®—ä¼šè¯æ—¶é•¿ï¼ˆç§’ï¿½?       (MAX(timestamp) - MIN(timestamp)) / 1000000000 as session_duration_seconds
FROM stream
WHERE user_id IS NOT NULL
GROUP BY user_id, SessionWindow('10m')  -- 10åˆ†é’Ÿæ— æ´»åŠ¨ç»“æŸä¼šï¿½?HAVING actions_count >= 3  -- è‡³å°‘3ä¸ªåŠ¨ä½œæ‰ç®—æœ‰æ•ˆä¼šï¿½?```

#### 2. è®¾å¤‡è¿æ¥ä¼šè¯

```sql
-- IoTè®¾å¤‡è¿æ¥ä¼šè¯ç›‘æ§
SELECT device_id,
       COUNT(*) as message_count,
       AVG(signal_strength) as avg_signal,
       MIN(signal_strength) as min_signal,
       SUM(data_bytes) as total_data_bytes,
       STDDEV(message_interval) as interval_stability,
       -- è¿æ¥è´¨é‡è¯„ä¼°
       CASE 
           WHEN AVG(signal_strength) > 80 AND STDDEV(message_interval) < 2.0 THEN 'EXCELLENT'
           WHEN AVG(signal_strength) > 60 AND STDDEV(message_interval) < 5.0 THEN 'GOOD'
           WHEN AVG(signal_strength) > 40 THEN 'FAIR'
           ELSE 'POOR'
       END as connection_quality
FROM stream
WHERE device_id IS NOT NULL AND signal_strength > 0
GROUP BY device_id, SessionWindow('2m')  -- 2åˆ†é’Ÿæ— æ•°æ®è®¤ä¸ºæ–­ï¿½?```

#### 3. åº”ç”¨ç¨‹åºä¼šè¯

```sql
-- ç§»åŠ¨åº”ç”¨ä½¿ç”¨ä¼šè¯
SELECT app_version,
       user_category,
       COUNT(*) as events_count,
       COUNT(DISTINCT event_type) as unique_events,
       AVG(cpu_usage) as avg_cpu_usage,
       AVG(memory_usage) as avg_memory_usage,
       SUM(CASE WHEN event_type = 'crash' THEN 1 ELSE 0 END) as crash_count,
       -- ä¼šè¯è¯„åˆ†
       CASE 
           WHEN SUM(CASE WHEN event_type = 'crash' THEN 1 ELSE 0 END) > 0 THEN 'BAD'
           WHEN AVG(cpu_usage) > 80 OR AVG(memory_usage) > 80 THEN 'POOR'
           WHEN COUNT(*) > 50 THEN 'ACTIVE'
           ELSE 'NORMAL'
       END as session_quality
FROM stream
WHERE app_version IS NOT NULL
GROUP BY app_version, user_category, SessionWindow('15m')
HAVING events_count >= 5
```

### ä¼šè¯é…ç½®ç­–ç•¥

#### è¶…æ—¶æ—¶é—´é€‰æ‹©

```sql
-- ä¸åŒåœºæ™¯çš„è¶…æ—¶é…ï¿½?-- Webæµè§ˆä¼šè¯
GROUP BY user_id, SessionWindow('30m')  -- 30åˆ†é’Ÿæ— æ´»ï¿½?
-- APIè°ƒç”¨ä¼šè¯  
GROUP BY api_key, SessionWindow('5m')   -- 5åˆ†é’Ÿæ— è°ƒï¿½?
-- è®¾å¤‡å¿ƒè·³ä¼šè¯
GROUP BY device_id, SessionWindow('2m') -- 2åˆ†é’Ÿæ— å¿ƒï¿½?
-- å®æ—¶æ¸¸æˆä¼šè¯
GROUP BY player_id, SessionWindow('30s') -- 30ç§’æ— æ“ä½œ
```

### ä¼˜ç¼ºï¿½?
**ä¼˜ç‚¹ï¿½?*

* è‡ªåŠ¨é€‚åº”ç”¨æˆ·è¡Œä¸ºæ¨¡å¼

* ç¬¦åˆä¸šåŠ¡è¯­ä¹‰

* èƒ½å¤Ÿå‡†ç¡®åˆ†æç”¨æˆ·/è®¾å¤‡ä¼šè¯

**ç¼ºç‚¹ï¿½?*

* è§¦å‘æ—¶é—´ä¸å¯é¢„æµ‹

* å†…å­˜ä½¿ç”¨ä¸å¯ï¿½?
* å®ç°å¤æ‚åº¦è¾ƒï¿½?
### é€‚ç”¨åœºæ™¯

* ï¿½?ç”¨æˆ·è¡Œä¸ºåˆ†æ

* ï¿½?è®¾å¤‡è¿æ¥ç›‘æ§

* ï¿½?åº”ç”¨ä½¿ç”¨åˆ†æ

* ï¿½?å¼‚å¸¸æ£€æµ‹ï¼ˆåŸºäºæ´»åŠ¨æ¨¡å¼ï¿½?
## çª—å£å‡½æ•°é«˜çº§ç”¨æ³•

### 1. å¤šå±‚çª—å£åˆ†æ

```sql
-- ç»“åˆä¸åŒçª—å£ç±»å‹è¿›è¡Œå¤šå±‚åˆ†æ
-- ç¬¬ä¸€å±‚ï¼šå®æ—¶ç›‘æ§ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
WITH real_time_stats AS (
    SELECT device_id,
           AVG(temperature) as current_avg,
           STDDEV(temperature) as current_stddev
    FROM stream
    GROUP BY device_id, SlidingWindow('5m', '1m')
),
-- ç¬¬äºŒå±‚ï¼šè¶‹åŠ¿åˆ†æï¼ˆæ»šåŠ¨çª—å£ï¼‰  
trend_stats AS (
    SELECT device_id,
           AVG(temperature) as hourly_avg,
           COUNT(*) as hourly_count
    FROM stream
    GROUP BY device_id, TumblingWindow('1h')
)
-- åœ¨åº”ç”¨å±‚åˆå¹¶ç»“æœè¿›è¡Œç»¼åˆåˆ†æ
```

### 2. è‡ªé€‚åº”çª—å£å¤§å°

```sql
-- æ ¹æ®æ•°æ®å¯†åº¦è°ƒæ•´çª—å£å‚æ•°
SELECT device_type,
       -- é«˜é¢‘è®¾å¤‡ä½¿ç”¨å°çª—ï¿½?       CASE 
           WHEN AVG(message_interval) < 1.0 THEN '30s'
           WHEN AVG(message_interval) < 10.0 THEN '2m'
           ELSE '5m'
       END as recommended_window_size,
       COUNT(*) as message_count,
       AVG(message_interval) as avg_interval
FROM stream
GROUP BY device_type, TumblingWindow('10m')
```

### 3. çª—å£ç»“æœç¼“å­˜

```sql
-- åˆ©ç”¨çª—å£å‡½æ•°å®ç°ç»“æœç¼“å­˜
SELECT device_id,
       -- å½“å‰çª—å£ç»Ÿè®¡
       AVG(temperature) as current_avg,
       -- ä¸å†å²æ•°æ®æ¯”è¾ƒéœ€è¦åœ¨åº”ç”¨å±‚å®ï¿½?       window_start() as window_id
FROM stream
GROUP BY device_id, TumblingWindow('5m')
```

## æ€§èƒ½ä¼˜åŒ–

### 1. çª—å£å¤§å°é€‰æ‹©

```sql
-- æ€§èƒ½è€ƒè™‘ï¼šçª—å£å¤§å°ä¸å†…å­˜ä½¿ç”¨
-- å°çª—å£ï¼šä½å»¶è¿Ÿï¼Œé«˜é¢‘è¾“å‡ºï¼Œå†…å­˜ä½¿ç”¨ç¨³ï¿½?GROUP BY TumblingWindow('1m')

-- å¤§çª—å£ï¼šé«˜å»¶è¿Ÿï¼Œä½é¢‘è¾“å‡ºï¼Œå†…å­˜ä½¿ç”¨è¾ƒï¿½? 
GROUP BY TumblingWindow('1h')

-- æ»‘åŠ¨çª—å£ï¼šè®¡ç®—å¼€é”€æœ€ï¿½?GROUP BY SlidingWindow('10m', '1m')  -- éœ€è¦ç»´æŠ¤å¤šä¸ªçª—å£çŠ¶ï¿½?```

### 2. åˆ†ç»„å­—æ®µä¼˜åŒ–

```sql
-- å¥½çš„å®è·µï¼šåˆç†çš„åˆ†ç»„ç²’åº¦
GROUP BY device_type, TumblingWindow('5m')     -- ç²—ç²’åº¦ï¼ŒçŠ¶æ€å°‘

-- é¿å…ï¼šè¿‡ç»†ç²’åº¦åˆ†ï¿½?GROUP BY device_id, user_id, TumblingWindow('5m')  -- ç»†ç²’åº¦ï¼ŒçŠ¶æ€å¤š
```

### 3. å†…å­˜ç®¡ç†

```sql
-- ä½¿ç”¨LIMITæ§åˆ¶è¾“å‡ºå¤§å°
SELECT device_id, AVG(temperature)
FROM stream
GROUP BY device_id, TumblingWindow('5m')
LIMIT 100  -- é™åˆ¶æ¯ä¸ªçª—å£æœ€ï¿½?00ä¸ªç»“ï¿½?```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. çª—å£ä¸è§¦ï¿½?
```sql
-- æ£€æŸ¥ï¼šæ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®
SELECT COUNT(*) as data_count, 
       MIN(timestamp) as first_data,
       MAX(timestamp) as last_data
FROM stream
-- æ»šåŠ¨çª—å£éœ€è¦ç­‰å¾…çª—å£ç»“æŸæ—¶ï¿½?```

#### 2. å†…å­˜ä½¿ç”¨è¿‡é«˜

```sql
-- ä¼˜åŒ–ï¼šå‡å°‘åˆ†ç»„ç»´åº¦æˆ–çª—å£å¤§å°
-- ä»è¿™æ ·ï¼š
GROUP BY device_id, location, user_id, TumblingWindow('1h')
-- æ”¹ä¸ºï¿½?GROUP BY device_type, TumblingWindow('10m')
```

#### 3. ç»“æœå»¶è¿Ÿ

```sql
-- è§£å†³ï¼šä½¿ç”¨æ›´å°çš„çª—å£æˆ–æ»‘åŠ¨é—´ï¿½?-- ä»è¿™æ ·ï¼š
GROUP BY SlidingWindow('1h', '30m')  -- 30åˆ†é’Ÿæ‰æ›´æ–°ä¸€ï¿½?-- æ”¹ä¸ºï¿½?GROUP BY SlidingWindow('10m', '2m')  -- 2åˆ†é’Ÿæ›´æ–°ä¸€ï¿½?```

## ä¸‹ä¸€ï¿½?
ç°åœ¨æ‚¨å·²ç»æŒæ¡äº†çª—å£å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ï¼Œå»ºè®®ç»§ç»­å­¦ä¹ ï¿½?
* ğŸ”§ [è‡ªå®šä¹‰å‡½æ•°](../06.è‡ªå®šä¹‰å‡½ï¿½?) - æ‰©å±•å¤„ç†èƒ½åŠ›

* ğŸ’¡ [ç¤ºä¾‹é›†åˆ](../07.ç¤ºä¾‹/) - æŸ¥çœ‹æ›´å¤šçª—å£å‡½æ•°åº”ç”¨æ¡ˆä¾‹

* ğŸ“– [æœ€ä½³å®è·µ](../09.æœ€ä½³å®ï¿½?) - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®

* ğŸ“š [APIå‚è€ƒ](../08.APIå‚ï¿½?) - å®Œæ•´çš„APIæ–‡æ¡£

