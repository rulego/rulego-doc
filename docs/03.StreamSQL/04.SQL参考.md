---
title: SQLå‚è€ƒ
date: 2024-01-15 10:04:00
permalink: /pages/streamsql-sql/
article: false
author: 
  name: StreamSQL
  link: https://github.com/rulego/streamsql
---

# SQLå‚è€ƒ

æœ¬ç« æä¾›StreamSQLæ”¯æŒçš„å®Œæ•´SQLè¯­æ³•å‚è€ƒï¼ŒåŒ…æ‹¬æ‰€æœ‰æ”¯æŒçš„å­å¥ã€å‡½æ•°å’Œæ“ä½œç¬¦ã€‚

## ğŸ“‹ SQLè¯­æ³•æ¦‚è§ˆ

StreamSQLæ”¯æŒæ ‡å‡†SQLè¯­æ³•çš„å­é›†ï¼Œä¸“é—¨é’ˆå¯¹æµå¤„ç†è¿›è¡Œäº†ä¼˜åŒ–ã€‚

```sql
SELECT [DISTINCT] select_list
FROM stream
[WHERE condition]
[GROUP BY grouping_element [, ...]]
[HAVING condition]
[LIMIT count]
[WITH (option = value [, ...])]
```

StreamSQLæ”¯æŒæ ‡å‡†SQLè¯­æ³•çš„å­é›†ï¼Œä¸“é—¨é’ˆå¯¹æµå¤„ç†åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚æœ¬ç« æä¾›å®Œæ•´çš„SQLè¯­æ³•å‚è€ƒã€‚

## SQLè¯­æ³•æ¦‚è§ˆ

### åŸºæœ¬æŸ¥è¯¢ç»“æ„

```sql
SELECT [DISTINCT] select_list
FROM stream_name
[WHERE condition]
[GROUP BY grouping_list]
[HAVING condition]
[ORDER BY ordering_list]
[LIMIT number]
[WITH (option_list)]
```

### æ”¯æŒçš„å­å¥

| å­å¥ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|
| SELECT | æ˜¯ | æŒ‡å®šè¾“å‡ºå­—æ®µ |
| FROM | æ˜¯ | æŒ‡å®šæ•°æ®æº |
| WHERE | å¦ | è¿‡æ»¤æ¡ä»¶ |
| GROUP BY | å¦ | åˆ†ç»„å’Œçª—å£ |
| HAVING | å¦ | èšåˆç»“æœè¿‡æ»¤ |
| ORDER BY | å¦ | æ’åºï¼ˆæœ‰é™æ”¯æŒï¼‰ |
| LIMIT | å¦ | é™åˆ¶ç»“æœæ•°é‡ |
| WITH | å¦ | é…ç½®é€‰é¡¹ |

## SELECT å­å¥

SELECTå­å¥å®šä¹‰æŸ¥è¯¢çš„è¾“å‡ºå­—æ®µå’Œè®¡ç®—è¡¨è¾¾å¼ã€‚

### åŸºæœ¬è¯­æ³•

```sql
SELECT column1, column2, expression AS alias
FROM stream
```

### æ”¯æŒçš„é€‰æ‹©ç±»å‹

#### 1. å­—æ®µé€‰æ‹©

```sql
-- é€‰æ‹©æ‰€æœ‰å­—æ®µ
SELECT * FROM stream

-- é€‰æ‹©ç‰¹å®šå­—æ®µ
SELECT deviceId, temperature FROM stream

-- å­—æ®µåˆ«å
SELECT deviceId AS device, temperature AS temp FROM stream
```

#### 2. åµŒå¥—å­—æ®µè®¿é—®

```sql
-- ç‚¹å·è¯­æ³•è®¿é—®åµŒå¥—å­—æ®µ
SELECT device.info.name, device.location.building FROM stream

-- æ·±å±‚åµŒå¥—
SELECT sensor.data.temperature.value FROM stream
```

#### 3. è¡¨è¾¾å¼è®¡ç®—

```sql
-- ç®—æœ¯è¡¨è¾¾å¼
SELECT temperature * 1.8 + 32 AS fahrenheit FROM stream

-- å­—ç¬¦ä¸²è¿æ¥
SELECT CONCAT(deviceId, '-', location) AS full_id FROM stream

-- æ¡ä»¶è¡¨è¾¾å¼
SELECT CASE 
    WHEN temperature > 30 THEN 'hot'
    WHEN temperature < 10 THEN 'cold'
    ELSE 'normal'
END AS temp_level FROM stream
```

#### 4. èšåˆå‡½æ•°

```sql
-- åŸºç¡€èšåˆ
SELECT COUNT(*), AVG(temperature), MAX(humidity) FROM stream

-- å¸¦åˆ†ç»„çš„èšåˆ
SELECT deviceId, AVG(temperature) FROM stream GROUP BY deviceId
```

### DISTINCT å»é‡

```sql
-- å»é‡æŸ¥è¯¢
SELECT DISTINCT deviceType FROM stream

-- å¤šå­—æ®µå»é‡
SELECT DISTINCT deviceId, location FROM stream
```

### åŸºæœ¬è¯­æ³•

```sql
SELECT column1, column2, ...
SELECT expression AS alias
SELECT *
SELECT DISTINCT column1
```

### å­—æ®µé€‰æ‹©

#### 1. ç›´æ¥å­—æ®µå¼•ç”¨
```sql
-- é€‰æ‹©ç‰¹å®šå­—æ®µ
SELECT deviceId, temperature, humidity FROM stream

-- é€‰æ‹©æ‰€æœ‰å­—æ®µ 
SELECT * FROM stream
```

#### 2. è¡¨è¾¾å¼è®¡ç®—
```sql
-- ç®—æœ¯è¡¨è¾¾å¼
SELECT deviceId, temperature * 1.8 + 32 as fahrenheit FROM stream

-- å­—ç¬¦ä¸²è¿æ¥
SELECT CONCAT(deviceId, '_', status) as device_status FROM stream

-- æ¡ä»¶è¡¨è¾¾å¼
SELECT deviceId,
       CASE 
           WHEN temperature > 30 THEN 'HIGH'
           WHEN temperature > 20 THEN 'NORMAL' 
           ELSE 'LOW'
       END as temp_level
FROM stream
```

#### 3. å‡½æ•°è°ƒç”¨
```sql
-- å†…ç½®å‡½æ•°
SELECT deviceId, UPPER(status), ABS(temperature) FROM stream

-- èšåˆå‡½æ•°
SELECT deviceId, AVG(temperature), COUNT(*) FROM stream
GROUP BY deviceId, TumblingWindow('1m')

-- è‡ªå®šä¹‰å‡½æ•°
SELECT deviceId, custom_function(temperature) FROM stream
```

### åˆ«å (AS)

```sql
-- å­—æ®µåˆ«å
SELECT temperature AS temp, humidity AS hum FROM stream

-- è¡¨è¾¾å¼åˆ«å 
SELECT temperature * 1.8 + 32 AS fahrenheit FROM stream

-- ASå…³é”®å­—å¯çœç•¥
SELECT temperature temp, humidity hum FROM stream
```

### DISTINCT

```sql
-- å»é‡ï¼ˆåœ¨çª—å£èšåˆä¸­ä½¿ç”¨ï¼‰
SELECT DISTINCT deviceId, location 
FROM stream 
GROUP BY TumblingWindow('1m')
```

## FROM å­å¥

FROMå­å¥æŒ‡å®šæ•°æ®æºï¼Œåœ¨StreamSQLä¸­é€šå¸¸ä¸º`stream`ã€‚

### åŸºæœ¬è¯­æ³•

```sql
SELECT * FROM stream
```

### æ•°æ®æºç±»å‹

- **stream**: é»˜è®¤çš„æµæ•°æ®æº
- æœªæ¥ç‰ˆæœ¬å¯èƒ½æ”¯æŒå¤šä¸ªå‘½åæµ

```sql
-- å½“å‰æ”¯æŒ
SELECT * FROM stream

-- æœªæ¥å¯èƒ½æ”¯æŒ
SELECT * FROM sensor_stream
SELECT * FROM device_stream
```

### æ•°æ®æºæŒ‡å®š

```sql
-- æ ‡å‡†æ•°æ®æºåç§°
FROM stream

-- è‡ªå®šä¹‰æ•°æ®æºåç§°
FROM sensor_data
FROM device_stream
```

::: tip æç¤º
FROMå­å¥ä¸­çš„åç§°æ˜¯é€»è¾‘æ¦‚å¿µï¼Œå®é™…æ•°æ®é€šè¿‡ `AddData()` æ–¹æ³•è¾“å…¥ã€‚
:::

## WHERE å­å¥

WHEREå­å¥ç”¨äºè¿‡æ»¤æ•°æ®ï¼Œåªå¤„ç†æ»¡è¶³æ¡ä»¶çš„è®°å½•ã€‚

### åŸºæœ¬è¯­æ³•

```sql
SELECT * FROM stream WHERE condition
```

### æ”¯æŒçš„æ¡ä»¶ç±»å‹

#### 1. æ¯”è¾ƒæ“ä½œç¬¦

```sql
-- æ•°å€¼æ¯”è¾ƒ
SELECT * FROM stream WHERE temperature > 25
SELECT * FROM stream WHERE humidity <= 60
SELECT * FROM stream WHERE pressure = 1013.25
SELECT * FROM stream WHERE voltage != 0

-- å­—ç¬¦ä¸²æ¯”è¾ƒ
SELECT * FROM stream WHERE deviceId = 'sensor001'
SELECT * FROM stream WHERE location != 'offline'
```

#### 2. é€»è¾‘æ“ä½œç¬¦

```sql
-- AND æ“ä½œ
SELECT * FROM stream WHERE temperature > 20 AND humidity < 80

-- OR æ“ä½œ
SELECT * FROM stream WHERE deviceType = 'temperature' OR deviceType = 'humidity'

-- NOT æ“ä½œ
SELECT * FROM stream WHERE NOT (temperature < 0)

-- å¤åˆæ¡ä»¶
SELECT * FROM stream WHERE (temperature > 30 OR humidity > 90) AND deviceId LIKE 'sensor%'
```

#### 3. èŒƒå›´æ“ä½œ

```sql
-- BETWEEN èŒƒå›´
SELECT * FROM stream WHERE temperature BETWEEN 20 AND 30

-- IN åˆ—è¡¨
SELECT * FROM stream WHERE deviceType IN ('temperature', 'humidity', 'pressure')

-- NOT IN
SELECT * FROM stream WHERE deviceId NOT IN ('test001', 'test002')
```

#### 4. æ¨¡å¼åŒ¹é…

```sql
-- LIKE æ¨¡å¼åŒ¹é…
SELECT * FROM stream WHERE deviceId LIKE 'sensor%'  -- ä»¥sensorå¼€å¤´
SELECT * FROM stream WHERE location LIKE '%room%'   -- åŒ…å«room
SELECT * FROM stream WHERE deviceId LIKE 'dev___'   -- devåè·Ÿ3ä¸ªå­—ç¬¦

-- å­—ç¬¦ä¸²å‡½æ•°
SELECT * FROM stream WHERE STARTSWITH(deviceId, 'sensor')
SELECT * FROM stream WHERE ENDSWITH(location, 'floor')
SELECT * FROM stream WHERE CONTAINS(description, 'temperature')
```

#### 5. NULL æ£€æŸ¥

```sql
-- NULL æ£€æŸ¥
SELECT * FROM stream WHERE temperature IS NOT NULL
SELECT * FROM stream WHERE error_msg IS NULL

-- ç©ºå­—ç¬¦ä¸²æ£€æŸ¥
SELECT * FROM stream WHERE deviceId != ''
SELECT * FROM stream WHERE TRIM(location) != ''
```

#### 6. åµŒå¥—å­—æ®µæ¡ä»¶

```sql
-- åµŒå¥—å­—æ®µè¿‡æ»¤
SELECT * FROM stream WHERE device.info.status = 'active'
SELECT * FROM stream WHERE sensor.data.temperature > 25
SELECT * FROM stream WHERE config.settings.enabled = true
```

### è¿‡æ»¤æ¡ä»¶

#### 1. æ¯”è¾ƒæ“ä½œ
```sql
-- æ•°å€¼æ¯”è¾ƒ
WHERE temperature > 25
WHERE humidity BETWEEN 30 AND 70
WHERE pressure != 1013.25

-- å­—ç¬¦ä¸²æ¯”è¾ƒ 
WHERE deviceId = 'sensor001'
WHERE status IN ('active', 'online')
WHERE location LIKE 'building_%'
```

#### 2. é€»è¾‘æ“ä½œ
```sql
-- é€»è¾‘ç»„åˆ
WHERE temperature > 25 AND humidity < 60
WHERE status = 'active' OR status = 'standby'
WHERE NOT (temperature < 0)

-- ç©ºå€¼æ£€æŸ¥
WHERE temperature IS NOT NULL
WHERE deviceId IS NULL
```

#### 3. å¤æ‚æ¡ä»¶
```sql
-- åµŒå¥—æ¡ä»¶
WHERE (temperature > 30 AND humidity > 80) 
   OR (temperature < 0 AND pressure > 1020)

-- å‡½æ•°æ¡ä»¶
WHERE ABS(temperature - 25) > 5
WHERE LENGTH(deviceId) > 10
```

### æ”¯æŒçš„æ“ä½œç¬¦

| æ“ä½œç¬¦ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `=` | ç­‰äº | `temperature = 25` |
| `!=`, `<>` | ä¸ç­‰äº | `status != 'offline'` |
| `>`, `>=` | å¤§äºã€å¤§äºç­‰äº | `humidity > 50` |
| `<`, `<=` | å°äºã€å°äºç­‰äº | `pressure <= 1000` |
| `BETWEEN` | èŒƒå›´ | `temperature BETWEEN 20 AND 30` |
| `IN` | åŒ…å« | `status IN ('on', 'off')` |
| `LIKE` | æ¨¡å¼åŒ¹é… | `name LIKE 'sensor%'` |
| `IS NULL` | ç©ºå€¼æ£€æŸ¥ | `value IS NULL` |
| `AND` | é€»è¾‘ä¸ | `temp > 20 AND humid < 60` |
| `OR` | é€»è¾‘æˆ– | `status = 'on' OR status = 'ready'` |
| `NOT` | é€»è¾‘é | `NOT (temperature < 0)` |

## GROUP BY å­å¥

GROUP BYå­å¥ç”¨äºæ•°æ®åˆ†ç»„å’Œçª—å£å®šä¹‰ï¼Œæ˜¯æµå¤„ç†ä¸­çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

### åŸºæœ¬è¯­æ³•

```sql
SELECT aggregate_function(column)
FROM stream
GROUP BY grouping_columns [, window_function]
```

### åˆ†ç»„ç±»å‹

#### 1. å­—æ®µåˆ†ç»„

```sql
-- å•å­—æ®µåˆ†ï¿½?
SELECT deviceId, COUNT(*) FROM stream GROUP BY deviceId

-- å¤šå­—æ®µåˆ†ï¿½?
SELECT deviceId, location, AVG(temperature) 
FROM stream 
GROUP BY deviceId, location

-- è¡¨è¾¾å¼åˆ†ï¿½?
SELECT HOUR(timestamp) as hour, COUNT(*) 
FROM stream 
GROUP BY HOUR(timestamp)
```

#### 2. çª—å£åˆ†ç»„

##### æ»šåŠ¨çª—å£ (Tumbling Window)

```sql
-- æ—¶é—´æ»šåŠ¨çª—å£
SELECT COUNT(*) FROM stream GROUP BY TumblingWindow('5s')
SELECT AVG(temperature) FROM stream GROUP BY TumblingWindow('1m')
SELECT SUM(value) FROM stream GROUP BY TumblingWindow('1h')

-- å¸¦å­—æ®µåˆ†ç»„çš„æ»šåŠ¨çª—å£
SELECT deviceId, AVG(temperature) 
FROM stream 
GROUP BY deviceId, TumblingWindow('5s')
```

##### æ»‘åŠ¨çª—å£ (Sliding Window)

```sql
-- æ»‘åŠ¨çª—å£ï¼šçª—å£å¤§å°ï¼Œæ»‘åŠ¨é—´éš”
SELECT AVG(temperature) FROM stream GROUP BY SlidingWindow('30s', '10s')
SELECT MAX(pressure) FROM stream GROUP BY SlidingWindow('1m', '30s')

-- å¸¦åˆ†ç»„çš„æ»‘åŠ¨çª—å£
SELECT deviceId, AVG(temperature) 
FROM stream 
GROUP BY deviceId, SlidingWindow('30s', '10s')
```

##### è®¡æ•°çª—å£ (Counting Window)

```sql
-- æ¯Næ¡è®°å½•è§¦å‘ä¸€ï¿½?
SELECT COUNT(*) FROM stream GROUP BY CountingWindow(100)
SELECT AVG(value) FROM stream GROUP BY CountingWindow(50)

-- å¸¦åˆ†ç»„çš„è®¡æ•°çª—å£
SELECT deviceId, COUNT(*) 
FROM stream 
GROUP BY deviceId, CountingWindow(10)
```

##### ä¼šè¯çª—å£ (Session Window)

```sql
-- ä¼šè¯è¶…æ—¶çª—å£
SELECT userId, COUNT(*) FROM stream GROUP BY userId, SessionWindow('5m')
SELECT deviceId, SUM(events) FROM stream GROUP BY deviceId, SessionWindow('30s')
```

### çª—å£å‡½æ•°

åœ¨GROUP BYä¸­å¯ä»¥ä½¿ç”¨çª—å£ç›¸å…³çš„å‡½æ•°ï¿½?

```sql
SELECT deviceId,
       COUNT(*) as event_count,
       window_start() as start_time,
       window_end() as end_time,
       window_duration() as duration
FROM stream 
GROUP BY deviceId, TumblingWindow('5s')
```

### åˆ†ç»„å­—æ®µ

```sql
-- å•å­—æ®µåˆ†ï¿½?
GROUP BY deviceId

-- å¤šå­—æ®µåˆ†ï¿½? 
GROUP BY deviceId, location, status

-- è¡¨è¾¾å¼åˆ†ï¿½?
GROUP BY FLOOR(temperature / 10) * 10  -- æŒ‰æ¸©åº¦åŒºé—´åˆ†ï¿½?
```

### çª—å£å‡½æ•°

#### 1. æ»šåŠ¨çª—å£ (TumblingWindow)
```sql
-- åŸºæœ¬è¯­æ³•
GROUP BY deviceId, TumblingWindow('5m')

-- æ”¯æŒçš„æ—¶é—´å•ä½
GROUP BY TumblingWindow('30s')   -- 30ç§’
GROUP BY TumblingWindow('5m')    -- 5åˆ†é’Ÿ  
GROUP BY TumblingWindow('1h')    -- 1å°æ—¶
GROUP BY TumblingWindow('1d')    -- 1å¤©
```

#### 2. æ»‘åŠ¨çª—å£ (SlidingWindow)  
```sql
-- åŸºæœ¬è¯­æ³•: SlidingWindow(çª—å£å¤§å°, æ»‘åŠ¨é—´éš”)
GROUP BY deviceId, SlidingWindow('10m', '2m')

-- ç¤ºä¾‹
GROUP BY SlidingWindow('1h', '15m')    -- 1å°æ—¶çª—å£ï¼Œæ¯15åˆ†é’Ÿæ»‘åŠ¨
GROUP BY SlidingWindow('30s', '5s')    -- 30ç§’çª—å£ï¼Œæ¯5ç§’æ»‘åŠ¨
```

#### 3. è®¡æ•°çª—å£ (CountingWindow)
```sql
-- åŸºæœ¬è¯­æ³•
GROUP BY deviceId, CountingWindow(100)   -- æ¯100æ¡æ•°æ®

-- ç¤ºä¾‹  
GROUP BY CountingWindow(50)     -- æ¯50æ¡æ•°æ®è§¦å‘
GROUP BY CountingWindow(1000)   -- æ¯1000æ¡æ•°æ®è§¦å‘
```

#### 4. ä¼šè¯çª—å£ (SessionWindow)
```sql
-- åŸºæœ¬è¯­æ³•
GROUP BY user_id, SessionWindow('5m')    -- 5åˆ†é’Ÿè¶…æ—¶

-- ç¤ºä¾‹
GROUP BY device_id, SessionWindow('30s') -- 30ç§’æ— æ•°æ®åˆ™å…³é—­ä¼šè¯
GROUP BY session_key, SessionWindow('10m') -- 10åˆ†é’Ÿä¼šè¯è¶…æ—¶
```

## HAVING å­å¥

HAVINGå­å¥ç”¨äºè¿‡æ»¤èšåˆç»“æœï¼Œç±»ä¼¼äºWHEREä½†ä½œç”¨äºGROUP BYä¹‹åã€‚

### åŸºæœ¬è¯­æ³•

```sql
SELECT aggregate_function(column)
FROM stream
GROUP BY grouping_columns
HAVING aggregate_condition
```

### ä½¿ç”¨ç¤ºä¾‹

#### 1. èšåˆå‡½æ•°è¿‡æ»¤

```sql
-- è¿‡æ»¤å¹³å‡æ¸©åº¦
SELECT deviceId, AVG(temperature) as avg_temp
FROM stream
GROUP BY deviceId, TumblingWindow('5s')
HAVING AVG(temperature) > 25

-- è¿‡æ»¤è®¡æ•°
SELECT location, COUNT(*) as event_count
FROM stream
GROUP BY location, TumblingWindow('1m')
HAVING COUNT(*) >= 10

-- å¤šä¸ªèšåˆæ¡ä»¶
SELECT deviceId, AVG(temperature), MAX(humidity)
FROM stream
GROUP BY deviceId, TumblingWindow('5s')
HAVING AVG(temperature) > 20 AND MAX(humidity) < 80
```

#### 2. å¤åˆæ¡ä»¶

```sql
-- å¤æ‚çš„HAVINGæ¡ä»¶
SELECT deviceType, COUNT(*) as count, AVG(value) as avg_value
FROM stream
GROUP BY deviceType, TumblingWindow('1m')
HAVING COUNT(*) > 5 AND (AVG(value) > 100 OR MAX(value) > 500)
```

### WHERE vs HAVING

```sql
-- æ­£ç¡®ï¼šWHEREè¿‡æ»¤åŸå§‹æ•°æ®ï¼ŒHAVINGè¿‡æ»¤èšåˆç»“æœ
SELECT deviceId, AVG(temperature)
FROM stream
WHERE temperature > 0          -- è¿‡æ»¤åŸå§‹æ•°æ®
GROUP BY deviceId, TumblingWindow('5s')
HAVING AVG(temperature) > 25    -- è¿‡æ»¤èšåˆç»“æœ

-- é”™è¯¯ï¼šåœ¨HAVINGä¸­è¿‡æ»¤åŸå§‹å­—æ®µ
SELECT deviceId, AVG(temperature)
FROM stream
GROUP BY deviceId, TumblingWindow('5s')
HAVING deviceId = 'sensor001'   -- åº”è¯¥åœ¨WHEREä¸­
```

ç”¨äºè¿‡æ»¤èšåˆç»“æœã€‚

```sql
-- åŸºæœ¬ç”¨æ³•
SELECT deviceId, AVG(temperature) as avg_temp
FROM stream  
GROUP BY deviceId, TumblingWindow('5m')
HAVING avg_temp > 25

-- å¤æ‚æ¡ä»¶
SELECT deviceId, COUNT(*) as count, AVG(temperature) as avg_temp
FROM stream
GROUP BY deviceId, TumblingWindow('5m')  
HAVING count > 10 AND avg_temp BETWEEN 20 AND 30

-- ä½¿ç”¨èšåˆå‡½æ•°
SELECT location, AVG(temperature) as avg_temp
FROM stream
GROUP BY location, TumblingWindow('10m')
HAVING AVG(temperature) > 25 AND COUNT(*) >= 5
```

## ORDER BY å­å¥

::: warning æ³¨æ„
ORDER BYåœ¨æµå¤„ç†ä¸­æ”¯æŒæœ‰é™ï¼Œä¸»è¦ç”¨äºçª—å£ç»“æœæ’åºã€‚
:::

```sql
-- æŒ‰èšåˆç»“æœæ’åºï¼ˆåœ¨çª—å£å†…ï¼‰
SELECT deviceId, AVG(temperature) as avg_temp
FROM stream
GROUP BY deviceId, TumblingWindow('5m')
ORDER BY avg_temp DESC

-- å¤šå­—æ®µæ’åº
ORDER BY avg_temp DESC, deviceId ASC
```

## LIMIT å­å¥

LIMITå­å¥é™åˆ¶æŸ¥è¯¢ç»“æœçš„æ•°é‡ï¼Œåœ¨æµå¤„ç†ä¸­é€šå¸¸ç”¨äºé™åˆ¶çª—å£è¾“å‡ºçš„è®°å½•æ•°ã€‚

### åŸºæœ¬è¯­æ³•

```sql
SELECT columns FROM stream [WHERE condition] LIMIT count
```

### ä½¿ç”¨ç¤ºä¾‹

```sql
-- é™åˆ¶ç»“æœæ•°é‡
SELECT * FROM stream LIMIT 100

-- ä¸çª—å£ç»“åˆä½¿ç”¨
SELECT deviceId, temperature
FROM stream
GROUP BY TumblingWindow('5s')
LIMIT 10

-- è·å–æœ€æ–°çš„Næ¡è®°å½•
SELECT deviceId, temperature, timestamp
FROM stream
WHERE deviceId = 'sensor001'
ORDER BY timestamp DESC
LIMIT 5
```

### æ³¨æ„äº‹é¡¹

- LIMITåœ¨æµå¤„ç†ä¸­ä¸»è¦ç”¨äºæ§åˆ¶è¾“å‡ºé‡
- å¯¹äºèšåˆæŸ¥è¯¢ï¼ŒLIMITé™åˆ¶çš„æ˜¯èšåˆç»“æœçš„æ•°é‡
- å»ºè®®åˆç†è®¾ç½®LIMITä»¥é¿å…å†…å­˜å‹åŠ›

é™åˆ¶è¾“å‡ºç»“æœæ•°é‡ã€‚

```sql
-- åŸºæœ¬ç”¨æ³•
SELECT deviceId, temperature FROM stream LIMIT 10

-- ä¸çª—å£ç»“åˆ
SELECT deviceId, AVG(temperature) as avg_temp
FROM stream  
GROUP BY deviceId, TumblingWindow('5m')
LIMIT 5   -- æ¯ä¸ªçª—å£æœ€å¤š5ä¸ªç»“æœ
```

## WITH å­å¥

WITHå­å¥ç”¨äºæŒ‡å®šæŸ¥è¯¢çš„é…ç½®é€‰é¡¹ï¼Œä¸»è¦ç”¨äºé…ç½®äº‹ä»¶æ—¶é—´çª—å£çš„æ—¶é—´æˆ³å­—æ®µå’Œæ—¶é—´å•ä½ã€‚

### åŸºæœ¬è¯­æ³•

```sql
SELECT columns FROM stream
[WHERE condition]
[GROUP BY grouping]
WITH (option = value [, ...])
```

### æ ¸å¿ƒä½œç”¨

WITHå­å¥çš„ä¸»è¦ä½œç”¨æ˜¯**å°†çª—å£ä»å¤„ç†æ—¶é—´æ¨¡å¼åˆ‡æ¢åˆ°äº‹ä»¶æ—¶é—´æ¨¡å¼**ï¼š

- **ä¸æŒ‡å®š WITH (TIMESTAMP=...)**ï¼šä½¿ç”¨å¤„ç†æ—¶é—´ï¼ˆé»˜è®¤ï¼‰
  - çª—å£åŸºäºæ•°æ®åˆ°è¾¾ç³»ç»Ÿçš„æ—¶é—´åˆ’åˆ†
  - ä¸ç®¡æ•°æ®ä¸­çš„æ—¶é—´å­—æ®µæ˜¯ä»€ä¹ˆå€¼

- **æŒ‡å®š WITH (TIMESTAMP='field_name')**ï¼šä½¿ç”¨äº‹ä»¶æ—¶é—´
  - çª—å£åŸºäºæ•°æ®ä¸­æŒ‡å®šå­—æ®µçš„æ—¶é—´å€¼åˆ’åˆ†
  - å³ä½¿æ•°æ®å»¶è¿Ÿåˆ°è¾¾ï¼Œä¹Ÿèƒ½æ­£ç¡®ç»Ÿè®¡åˆ°å¯¹åº”çª—å£

### æ”¯æŒçš„é€‰é¡¹

#### 1. TIMESTAMP - æ—¶é—´æˆ³å­—æ®µé…ç½®

**ä½œç”¨**ï¼šæŒ‡å®šæ•°æ®ä¸­ç”¨äºäº‹ä»¶æ—¶é—´çš„å­—æ®µåï¼Œå¯ç”¨äº‹ä»¶æ—¶é—´çª—å£æ¨¡å¼ã€‚

**è¯­æ³•**ï¼š
```sql
WITH (TIMESTAMP = 'field_name')
```

**ç¤ºä¾‹**ï¼š

```sql
-- ä½¿ç”¨ order_time å­—æ®µä½œä¸ºäº‹ä»¶æ—¶é—´
SELECT COUNT(*) as order_count
FROM stream
GROUP BY TumblingWindow('5m')
WITH (TIMESTAMP = 'order_time')

-- ä½¿ç”¨ event_time å­—æ®µä½œä¸ºäº‹ä»¶æ—¶é—´
SELECT deviceId, AVG(temperature)
FROM stream
GROUP BY deviceId, TumblingWindow('1m')
WITH (TIMESTAMP = 'event_time')

-- ä½¿ç”¨ timestamp å­—æ®µä½œä¸ºäº‹ä»¶æ—¶é—´
SELECT COUNT(*) FROM stream
GROUP BY SlidingWindow('30s', '10s')
WITH (TIMESTAMP = 'timestamp')
```

**é‡è¦è¯´æ˜**ï¼š
- æŒ‡å®š `TIMESTAMP` åï¼Œçª—å£å°†åŸºäºè¯¥å­—æ®µçš„å€¼æ¥åˆ’åˆ†çª—å£
- å¦‚æœæ•°æ®ä¸­æ²¡æœ‰è¯¥å­—æ®µï¼Œæˆ–å­—æ®µå€¼ä¸ºç©ºï¼Œå°†ä½¿ç”¨ç³»ç»Ÿå½“å‰æ—¶é—´ä½œä¸ºå›é€€
- å­—æ®µå€¼å¯ä»¥æ˜¯ `time.Time` ç±»å‹æˆ–æ•´æ•°ç±»å‹ï¼ˆéœ€é…åˆ `TIMEUNIT`ï¼‰

#### 2. TIMEUNIT - æ—¶é—´å•ä½é…ç½®

**ä½œç”¨**ï¼šå½“æ—¶é—´æˆ³å­—æ®µæ˜¯æ•´æ•°ç±»å‹ï¼ˆå¦‚ Unix æ—¶é—´æˆ³ï¼‰æ—¶ï¼ŒæŒ‡å®šæ—¶é—´å•ä½ä»¥æ­£ç¡®è§£ææ—¶é—´æˆ³ã€‚

**è¯­æ³•**ï¼š
```sql
WITH (TIMEUNIT = 'unit')
```

**æ”¯æŒçš„æ—¶é—´å•ä½**ï¼š

| å•ä½å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `'ns'` | çº³ç§’ | çº³ç§’çº§æ—¶é—´æˆ³ |
| `'ms'` | æ¯«ç§’ï¼ˆé»˜è®¤ï¼‰ | Unix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| `'ss'` | ç§’ | Unix æ—¶é—´æˆ³ï¼ˆç§’ï¼‰ |
| `'mi'` | åˆ†é’Ÿ | åˆ†é’Ÿçº§æ—¶é—´æˆ³ |
| `'hh'` | å°æ—¶ | å°æ—¶çº§æ—¶é—´æˆ³ |
| `'dd'` | å¤© | å¤©çº§æ—¶é—´æˆ³ |

**ç¤ºä¾‹**ï¼š

```sql
-- æ—¶é—´æˆ³å­—æ®µæ˜¯æ¯«ç§’çº§æ•´æ•°ï¼ˆå¦‚ 1704067200000ï¼‰
SELECT COUNT(*) FROM stream
GROUP BY TumblingWindow('5m')
WITH (TIMESTAMP = 'event_time', TIMEUNIT = 'ms')

-- æ—¶é—´æˆ³å­—æ®µæ˜¯ç§’çº§æ•´æ•°ï¼ˆå¦‚ 1704067200ï¼‰
SELECT AVG(temperature) FROM stream
GROUP BY TumblingWindow('1m')
WITH (TIMESTAMP = 'timestamp', TIMEUNIT = 'ss')
```

**é‡è¦è¯´æ˜**ï¼š
- å¦‚æœæ—¶é—´æˆ³å­—æ®µæ˜¯ `time.Time` ç±»å‹ï¼Œ**ä¸éœ€è¦**æŒ‡å®š `TIMEUNIT`
- å¦‚æœæ—¶é—´æˆ³å­—æ®µæ˜¯æ•´æ•°ç±»å‹ï¼ˆ`int64`ï¼‰ï¼Œ**å¿…é¡»**æŒ‡å®š `TIMEUNIT`
- é»˜è®¤å•ä½ä¸º `'ms'`ï¼ˆæ¯«ç§’ï¼‰

#### 3. MAXOUTOFORDERNESS - æœ€å¤§ä¹±åºæ—¶é—´é…ç½®

**ä½œç”¨**ï¼šè®¾ç½®å…è®¸çš„æœ€å¤§ä¹±åºæ—¶é—´ï¼Œç”¨äºè®¡ç®— Watermarkã€‚Watermark = max(event_time) - MaxOutOfOrdernessã€‚

**è¯­æ³•**ï¼š
```sql
WITH (MAXOUTOFORDERNESS = 'duration')
```

**æ”¯æŒçš„æ—¶é•¿æ ¼å¼**ï¼š
- `'5s'` - 5ç§’
- `'2m'` - 2åˆ†é’Ÿ
- `'1h'` - 1å°æ—¶
- `'500ms'` - 500æ¯«ç§’
- æ”¯æŒ Go çš„ `time.ParseDuration` æ ¼å¼

**ç¤ºä¾‹**ï¼š

```sql
-- å…è®¸5ç§’çš„ä¹±åºæ•°æ®
SELECT COUNT(*) FROM stream
GROUP BY TumblingWindow('5m')
WITH (TIMESTAMP = 'event_time', MAXOUTOFORDERNESS = '5s')

-- å…è®¸2åˆ†é’Ÿçš„ä¹±åºæ•°æ®
SELECT AVG(temperature) FROM stream
GROUP BY SlidingWindow('30s', '10s')
WITH (TIMESTAMP = 'timestamp', MAXOUTOFORDERNESS = '2m')
```

**é‡è¦è¯´æ˜**ï¼š
- ä»…ç”¨äºäº‹ä»¶æ—¶é—´çª—å£ï¼ˆéœ€è¦æŒ‡å®š `TIMESTAMP`ï¼‰
- å½±å“ Watermark çš„è®¡ç®—ï¼Œä»è€Œå½±å“çª—å£è§¦å‘æ—¶æœº
- é»˜è®¤å€¼ä¸º `0`ï¼ˆä¸å…è®¸ä¹±åºï¼‰
- è¾ƒå¤§çš„å€¼ä¼šå»¶è¿Ÿçª—å£è§¦å‘ï¼Œä½†èƒ½å®¹å¿æ›´å¤šä¹±åºæ•°æ®

**å·¥ä½œåŸç†**ï¼š
- Watermark = max(event_time) - MaxOutOfOrderness
- çª—å£åœ¨ `watermark >= window_end` æ—¶è§¦å‘
- ä¾‹å¦‚ï¼šMaxOutOfOrderness = 5sï¼Œå½“æœ€å¤§äº‹ä»¶æ—¶é—´æ˜¯ 10:10 æ—¶ï¼ŒWatermark = 10:05
- çª—å£ [10:00 - 10:05) ä¼šåœ¨ Watermark >= 10:05 æ—¶è§¦å‘ï¼ˆå®é™…å¯èƒ½æ˜¯ 10:10ï¼‰

#### 4. ALLOWEDLATENESS - å…è®¸å»¶è¿Ÿæ—¶é—´é…ç½®

**ä½œç”¨**ï¼šè®¾ç½®çª—å£è§¦å‘åè¿˜èƒ½æ¥å—å¤šé•¿æ—¶é—´çš„å»¶è¿Ÿæ•°æ®ã€‚çª—å£è§¦å‘åä¿æŒå¼€æ”¾ï¼Œç›´åˆ° `watermark >= window_end + AllowedLateness`ã€‚

**è¯­æ³•**ï¼š
```sql
WITH (ALLOWEDLATENESS = 'duration')
```

**æ”¯æŒçš„æ—¶é•¿æ ¼å¼**ï¼š
- `'2s'` - 2ç§’
- `'1m'` - 1åˆ†é’Ÿ
- `'30s'` - 30ç§’
- æ”¯æŒ Go çš„ `time.ParseDuration` æ ¼å¼

**ç¤ºä¾‹**ï¼š

```sql
-- çª—å£è§¦å‘åè¿˜èƒ½æ¥å—2ç§’çš„å»¶è¿Ÿæ•°æ®
SELECT COUNT(*) FROM stream
GROUP BY TumblingWindow('5m')
WITH (TIMESTAMP = 'event_time', ALLOWEDLATENESS = '2s')

-- çª—å£è§¦å‘åè¿˜èƒ½æ¥å—1åˆ†é’Ÿçš„å»¶è¿Ÿæ•°æ®
SELECT AVG(temperature) FROM stream
GROUP BY TumblingWindow('1m')
WITH (TIMESTAMP = 'timestamp', ALLOWEDLATENESS = '1m')
```

**é‡è¦è¯´æ˜**ï¼š
- ä»…ç”¨äºäº‹ä»¶æ—¶é—´çª—å£ï¼ˆéœ€è¦æŒ‡å®š `TIMESTAMP`ï¼‰
- çª—å£è§¦å‘åï¼Œä¼šä¿æŒå¼€æ”¾ç›´åˆ° `watermark >= window_end + AllowedLateness`
- åœ¨è¿™æ®µæ—¶é—´å†…åˆ°è¾¾çš„å»¶è¿Ÿæ•°æ®ä¼šè§¦å‘çª—å£çš„å»¶è¿Ÿæ›´æ–°ï¼ˆçª—å£å†æ¬¡è§¦å‘ï¼‰
- é»˜è®¤å€¼ä¸º `0`ï¼ˆçª—å£è§¦å‘åç«‹å³å…³é—­ï¼Œä¸æ¥å—å»¶è¿Ÿæ•°æ®ï¼‰
- ä¸»è¦ç”¨äºéœ€è¦æ›´æ–°å·²è§¦å‘çª—å£ç»“æœçš„åœºæ™¯

**å·¥ä½œåŸç†**ï¼š
- çª—å£ [10:00 - 10:05) åœ¨ `watermark >= 10:05` æ—¶è§¦å‘
- å¦‚æœ AllowedLateness = 2sï¼Œçª—å£ä¿æŒå¼€æ”¾ç›´åˆ° `watermark >= 10:07`
- å»¶è¿Ÿæ•°æ®ï¼ˆäº‹ä»¶æ—¶é—´åœ¨ [10:00 - 10:05) å†…ï¼‰åœ¨ `watermark < 10:07` æ—¶åˆ°è¾¾ï¼Œä¼šè§¦å‘çª—å£çš„å»¶è¿Ÿæ›´æ–°
- çª—å£ä¼šå†æ¬¡è§¦å‘ï¼Œè¾“å‡ºåŒ…å«å»¶è¿Ÿæ•°æ®çš„æ›´æ–°ç»“æœ
- è¶…è¿‡ AllowedLateness åï¼Œçª—å£å…³é—­ï¼Œå»¶è¿Ÿæ•°æ®è¢«å¿½ç•¥

#### 5. IDLETIMEOUT - ç©ºé—²è¶…æ—¶é…ç½®

**ä½œç”¨**ï¼šè®¾ç½®æ•°æ®æºç©ºé—²è¶…æ—¶æ—¶é—´ã€‚å½“æ•°æ®æºç©ºé—²ï¼ˆæ— æ–°æ•°æ®åˆ°è¾¾ï¼‰è¶…è¿‡è¯¥æ—¶é—´æ—¶ï¼ŒWatermark ä¼šåŸºäºå¤„ç†æ—¶é—´æ¨è¿›ï¼Œç¡®ä¿çª—å£èƒ½å¤Ÿå…³é—­ã€‚

**è¯­æ³•**ï¼š
```sql
WITH (IDLETIMEOUT = 'duration')
```

**æ”¯æŒçš„æ—¶é•¿æ ¼å¼**ï¼š
- `'5s'` - 5ç§’
- `'2m'` - 2åˆ†é’Ÿ
- `'1h'` - 1å°æ—¶
- `'500ms'` - 500æ¯«ç§’
- æ”¯æŒ Go çš„ `time.ParseDuration` æ ¼å¼

**ç¤ºä¾‹**ï¼š

```sql
-- é…ç½®ç©ºé—²è¶…æ—¶ï¼š5ç§’æ— æ•°æ®ï¼ŒåŸºäºå¤„ç†æ—¶é—´æ¨è¿›watermark
SELECT COUNT(*) FROM stream
GROUP BY TumblingWindow('5m')
WITH (TIMESTAMP = 'event_time', IDLETIMEOUT = '5s')

-- é…ç½®ç©ºé—²è¶…æ—¶ï¼š2åˆ†é’Ÿæ— æ•°æ®ï¼ŒåŸºäºå¤„ç†æ—¶é—´æ¨è¿›watermark
SELECT AVG(temperature) FROM stream
GROUP BY TumblingWindow('1m')
WITH (TIMESTAMP = 'timestamp', IDLETIMEOUT = '2m')
```

**é‡è¦è¯´æ˜**ï¼š
- ä»…ç”¨äºäº‹ä»¶æ—¶é—´çª—å£ï¼ˆéœ€è¦æŒ‡å®š `TIMESTAMP`ï¼‰
- é»˜è®¤å€¼ä¸º `0`ï¼ˆç¦ç”¨ï¼Œä¸å¯ç”¨ Idle Source æœºåˆ¶ï¼‰
- å½“æ•°æ®æºç©ºé—²è¶…è¿‡ IdleTimeout æ—¶ï¼ŒWatermark ä¼šåŸºäºå¤„ç†æ—¶é—´æ¨è¿›
- ç¡®ä¿çª—å£èƒ½å¤Ÿæœ€ç»ˆå…³é—­ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- ä¸»è¦ç”¨äºæ•°æ®æºå¯èƒ½åœæ­¢å‘é€æ•°æ®çš„åœºæ™¯

**å·¥ä½œåŸç†**ï¼š
- **æ­£å¸¸æƒ…å†µ**ï¼šWatermark åŸºäºäº‹ä»¶æ—¶é—´æ›´æ–°ï¼ˆ`Watermark = max(event_time) - MaxOutOfOrderness`ï¼‰
- **æ•°æ®æºç©ºé—²æ—¶**ï¼šå¦‚æœ `timeSinceLastEvent > IdleTimeout`ï¼ŒWatermark åŸºäºå¤„ç†æ—¶é—´æ¨è¿›ï¼ˆ`Watermark = currentProcessingTime - MaxOutOfOrderness`ï¼‰
- **çª—å£å…³é—­**ï¼šWatermark æ¨è¿›åï¼Œæ»¡è¶³æ¡ä»¶çš„çª—å£ä¼šè§¦å‘å¹¶å…³é—­

**ç¤ºä¾‹åœºæ™¯**ï¼š
```
æ—¶é—´è½´ï¼š
10:00 â†’ æ•°æ®A (eventTime=10:00)
10:01 â†’ æ•°æ®B (eventTime=10:01)
10:02 â†’ æ•°æ®C (eventTime=10:02)
10:03 â†’ æ²¡æœ‰æ–°æ•°æ®...
10:04 â†’ æ²¡æœ‰æ–°æ•°æ®...
10:05 â†’ æ²¡æœ‰æ–°æ•°æ®...

çª—å£1: [10:00, 10:02)

å½“å‰çŠ¶æ€ï¼ˆIdleTimeoutæœªå¯ç”¨ï¼‰ï¼š
- maxEventTime = 10:02ï¼ˆæœ€åä¸€æ¡æ•°æ®ï¼‰
- watermark = 10:02 - 1ç§’ = 10:01
- çª—å£1æ— æ³•è§¦å‘ï¼ˆwatermark < 10:02ï¼‰
- çª—å£æ°¸è¿œä¸ä¼šå…³é—­ âŒ

å½“å‰çŠ¶æ€ï¼ˆIdleTimeout=2så¯ç”¨ï¼‰ï¼š
- maxEventTime = 10:02
- 10:05æ—¶ï¼ŒtimeSinceLastEvent = 3ç§’ > 2ç§’ï¼ˆIdleTimeoutï¼‰
- watermark = å½“å‰å¤„ç†æ—¶é—´(10:05) - 1ç§’ = 10:04
- çª—å£1å¯ä»¥è§¦å‘ï¼ˆwatermark >= 10:02ï¼‰âœ…
- çª—å£èƒ½å¤Ÿå…³é—­ âœ…
```

### å®Œæ•´ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šè®¢å•æµç»Ÿè®¡ï¼ˆäº‹ä»¶æ—¶é—´ï¼‰

```sql
-- è®¢å•æµï¼šä½¿ç”¨ order_time ä½œä¸ºäº‹ä»¶æ—¶é—´
-- å³ä½¿è®¢å•åœ¨ 11:00 æ‰åˆ°è¾¾ï¼Œåªè¦ order_time æ˜¯ 10:03ï¼Œå°±ä¼šç»Ÿè®¡åˆ° 10:00~10:05 çš„çª—å£
SELECT 
    COUNT(*) as order_count,
    SUM(amount) as total_amount,
    AVG(amount) as avg_amount
FROM stream
GROUP BY TumblingWindow('5m')
WITH (TIMESTAMP = 'order_time')
```

#### ç¤ºä¾‹2ï¼šè®¢å•æµç»Ÿè®¡ï¼ˆå¤„ç†æ—¶é—´ï¼‰

```sql
-- è®¢å•æµï¼šä½¿ç”¨å¤„ç†æ—¶é—´
-- åœ¨ 11:00~11:05 åˆ°è¾¾çš„æ‰€æœ‰è®¢å•ï¼Œä¸ç®¡ order_time æ˜¯å¤šå°‘ï¼Œéƒ½ç»Ÿè®¡åˆ° 11:00~11:05 çš„çª—å£
SELECT 
    COUNT(*) as order_count,
    SUM(amount) as total_amount
FROM stream
GROUP BY TumblingWindow('5m')
-- ä¸æŒ‡å®š WITH (TIMESTAMP=...)ï¼Œé»˜è®¤ä½¿ç”¨å¤„ç†æ—¶é—´
```

### é…ç½®é¡¹

| é…ç½®é¡¹ | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ | å¿…éœ€ |
|--------|------|------|--------|------|
| `TIMESTAMP` | string | äº‹ä»¶æ—¶é—´å­—æ®µå | æ— ï¼ˆä½¿ç”¨å¤„ç†æ—¶é—´ï¼‰ | å¦ |
| `TIMEUNIT` | string | æ—¶é—´å•ä½ï¼ˆä»…æ•´æ•°æ—¶é—´æˆ³éœ€è¦ï¼‰ | `'ms'` | å¦ |
| `MAXOUTOFORDERNESS` | string | æœ€å¤§ä¹±åºæ—¶é—´ï¼ˆä»…äº‹ä»¶æ—¶é—´çª—å£ï¼‰ | `'0s'` | å¦ |
| `ALLOWEDLATENESS` | string | å…è®¸å»¶è¿Ÿæ—¶é—´ï¼ˆä»…äº‹ä»¶æ—¶é—´çª—å£ï¼‰ | `'0s'` | å¦ |
| `IDLETIMEOUT` | string | ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ˆä»…äº‹ä»¶æ—¶é—´çª—å£ï¼‰ | `'0s'`ï¼ˆç¦ç”¨ï¼‰ | å¦ |

### é…ç½®é¡¹è¯´æ˜

#### MaxOutOfOrderness vs AllowedLateness

è¿™ä¸¤ä¸ªé…ç½®éƒ½ç”¨äºå¤„ç†å»¶è¿Ÿæ•°æ®ï¼Œä½†ä½œç”¨é˜¶æ®µä¸åŒï¼š

| ç‰¹æ€§ | MaxOutOfOrderness | AllowedLateness |
|------|-------------------|-----------------|
| **ä½œç”¨é˜¶æ®µ** | çª—å£è§¦å‘å‰ | çª—å£è§¦å‘å |
| **å½±å“å¯¹è±¡** | Watermark è®¡ç®— | çª—å£å…³é—­æ—¶é—´ |
| **ç›®çš„** | å®¹å¿ä¹±åºï¼Œå»¶è¿Ÿçª—å£è§¦å‘ | æ¥å—å»¶è¿Ÿæ•°æ®ï¼Œæ›´æ–°å·²è§¦å‘çª—å£ |
| **è®¡ç®—å…¬å¼** | `Watermark = max(event_time) - MaxOutOfOrderness` | `çª—å£å…³é—­æ—¶é—´ = window_end + AllowedLateness` |
| **ä½¿ç”¨åœºæ™¯** | æ•°æ®å¯èƒ½ä¹±åºåˆ°è¾¾ | çª—å£å·²è§¦å‘ï¼Œä½†ä»æœ‰å»¶è¿Ÿæ•°æ®å¯èƒ½åˆ°è¾¾ |

**ç»„åˆä½¿ç”¨ç¤ºä¾‹**ï¼š

```sql
-- åŒæ—¶é…ç½®æœ€å¤§ä¹±åºæ—¶é—´ã€å…è®¸å»¶è¿Ÿæ—¶é—´å’Œç©ºé—²è¶…æ—¶
SELECT COUNT(*) as order_count
FROM stream
GROUP BY TumblingWindow('5m')
WITH (
    TIMESTAMP = 'order_time',
    MAXOUTOFORDERNESS = '5s',  -- å®¹å¿5ç§’çš„ä¹±åº
    ALLOWEDLATENESS = '2s',    -- çª—å£è§¦å‘åè¿˜èƒ½æ¥å—2ç§’çš„å»¶è¿Ÿæ•°æ®
    IDLETIMEOUT = '5s'         -- 5ç§’æ— æ•°æ®ï¼ŒåŸºäºå¤„ç†æ—¶é—´æ¨è¿›watermark
)
```

**å·¥ä½œæµç¨‹**ï¼š
1. MaxOutOfOrderness = 5sï¼šWatermark å»¶è¿Ÿ5ç§’æ¨è¿›ï¼Œçª—å£åœ¨ watermark >= window_end æ—¶è§¦å‘
2. AllowedLateness = 2sï¼šçª—å£è§¦å‘åï¼Œä¿æŒå¼€æ”¾2ç§’ï¼Œæ¥å—å»¶è¿Ÿæ•°æ®å¹¶æ›´æ–°ç»“æœ
3. è¶…è¿‡ AllowedLateness åï¼Œçª—å£å…³é—­ï¼Œå»¶è¿Ÿæ•°æ®è¢«å¿½ç•¥
4. IdleTimeout = 5sï¼šå¦‚æœæ•°æ®æºç©ºé—²è¶…è¿‡5ç§’ï¼ŒWatermark åŸºäºå¤„ç†æ—¶é—´æ¨è¿›ï¼Œç¡®ä¿çª—å£èƒ½å¤Ÿå…³é—­

**ä¸‰ä¸ªé…ç½®çš„å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | MaxOutOfOrderness | AllowedLateness | IdleTimeout |
|------|-------------------|-----------------|-------------|
| **ä½œç”¨é˜¶æ®µ** | çª—å£è§¦å‘å‰ | çª—å£è§¦å‘å | æ•°æ®æºç©ºé—²æ—¶ |
| **å½±å“å¯¹è±¡** | Watermark è®¡ç®— | çª—å£å…³é—­æ—¶é—´ | Watermark æ¨è¿›æ–¹å¼ |
| **ç›®çš„** | å®¹å¿ä¹±åºï¼Œå»¶è¿Ÿçª—å£è§¦å‘ | æ¥å—å»¶è¿Ÿæ•°æ®ï¼Œæ›´æ–°å·²è§¦å‘çª—å£ | ç¡®ä¿çª—å£èƒ½å¤Ÿå…³é—­ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ |
| **è®¡ç®—å…¬å¼** | `Watermark = max(event_time) - MaxOutOfOrderness` | `çª—å£å…³é—­æ—¶é—´ = window_end + AllowedLateness` | `Watermark = currentProcessingTime - MaxOutOfOrderness`ï¼ˆå½“ç©ºé—²æ—¶ï¼‰ |
| **ä½¿ç”¨åœºæ™¯** | æ•°æ®å¯èƒ½ä¹±åºåˆ°è¾¾ | çª—å£å·²è§¦å‘ï¼Œä½†ä»æœ‰å»¶è¿Ÿæ•°æ®å¯èƒ½åˆ°è¾¾ | æ•°æ®æºå¯èƒ½åœæ­¢å‘é€æ•°æ® |


## æ•°æ®ç±»å‹å’Œå¸¸é‡

### æ•°å€¼å¸¸é‡
```sql
SELECT 42, 3.14, -10.5, 1e6 FROM stream
```

### å­—ç¬¦ä¸²å¸¸é‡ 
```sql
SELECT 'hello', "world", 'it''s ok' FROM stream
```

### å¸ƒå°”å¸¸é‡
```sql
SELECT true, false, temperature > 25 FROM stream  
```

### NULLå€¼
```sql
SELECT NULL, temperature IS NULL FROM stream
```

## è¡¨è¾¾å¼å’Œæ“ä½œç¬¦

### ç®—æœ¯æ“ä½œç¬¦

| æ“ä½œç¬¦ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `+` | åŠ æ³• | `temperature + 10` |
| `-` | å‡æ³• | `temperature - 5` |
| `*` | ä¹˜æ³• | `temperature * 1.8` |
| `/` | é™¤æ³• | `total / count` |
| `%` | å–æ¨¡ | `id % 10` |

### å­—ç¬¦ä¸²æ“ä½œ
```sql
-- å­—ç¬¦ä¸²è¿æ¥
SELECT deviceId + '_' + status FROM stream
SELECT CONCAT(deviceId, '_', status) FROM stream

-- å­—ç¬¦ä¸²å‡½æ•°
SELECT UPPER(status), LOWER(location), LENGTH(deviceId) FROM stream
```

### æ¡ä»¶è¡¨è¾¾å¼

#### CASEè¡¨è¾¾å¼
```sql
-- ç®€å•CASE
SELECT deviceId,
       CASE status
           WHEN 'active' THEN 1
           WHEN 'inactive' THEN 0  
           ELSE -1
       END as status_code
FROM stream

-- æœç´¢CASE
SELECT deviceId,
       CASE 
           WHEN temperature > 30 THEN 'HOT'
           WHEN temperature > 20 THEN 'WARM'
           WHEN temperature > 10 THEN 'COOL'
           ELSE 'COLD'
       END as temp_category  
FROM stream
```

## å†…ç½®å‡½æ•°

### èšåˆå‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `COUNT(*)` | è®¡æ•° | `COUNT(*)` |
| `SUM(expr)` | æ±‚å’Œ | `SUM(temperature)` |
| `AVG(expr)` | å¹³å‡å€¼ | `AVG(temperature)` |
| `MIN(expr)` | æœ€å°å€¼ | `MIN(temperature)` |
| `MAX(expr)` | æœ€å¤§å€¼ | `MAX(temperature)` |
| `STDDEV(expr)` | æ ‡å‡†å·® | `STDDEV(temperature)` |
| `MEDIAN(expr)` | ä¸­ä½æ•° | `MEDIAN(temperature)` |

### æ•°å­¦å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `ABS(x)` | ç»å¯¹å€¼ | `ABS(temperature)` |
| `ROUND(x, d)` | å››èˆäº”å…¥ | `ROUND(temperature, 2)` |
| `FLOOR(x)` | å‘ä¸‹å–æ•´ | `FLOOR(temperature)` |
| `CEIL(x)` | å‘ä¸Šå–æ•´ | `CEIL(temperature)` |
| `SQRT(x)` | å¹³æ–¹æ ¹ | `SQRT(area)` |
| `POWER(x, y)` | å¹‚è¿ç®— | `POWER(distance, 2)` |

### å­—ç¬¦ä¸²å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `CONCAT(s1, s2, ...)` | å­—ç¬¦ä¸²è¿æ¥ | `CONCAT(first, '_', last)` |
| `UPPER(s)` | è½¬å¤§å†™ | `UPPER(status)` |
| `LOWER(s)` | è½¬å°å†™ | `LOWER(deviceId)` |
| `LENGTH(s)` | å­—ç¬¦ä¸²é•¿åº¦ | `LENGTH(message)` |
| `SUBSTRING(s, start, len)` | å­å­—ç¬¦ä¸² | `SUBSTRING(deviceId, 1, 5)` |
| `TRIM(s)` | å»é™¤ç©ºç™½ | `TRIM(name)` |

### æ—¶é—´å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `window_start()` | çª—å£å¼€å§‹æ—¶é—´ | `window_start()` |
| `window_end()` | çª—å£ç»“æŸæ—¶é—´ | `window_end()` |
| `NOW()` | å½“å‰æ—¶é—´ | `NOW()` |

### ç±»å‹è½¬æ¢å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `CAST(expr AS type)` | ç±»å‹è½¬æ¢ | `CAST(temperature AS STRING)` |

## å®Œæ•´ç¤ºä¾‹

### 1. åŸºç¡€æŸ¥è¯¢
```sql
-- ç®€å•è¿‡æ»¤
SELECT deviceId, temperature, status 
FROM stream 
WHERE temperature > 25 AND status = 'active'
```

### 2. èšåˆåˆ†æ
```sql
-- è®¾å¤‡æ¸©åº¦ç»Ÿè®¡
SELECT deviceId,
       COUNT(*) as sample_count,
       AVG(temperature) as avg_temp,
       MIN(temperature) as min_temp,
       MAX(temperature) as max_temp,
       STDDEV(temperature) as temp_stddev
FROM stream
WHERE temperature IS NOT NULL
GROUP BY deviceId, TumblingWindow('5m')
HAVING sample_count >= 10
```

### 3. å¤æ‚è¡¨è¾¾å¼
```sql
-- æ¸©åº¦å¼‚å¸¸æ£€æµ‹
SELECT deviceId,
       temperature,
       ABS(temperature - AVG(temperature)) as deviation,
       CASE 
           WHEN ABS(temperature - AVG(temperature)) > 2 * STDDEV(temperature) 
           THEN 'ANOMALY'
           ELSE 'NORMAL'
       END as anomaly_status
FROM stream
GROUP BY deviceId, SlidingWindow('10m', '1m')
```

### 4. å¤šçª—å£åˆ†æ
```sql
-- å¤šå±‚çº§æ—¶é—´åˆ†æ
SELECT deviceId,
       '1m' as window_type,
       AVG(temperature) as avg_temp,
       window_start() as start_time
FROM stream
GROUP BY deviceId, TumblingWindow('1m')

UNION ALL

SELECT deviceId,
       '5m' as window_type, 
       AVG(temperature) as avg_temp,
       window_start() as start_time
FROM stream  
GROUP BY deviceId, TumblingWindow('5m')
```

::: warning æ³¨æ„
ä¸Šè¿°UNION ALLç¤ºä¾‹ä»…ä¸ºè¯­æ³•å±•ç¤ºï¼ŒStreamSQLå½“å‰ä¸æ”¯æŒUNIONæ“ä½œã€‚
:::

## è¯­æ³•é™åˆ¶

### ä¸æ”¯æŒçš„ç‰¹æ€§

- `JOIN` æ“ä½œï¼ˆå¤šè¡¨è¿æ¥ï¼‰
- `UNION` æ“ä½œï¼ˆç»“æœåˆå¹¶ï¼‰  
- `å­æŸ¥è¯¢` ï¼ˆåµŒå¥—SELECTï¼‰
- `INSERT/UPDATE/DELETE` ï¼ˆæ•°æ®ä¿®æ”¹ï¼‰
- `CREATE TABLE` ï¼ˆè¡¨å®šä¹‰ï¼‰
- `è§†å›¾` ï¼ˆVIEWï¼‰
- `å­˜å‚¨è¿‡ç¨‹` ï¼ˆPROCEDUREï¼‰
- `è§¦å‘å™¨` ï¼ˆTRIGGERï¼‰

### é™åˆ¶è¯´æ˜

1. **å•æ•°æ®æº**ï¼šåªæ”¯æŒå•ä¸ªæ•°æ®æµå¤„ç†
2. **æ— æŒä¹…åŒ–**ï¼šä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–å­˜å‚¨
3. **æ— äº‹åŠ¡**ï¼šä¸æ”¯æŒäº‹åŠ¡æ“ä½œ
4. **å†…å­˜é™åˆ¶**ï¼šå—é™äºå•æœºå†…å­˜å®¹é‡

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. WHEREå­å¥ä¼˜åŒ–
```sql
-- å¥½çš„å®è·µï¼šæ—©æœŸè¿‡æ»¤
SELECT deviceId, AVG(temperature) 
FROM stream
WHERE temperature BETWEEN 0 AND 100  -- å…ˆè¿‡æ»¤å¼‚å¸¸æ•°æ®
GROUP BY deviceId, TumblingWindow('5m')

-- é¿å…ï¼šå¤æ‚WHEREæ¡ä»¶
WHERE UPPER(CONCAT(deviceId, status)) LIKE '%ACTIVE%'
```

### 2. åˆç†ä½¿ç”¨çª—å£
```sql
-- å¥½çš„å®è·µï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çª—å£
GROUP BY TumblingWindow('1m')    -- éœ€è¦ç²¾ç¡®å‘¨æœŸç»Ÿè®¡
GROUP BY SlidingWindow('5m', '1m') -- éœ€è¦å¹³æ»‘åˆ†æ

-- é¿å…ï¼šè¿‡å°çš„çª—å£é—´éš”
GROUP BY SlidingWindow('1h', '1s')   -- è®¡ç®—å¼€é”€å·¨å¤§
```

### 3. è¡¨è¾¾å¼ä¼˜åŒ–
```sql
-- å¥½çš„å®è·µï¼šç®€å•è¡¨è¾¾å¼
SELECT temperature * 1.8 + 32 as fahrenheit

-- é¿å…ï¼šå¤æ‚åµŒå¥—è¡¨è¾¾å¼  
SELECT POWER(SQRT(ABS(temperature - AVG(temperature))), 2)
```
