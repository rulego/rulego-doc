---
title: SQLå‚è€?
date: 2024-01-15 10:04:00
permalink: /pages/streamsql/04/
article: false
author: 
  name: StreamSQL
  link: https://github.com/rulego/streamsql
---

# SQLå‚è€?

æœ¬ç« æä¾›StreamSQLæ”¯æŒçš„å®Œæ•´SQLè¯­æ³•å‚è€ƒï¼ŒåŒ…æ‹¬æ‰€æœ‰æ”¯æŒçš„å­å¥ã€å‡½æ•°å’Œæ“ä½œç¬¦ã€?

## ğŸ“‹ SQLè¯­æ³•æ¦‚è§ˆ

StreamSQLæ”¯æŒæ ‡å‡†SQLè¯­æ³•çš„å­é›†ï¼Œä¸“é—¨é’ˆå¯¹æµå¤„ç†è¿›è¡Œäº†ä¼˜åŒ–ï¼?

```sql
SELECT [DISTINCT] select_list
FROM stream
[WHERE condition]
[GROUP BY grouping_element [, ...]]
[HAVING condition]
[LIMIT count]
[WITH (option = value [, ...])]
```

StreamSQLæ”¯æŒæ ‡å‡†SQLè¯­æ³•çš„å­é›†ï¼Œä¸“é—¨é’ˆå¯¹æµå¤„ç†åœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚æœ¬ç« æä¾›å®Œæ•´çš„SQLè¯­æ³•å‚è€ƒã€?

## SQLè¯­æ³•æ¦‚è§ˆ

### åŸºæœ¬æŸ¥è¯¢ç»“æ„

```sql
SELECT [DISTINCT] select_list
FROM stream_name
[WHERE condition]
[GROUP BY grouping_list]
[HAVING condition]
[ORDER BY ordering_list]
[LIMIT number]
[WITH (option_list)]
```

### æ”¯æŒçš„å­å?

| å­å¥ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|
| SELECT | âœ?| æŒ‡å®šè¾“å‡ºå­—æ®µ |
| FROM | âœ?| æŒ‡å®šæ•°æ®æº?|
| WHERE | â?| è¿‡æ»¤æ¡ä»¶ |
| GROUP BY | â?| åˆ†ç»„å’Œçª—å?|
| HAVING | â?| èšåˆç»“æœè¿‡æ»¤ |
| ORDER BY | â?| æ’åºï¼ˆæœ‰é™æ”¯æŒï¼‰ |
| LIMIT | â?| é™åˆ¶ç»“æœæ•°é‡ |
| WITH | â?| é…ç½®é€‰é¡¹ |

## SELECT å­å¥

SELECTå­å¥å®šä¹‰æŸ¥è¯¢çš„è¾“å‡ºå­—æ®µå’Œè®¡ç®—è¡¨è¾¾å¼ã€?

### åŸºæœ¬è¯­æ³•

```sql
SELECT column1, column2, expression AS alias
FROM stream
```

### æ”¯æŒçš„é€‰æ‹©ç±»å‹

#### 1. å­—æ®µé€‰æ‹©

```sql
-- é€‰æ‹©æ‰€æœ‰å­—æ®?
SELECT * FROM stream

-- é€‰æ‹©ç‰¹å®šå­—æ®µ
SELECT deviceId, temperature FROM stream

-- å­—æ®µåˆ«å
SELECT deviceId AS device, temperature AS temp FROM stream
```

#### 2. åµŒå¥—å­—æ®µè®¿é—®

```sql
-- ç‚¹å·è¯­æ³•è®¿é—®åµŒå¥—å­—æ®µ
SELECT device.info.name, device.location.building FROM stream

-- æ·±å±‚åµŒå¥—
SELECT sensor.data.temperature.value FROM stream
```

#### 3. è¡¨è¾¾å¼è®¡ç®?

```sql
-- ç®—æœ¯è¡¨è¾¾å¼?
SELECT temperature * 1.8 + 32 AS fahrenheit FROM stream

-- å­—ç¬¦ä¸²è¿æ?
SELECT CONCAT(deviceId, '-', location) AS full_id FROM stream

-- æ¡ä»¶è¡¨è¾¾å¼?
SELECT CASE 
    WHEN temperature > 30 THEN 'hot'
    WHEN temperature < 10 THEN 'cold'
    ELSE 'normal'
END AS temp_level FROM stream
```

#### 4. èšåˆå‡½æ•°

```sql
-- åŸºç¡€èšåˆ
SELECT COUNT(*), AVG(temperature), MAX(humidity) FROM stream

-- å¸¦åˆ†ç»„çš„èšåˆ
SELECT deviceId, AVG(temperature) FROM stream GROUP BY deviceId
```

### DISTINCT å»é‡

```sql
-- å»é‡æŸ¥è¯¢
SELECT DISTINCT deviceType FROM stream

-- å¤šå­—æ®µå»é‡?
SELECT DISTINCT deviceId, location FROM stream
```

### åŸºæœ¬è¯­æ³•

```sql
SELECT column1, column2, ...
SELECT expression AS alias
SELECT *
SELECT DISTINCT column1
```

### å­—æ®µé€‰æ‹©

#### 1. ç›´æ¥å­—æ®µå¼•ç”¨
```sql
-- é€‰æ‹©ç‰¹å®šå­—æ®µ
SELECT deviceId, temperature, humidity FROM stream

-- é€‰æ‹©æ‰€æœ‰å­—æ®? 
SELECT * FROM stream
```

#### 2. è¡¨è¾¾å¼è®¡ç®?
```sql
-- ç®—æœ¯è¡¨è¾¾å¼?
SELECT deviceId, temperature * 1.8 + 32 as fahrenheit FROM stream

-- å­—ç¬¦ä¸²è¿æ?
SELECT CONCAT(deviceId, '_', status) as device_status FROM stream

-- æ¡ä»¶è¡¨è¾¾å¼?
SELECT deviceId,
       CASE 
           WHEN temperature > 30 THEN 'HIGH'
           WHEN temperature > 20 THEN 'NORMAL' 
           ELSE 'LOW'
       END as temp_level
FROM stream
```

#### 3. å‡½æ•°è°ƒç”¨
```sql
-- å†…ç½®å‡½æ•°
SELECT deviceId, UPPER(status), ABS(temperature) FROM stream

-- èšåˆå‡½æ•°
SELECT deviceId, AVG(temperature), COUNT(*) FROM stream
GROUP BY deviceId, TumblingWindow('1m')

-- è‡ªå®šä¹‰å‡½æ•?
SELECT deviceId, custom_function(temperature) FROM stream
```

### åˆ«å (AS)

```sql
-- å­—æ®µåˆ«å
SELECT temperature AS temp, humidity AS hum FROM stream

-- è¡¨è¾¾å¼åˆ«å? 
SELECT temperature * 1.8 + 32 AS fahrenheit FROM stream

-- ASå…³é”®å­—å¯çœç•¥
SELECT temperature temp, humidity hum FROM stream
```

### DISTINCT

```sql
-- å»é‡ï¼ˆåœ¨çª—å£èšåˆä¸­ä½¿ç”¨ï¼‰
SELECT DISTINCT deviceId, location 
FROM stream 
GROUP BY TumblingWindow('1m')
```

## FROM å­å¥

FROMå­å¥æŒ‡å®šæ•°æ®æºï¼Œåœ¨StreamSQLä¸­é€šå¸¸æ˜?`stream`ã€?

### åŸºæœ¬è¯­æ³•

```sql
SELECT * FROM stream
```

### æ•°æ®æºç±»å?

- **stream**: é»˜è®¤çš„æµæ•°æ®æº?
- æœªæ¥ç‰ˆæœ¬å¯èƒ½æ”¯æŒå¤šä¸ªå‘½åæµ?

```sql
-- å½“å‰æ”¯æŒ
SELECT * FROM stream

-- æœªæ¥å¯èƒ½æ”¯æŒ
SELECT * FROM sensor_stream
SELECT * FROM device_stream
```

### æ•°æ®æºæŒ‡å®?

```sql
-- æ ‡å‡†æ•°æ®æºåç§?
FROM stream

-- è‡ªå®šä¹‰æ•°æ®æºåç§°
FROM sensor_data
FROM device_stream
```

::: tip æç¤º
FROMå­å¥ä¸­çš„åç§°æ˜¯é€»è¾‘æ¦‚å¿µï¼Œå®é™…æ•°æ®é€šè¿‡ `AddData()` æ–¹æ³•è¾“å…¥ã€?
:::

## WHERE å­å¥

WHEREå­å¥ç”¨äºè¿‡æ»¤æ•°æ®ï¼Œåªå¤„ç†æ»¡è¶³æ¡ä»¶çš„è®°å½•ã€?

### åŸºæœ¬è¯­æ³•

```sql
SELECT * FROM stream WHERE condition
```

### æ”¯æŒçš„æ¡ä»¶ç±»å?

#### 1. æ¯”è¾ƒæ“ä½œç¬?

```sql
-- æ•°å€¼æ¯”è¾?
SELECT * FROM stream WHERE temperature > 25
SELECT * FROM stream WHERE humidity <= 60
SELECT * FROM stream WHERE pressure = 1013.25
SELECT * FROM stream WHERE voltage != 0

-- å­—ç¬¦ä¸²æ¯”è¾?
SELECT * FROM stream WHERE deviceId = 'sensor001'
SELECT * FROM stream WHERE location != 'offline'
```

#### 2. é€»è¾‘æ“ä½œç¬?

```sql
-- AND æ“ä½œ
SELECT * FROM stream WHERE temperature > 20 AND humidity < 80

-- OR æ“ä½œ
SELECT * FROM stream WHERE deviceType = 'temperature' OR deviceType = 'humidity'

-- NOT æ“ä½œ
SELECT * FROM stream WHERE NOT (temperature < 0)

-- å¤åˆæ¡ä»¶
SELECT * FROM stream WHERE (temperature > 30 OR humidity > 90) AND deviceId LIKE 'sensor%'
```

#### 3. èŒƒå›´æ“ä½œ

```sql
-- BETWEEN èŒƒå›´
SELECT * FROM stream WHERE temperature BETWEEN 20 AND 30

-- IN åˆ—è¡¨
SELECT * FROM stream WHERE deviceType IN ('temperature', 'humidity', 'pressure')

-- NOT IN
SELECT * FROM stream WHERE deviceId NOT IN ('test001', 'test002')
```

#### 4. æ¨¡å¼åŒ¹é…

```sql
-- LIKE æ¨¡å¼åŒ¹é…
SELECT * FROM stream WHERE deviceId LIKE 'sensor%'  -- ä»¥sensorå¼€å¤?
SELECT * FROM stream WHERE location LIKE '%room%'   -- åŒ…å«room
SELECT * FROM stream WHERE deviceId LIKE 'dev___'   -- devåè·Ÿ3ä¸ªå­—ç¬?

-- å­—ç¬¦ä¸²å‡½æ•?
SELECT * FROM stream WHERE STARTSWITH(deviceId, 'sensor')
SELECT * FROM stream WHERE ENDSWITH(location, 'floor')
SELECT * FROM stream WHERE CONTAINS(description, 'temperature')
```

#### 5. NULL æ£€æŸ?

```sql
-- NULL æ£€æŸ?
SELECT * FROM stream WHERE temperature IS NOT NULL
SELECT * FROM stream WHERE error_msg IS NULL

-- ç©ºå­—ç¬¦ä¸²æ£€æŸ?
SELECT * FROM stream WHERE deviceId != ''
SELECT * FROM stream WHERE TRIM(location) != ''
```

#### 6. åµŒå¥—å­—æ®µæ¡ä»¶

```sql
-- åµŒå¥—å­—æ®µè¿‡æ»¤
SELECT * FROM stream WHERE device.info.status = 'active'
SELECT * FROM stream WHERE sensor.data.temperature > 25
SELECT * FROM stream WHERE config.settings.enabled = true
```

### è¿‡æ»¤æ¡ä»¶

#### 1. æ¯”è¾ƒæ“ä½œ
```sql
-- æ•°å€¼æ¯”è¾?
WHERE temperature > 25
WHERE humidity BETWEEN 30 AND 70
WHERE pressure != 1013.25

-- å­—ç¬¦ä¸²æ¯”è¾? 
WHERE deviceId = 'sensor001'
WHERE status IN ('active', 'online')
WHERE location LIKE 'building_%'
```

#### 2. é€»è¾‘æ“ä½œ
```sql
-- é€»è¾‘ç»„åˆ
WHERE temperature > 25 AND humidity < 60
WHERE status = 'active' OR status = 'standby'
WHERE NOT (temperature < 0)

-- ç©ºå€¼æ£€æŸ?
WHERE temperature IS NOT NULL
WHERE deviceId IS NULL
```

#### 3. å¤æ‚æ¡ä»¶
```sql
-- åµŒå¥—æ¡ä»¶
WHERE (temperature > 30 AND humidity > 80) 
   OR (temperature < 0 AND pressure > 1020)

-- å‡½æ•°æ¡ä»¶
WHERE ABS(temperature - 25) > 5
WHERE LENGTH(deviceId) > 10
```

### æ”¯æŒçš„æ“ä½œç¬¦

| æ“ä½œç¬?| è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `=` | ç­‰äº | `temperature = 25` |
| `!=`, `<>` | ä¸ç­‰äº?| `status != 'offline'` |
| `>`, `>=` | å¤§äºã€å¤§äºç­‰äº?| `humidity > 50` |
| `<`, `<=` | å°äºã€å°äºç­‰äº?| `pressure <= 1000` |
| `BETWEEN` | èŒƒå›´ | `temperature BETWEEN 20 AND 30` |
| `IN` | åŒ…å« | `status IN ('on', 'off')` |
| `LIKE` | æ¨¡å¼åŒ¹é… | `name LIKE 'sensor%'` |
| `IS NULL` | ç©ºå€¼æ£€æŸ?| `value IS NULL` |
| `AND` | é€»è¾‘ä¸?| `temp > 20 AND humid < 60` |
| `OR` | é€»è¾‘æˆ?| `status = 'on' OR status = 'ready'` |
| `NOT` | é€»è¾‘é?| `NOT (temperature < 0)` |

## GROUP BY å­å¥

GROUP BYå­å¥ç”¨äºæ•°æ®åˆ†ç»„å’Œçª—å£å®šä¹‰ï¼Œæ˜¯æµå¤„ç†ä¸­çš„æ ¸å¿ƒåŠŸèƒ½ã€?

### åŸºæœ¬è¯­æ³•

```sql
SELECT aggregate_function(column)
FROM stream
GROUP BY grouping_columns [, window_function]
```

### åˆ†ç»„ç±»å‹

#### 1. å­—æ®µåˆ†ç»„

```sql
-- å•å­—æ®µåˆ†ç»?
SELECT deviceId, COUNT(*) FROM stream GROUP BY deviceId

-- å¤šå­—æ®µåˆ†ç»?
SELECT deviceId, location, AVG(temperature) 
FROM stream 
GROUP BY deviceId, location

-- è¡¨è¾¾å¼åˆ†ç»?
SELECT HOUR(timestamp) as hour, COUNT(*) 
FROM stream 
GROUP BY HOUR(timestamp)
```

#### 2. çª—å£åˆ†ç»„

##### æ»šåŠ¨çª—å£ (Tumbling Window)

```sql
-- æ—¶é—´æ»šåŠ¨çª—å£
SELECT COUNT(*) FROM stream GROUP BY TumblingWindow('5s')
SELECT AVG(temperature) FROM stream GROUP BY TumblingWindow('1m')
SELECT SUM(value) FROM stream GROUP BY TumblingWindow('1h')

-- å¸¦å­—æ®µåˆ†ç»„çš„æ»šåŠ¨çª—å£
SELECT deviceId, AVG(temperature) 
FROM stream 
GROUP BY deviceId, TumblingWindow('5s')
```

##### æ»‘åŠ¨çª—å£ (Sliding Window)

```sql
-- æ»‘åŠ¨çª—å£ï¼šçª—å£å¤§å°ï¼Œæ»‘åŠ¨é—´éš”
SELECT AVG(temperature) FROM stream GROUP BY SlidingWindow('30s', '10s')
SELECT MAX(pressure) FROM stream GROUP BY SlidingWindow('1m', '30s')

-- å¸¦åˆ†ç»„çš„æ»‘åŠ¨çª—å£
SELECT deviceId, AVG(temperature) 
FROM stream 
GROUP BY deviceId, SlidingWindow('30s', '10s')
```

##### è®¡æ•°çª—å£ (Counting Window)

```sql
-- æ¯Næ¡è®°å½•è§¦å‘ä¸€æ¬?
SELECT COUNT(*) FROM stream GROUP BY CountingWindow(100)
SELECT AVG(value) FROM stream GROUP BY CountingWindow(50)

-- å¸¦åˆ†ç»„çš„è®¡æ•°çª—å£
SELECT deviceId, COUNT(*) 
FROM stream 
GROUP BY deviceId, CountingWindow(10)
```

##### ä¼šè¯çª—å£ (Session Window)

```sql
-- ä¼šè¯è¶…æ—¶çª—å£
SELECT userId, COUNT(*) FROM stream GROUP BY userId, SessionWindow('5m')
SELECT deviceId, SUM(events) FROM stream GROUP BY deviceId, SessionWindow('30s')
```

### çª—å£å‡½æ•°

åœ¨GROUP BYä¸­å¯ä»¥ä½¿ç”¨çª—å£ç›¸å…³çš„å‡½æ•°ï¼?

```sql
SELECT deviceId,
       COUNT(*) as event_count,
       window_start() as start_time,
       window_end() as end_time,
       window_duration() as duration
FROM stream 
GROUP BY deviceId, TumblingWindow('5s')
```

### åˆ†ç»„å­—æ®µ

```sql
-- å•å­—æ®µåˆ†ç»?
GROUP BY deviceId

-- å¤šå­—æ®µåˆ†ç»? 
GROUP BY deviceId, location, status

-- è¡¨è¾¾å¼åˆ†ç»?
GROUP BY FLOOR(temperature / 10) * 10  -- æŒ‰æ¸©åº¦åŒºé—´åˆ†ç»?
```

### çª—å£å‡½æ•°

#### 1. æ»šåŠ¨çª—å£ (TumblingWindow)
```sql
-- åŸºæœ¬è¯­æ³•
GROUP BY deviceId, TumblingWindow('5m')

-- æ”¯æŒçš„æ—¶é—´å•ä½?
GROUP BY TumblingWindow('30s')   -- 30ç§?
GROUP BY TumblingWindow('5m')    -- 5åˆ†é’Ÿ  
GROUP BY TumblingWindow('1h')    -- 1å°æ—¶
GROUP BY TumblingWindow('1d')    -- 1å¤?
```

#### 2. æ»‘åŠ¨çª—å£ (SlidingWindow)  
```sql
-- åŸºæœ¬è¯­æ³•: SlidingWindow(çª—å£å¤§å°, æ»‘åŠ¨é—´éš”)
GROUP BY deviceId, SlidingWindow('10m', '2m')

-- ç¤ºä¾‹
GROUP BY SlidingWindow('1h', '15m')    -- 1å°æ—¶çª—å£ï¼Œæ¯15åˆ†é’Ÿæ»‘åŠ¨
GROUP BY SlidingWindow('30s', '5s')    -- 30ç§’çª—å£ï¼Œæ¯?ç§’æ»‘åŠ?
```

#### 3. è®¡æ•°çª—å£ (CountingWindow)
```sql
-- åŸºæœ¬è¯­æ³•
GROUP BY deviceId, CountingWindow(100)   -- æ¯?00æ¡æ•°æ?

-- ç¤ºä¾‹  
GROUP BY CountingWindow(50)     -- æ¯?0æ¡æ•°æ®è§¦å?
GROUP BY CountingWindow(1000)   -- æ¯?000æ¡æ•°æ®è§¦å?
```

#### 4. ä¼šè¯çª—å£ (SessionWindow)
```sql
-- åŸºæœ¬è¯­æ³•
GROUP BY user_id, SessionWindow('5m')    -- 5åˆ†é’Ÿè¶…æ—¶

-- ç¤ºä¾‹
GROUP BY device_id, SessionWindow('30s') -- 30ç§’æ— æ•°æ®åˆ™å…³é—­ä¼šè¯?
GROUP BY session_key, SessionWindow('10m') -- 10åˆ†é’Ÿä¼šè¯è¶…æ—¶
```

## HAVING å­å¥

HAVINGå­å¥ç”¨äºè¿‡æ»¤èšåˆç»“æœï¼Œç±»ä¼¼äºWHEREä½†ä½œç”¨äºGROUP BYä¹‹åã€?

### åŸºæœ¬è¯­æ³•

```sql
SELECT aggregate_function(column)
FROM stream
GROUP BY grouping_columns
HAVING aggregate_condition
```

### ä½¿ç”¨ç¤ºä¾‹

#### 1. èšåˆå‡½æ•°è¿‡æ»¤

```sql
-- è¿‡æ»¤å¹³å‡æ¸©åº¦
SELECT deviceId, AVG(temperature) as avg_temp
FROM stream
GROUP BY deviceId, TumblingWindow('5s')
HAVING AVG(temperature) > 25

-- è¿‡æ»¤è®¡æ•°
SELECT location, COUNT(*) as event_count
FROM stream
GROUP BY location, TumblingWindow('1m')
HAVING COUNT(*) >= 10

-- å¤šä¸ªèšåˆæ¡ä»¶
SELECT deviceId, AVG(temperature), MAX(humidity)
FROM stream
GROUP BY deviceId, TumblingWindow('5s')
HAVING AVG(temperature) > 20 AND MAX(humidity) < 80
```

#### 2. å¤åˆæ¡ä»¶

```sql
-- å¤æ‚çš„HAVINGæ¡ä»¶
SELECT deviceType, COUNT(*) as count, AVG(value) as avg_value
FROM stream
GROUP BY deviceType, TumblingWindow('1m')
HAVING COUNT(*) > 5 AND (AVG(value) > 100 OR MAX(value) > 500)
```

### WHERE vs HAVING

```sql
-- âœ?æ­£ç¡®ï¼šWHEREè¿‡æ»¤åŸå§‹æ•°æ®ï¼ŒHAVINGè¿‡æ»¤èšåˆç»“æœ
SELECT deviceId, AVG(temperature)
FROM stream
WHERE temperature > 0          -- è¿‡æ»¤åŸå§‹æ•°æ®
GROUP BY deviceId, TumblingWindow('5s')
HAVING AVG(temperature) > 25    -- è¿‡æ»¤èšåˆç»“æœ

-- â?é”™è¯¯ï¼šåœ¨HAVINGä¸­è¿‡æ»¤åŸå§‹å­—æ®?
SELECT deviceId, AVG(temperature)
FROM stream
GROUP BY deviceId, TumblingWindow('5s')
HAVING deviceId = 'sensor001'   -- åº”è¯¥åœ¨WHEREä¸?
```

ç”¨äºè¿‡æ»¤èšåˆç»“æœï¼?

```sql
-- åŸºæœ¬ç”¨æ³•
SELECT deviceId, AVG(temperature) as avg_temp
FROM stream  
GROUP BY deviceId, TumblingWindow('5m')
HAVING avg_temp > 25

-- å¤æ‚æ¡ä»¶
SELECT deviceId, COUNT(*) as count, AVG(temperature) as avg_temp
FROM stream
GROUP BY deviceId, TumblingWindow('5m')  
HAVING count > 10 AND avg_temp BETWEEN 20 AND 30

-- ä½¿ç”¨èšåˆå‡½æ•°
SELECT location, AVG(temperature) as avg_temp
FROM stream
GROUP BY location, TumblingWindow('10m')
HAVING AVG(temperature) > 25 AND COUNT(*) >= 5
```

## ORDER BY å­å¥

::: warning æ³¨æ„
ORDER BYåœ¨æµå¤„ç†ä¸­æ”¯æŒæœ‰é™ï¼Œä¸»è¦ç”¨äºçª—å£ç»“æœæ’åºã€?
:::

```sql
-- æŒ‰èšåˆç»“æœæ’åºï¼ˆåœ¨çª—å£å†…ï¼?
SELECT deviceId, AVG(temperature) as avg_temp
FROM stream
GROUP BY deviceId, TumblingWindow('5m')
ORDER BY avg_temp DESC

-- å¤šå­—æ®µæ’åº?
ORDER BY avg_temp DESC, deviceId ASC
```

## LIMIT å­å¥

LIMITå­å¥é™åˆ¶æŸ¥è¯¢ç»“æœçš„æ•°é‡ï¼Œåœ¨æµå¤„ç†ä¸­é€šå¸¸ç”¨äºé™åˆ¶çª—å£è¾“å‡ºçš„è®°å½•æ•°ã€?

### åŸºæœ¬è¯­æ³•

```sql
SELECT columns FROM stream [WHERE condition] LIMIT count
```

### ä½¿ç”¨ç¤ºä¾‹

```sql
-- é™åˆ¶ç»“æœæ•°é‡
SELECT * FROM stream LIMIT 100

-- ä¸çª—å£ç»“åˆä½¿ç”?
SELECT deviceId, temperature
FROM stream
GROUP BY TumblingWindow('5s')
LIMIT 10

-- è·å–æœ€æ–°çš„Næ¡è®°å½?
SELECT deviceId, temperature, timestamp
FROM stream
WHERE deviceId = 'sensor001'
ORDER BY timestamp DESC
LIMIT 5
```

### æ³¨æ„äº‹é¡¹

- LIMITåœ¨æµå¤„ç†ä¸­ä¸»è¦ç”¨äºæ§åˆ¶è¾“å‡ºé‡
- å¯¹äºèšåˆæŸ¥è¯¢ï¼ŒLIMITé™åˆ¶çš„æ˜¯èšåˆç»“æœçš„æ•°é‡?
- å»ºè®®åˆç†è®¾ç½®LIMITä»¥é¿å…å†…å­˜å‹åŠ?

é™åˆ¶è¾“å‡ºç»“æœæ•°é‡ï¼?

```sql
-- åŸºæœ¬ç”¨æ³•
SELECT deviceId, temperature FROM stream LIMIT 10

-- ä¸çª—å£ç»“å?
SELECT deviceId, AVG(temperature) as avg_temp
FROM stream  
GROUP BY deviceId, TumblingWindow('5m')
LIMIT 5   -- æ¯ä¸ªçª—å£æœ€å¤?ä¸ªç»“æ?
```

## WITH å­å¥

WITHå­å¥ç”¨äºæŒ‡å®šæŸ¥è¯¢çš„é…ç½®é€‰é¡¹ï¼Œå¦‚æ—¶é—´æˆ³å­—æ®µã€æ—¶é—´å•ä½ç­‰ã€?

### åŸºæœ¬è¯­æ³•

```sql
SELECT columns FROM stream
[WHERE condition]
[GROUP BY grouping]
WITH (option = value [, ...])
```

### æ”¯æŒçš„é€‰é¡¹

#### 1. æ—¶é—´æˆ³é…ç½?

```sql
-- æŒ‡å®šæ—¶é—´æˆ³å­—æ®?
SELECT AVG(temperature) FROM stream
GROUP BY TumblingWindow('5s')
WITH (TIMESTAMP = 'event_time')

-- æŒ‡å®šæ—¶é—´å•ä½
SELECT COUNT(*) FROM stream
GROUP BY TumblingWindow('5000')
WITH (TIMEUNIT = 'ms', TIMESTAMP = 'timestamp')
```

#### 2. æ—¶é—´å•ä½é€‰é¡¹

```sql
-- æ”¯æŒçš„æ—¶é—´å•ä½?
WITH (TIMEUNIT = 'ms')    -- æ¯«ç§’
WITH (TIMEUNIT = 'ss')    -- ç§’ï¼ˆé»˜è®¤ï¼?
WITH (TIMEUNIT = 'mi')    -- åˆ†é’Ÿ
WITH (TIMEUNIT = 'hh')    -- å°æ—¶
WITH (TIMEUNIT = 'dd')    -- å¤?
```

#### 3. å®Œæ•´ç¤ºä¾‹

```sql
-- ä½¿ç”¨äº‹ä»¶æ—¶é—´çš„çª—å£èšå?
SELECT deviceId,
       AVG(temperature) as avg_temp,
       window_start() as start_time
FROM stream
WHERE temperature > 0
GROUP BY deviceId, TumblingWindow('300000')  -- 5åˆ†é’Ÿ = 300000æ¯«ç§’
HAVING AVG(temperature) > 20
WITH (TIMESTAMP = 'event_timestamp', TIMEUNIT = 'ms')
```

é…ç½®æŸ¥è¯¢é€‰é¡¹ï¼?

```sql
-- æ—¶é—´æˆ³å­—æ®µé…ç½?
WITH (TIMESTAMP='event_time')

-- æ—¶é—´å•ä½é…ç½®  
WITH (TIMEUNIT='ss')      -- ç§?
WITH (TIMEUNIT='ms')      -- æ¯«ç§’
WITH (TIMEUNIT='mi')      -- åˆ†é’Ÿ
WITH (TIMEUNIT='hh')      -- å°æ—¶

-- ç»„åˆé…ç½®
WITH (TIMESTAMP='ts', TIMEUNIT='ms')
```

### æ”¯æŒçš„é…ç½®é¡¹

| é…ç½®é¡?| ç±»å‹ | è¯´æ˜ | é»˜è®¤å€?|
|--------|------|------|--------|
| `TIMESTAMP` | string | æ—¶é—´æˆ³å­—æ®µå | ç³»ç»Ÿæ—¶é—´ |
| `TIMEUNIT` | string | æ—¶é—´å•ä½ | 'ss' (ç§? |

## æ•°æ®ç±»å‹å’Œå¸¸é‡?

### æ•°å€¼å¸¸é‡?
```sql
SELECT 42, 3.14, -10.5, 1e6 FROM stream
```

### å­—ç¬¦ä¸²å¸¸é‡? 
```sql
SELECT 'hello', "world", 'it''s ok' FROM stream
```

### å¸ƒå°”å¸¸é‡
```sql
SELECT true, false, temperature > 25 FROM stream  
```

### NULLå€?
```sql
SELECT NULL, temperature IS NULL FROM stream
```

## è¡¨è¾¾å¼å’Œæ“ä½œç¬?

### ç®—æœ¯æ“ä½œç¬?

| æ“ä½œç¬?| è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `+` | åŠ æ³• | `temperature + 10` |
| `-` | å‡æ³• | `temperature - 5` |
| `*` | ä¹˜æ³• | `temperature * 1.8` |
| `/` | é™¤æ³• | `total / count` |
| `%` | å–æ¨¡ | `id % 10` |

### å­—ç¬¦ä¸²æ“ä½?
```sql
-- å­—ç¬¦ä¸²è¿æ?
SELECT deviceId + '_' + status FROM stream
SELECT CONCAT(deviceId, '_', status) FROM stream

-- å­—ç¬¦ä¸²å‡½æ•?
SELECT UPPER(status), LOWER(location), LENGTH(deviceId) FROM stream
```

### æ¡ä»¶è¡¨è¾¾å¼?

#### CASEè¡¨è¾¾å¼?
```sql
-- ç®€å•CASE
SELECT deviceId,
       CASE status
           WHEN 'active' THEN 1
           WHEN 'inactive' THEN 0  
           ELSE -1
       END as status_code
FROM stream

-- æœç´¢CASE
SELECT deviceId,
       CASE 
           WHEN temperature > 30 THEN 'HOT'
           WHEN temperature > 20 THEN 'WARM'
           WHEN temperature > 10 THEN 'COOL'
           ELSE 'COLD'
       END as temp_category  
FROM stream
```

## å†…ç½®å‡½æ•°

### èšåˆå‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `COUNT(*)` | è®¡æ•° | `COUNT(*)` |
| `SUM(expr)` | æ±‚å’Œ | `SUM(temperature)` |
| `AVG(expr)` | å¹³å‡å€?| `AVG(temperature)` |
| `MIN(expr)` | æœ€å°å€?| `MIN(temperature)` |
| `MAX(expr)` | æœ€å¤§å€?| `MAX(temperature)` |
| `STDDEV(expr)` | æ ‡å‡†å·?| `STDDEV(temperature)` |
| `MEDIAN(expr)` | ä¸­ä½æ•?| `MEDIAN(temperature)` |

### æ•°å­¦å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `ABS(x)` | ç»å¯¹å€?| `ABS(temperature)` |
| `ROUND(x, d)` | å››èˆäº”å…¥ | `ROUND(temperature, 2)` |
| `FLOOR(x)` | å‘ä¸‹å–æ•´ | `FLOOR(temperature)` |
| `CEIL(x)` | å‘ä¸Šå–æ•´ | `CEIL(temperature)` |
| `SQRT(x)` | å¹³æ–¹æ ?| `SQRT(area)` |
| `POWER(x, y)` | å¹‚è¿ç®?| `POWER(distance, 2)` |

### å­—ç¬¦ä¸²å‡½æ•?

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `CONCAT(s1, s2, ...)` | å­—ç¬¦ä¸²è¿æ?| `CONCAT(first, '_', last)` |
| `UPPER(s)` | è½¬å¤§å†?| `UPPER(status)` |
| `LOWER(s)` | è½¬å°å†?| `LOWER(deviceId)` |
| `LENGTH(s)` | å­—ç¬¦ä¸²é•¿åº?| `LENGTH(message)` |
| `SUBSTRING(s, start, len)` | å­å­—ç¬¦ä¸² | `SUBSTRING(deviceId, 1, 5)` |
| `TRIM(s)` | å»é™¤ç©ºç™½ | `TRIM(name)` |

### æ—¶é—´å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `window_start()` | çª—å£å¼€å§‹æ—¶é—?| `window_start()` |
| `window_end()` | çª—å£ç»“æŸæ—¶é—´ | `window_end()` |
| `NOW()` | å½“å‰æ—¶é—´ | `NOW()` |

### ç±»å‹è½¬æ¢å‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `CAST(expr AS type)` | ç±»å‹è½¬æ¢ | `CAST(temperature AS STRING)` |

## å®Œæ•´ç¤ºä¾‹

### 1. åŸºç¡€æŸ¥è¯¢
```sql
-- ç®€å•è¿‡æ»?
SELECT deviceId, temperature, status 
FROM stream 
WHERE temperature > 25 AND status = 'active'
```

### 2. èšåˆåˆ†æ
```sql
-- è®¾å¤‡æ¸©åº¦ç»Ÿè®¡
SELECT deviceId,
       COUNT(*) as sample_count,
       AVG(temperature) as avg_temp,
       MIN(temperature) as min_temp,
       MAX(temperature) as max_temp,
       STDDEV(temperature) as temp_stddev
FROM stream
WHERE temperature IS NOT NULL
GROUP BY deviceId, TumblingWindow('5m')
HAVING sample_count >= 10
```

### 3. å¤æ‚è¡¨è¾¾å¼?
```sql
-- æ¸©åº¦å¼‚å¸¸æ£€æµ?
SELECT deviceId,
       temperature,
       ABS(temperature - AVG(temperature)) as deviation,
       CASE 
           WHEN ABS(temperature - AVG(temperature)) > 2 * STDDEV(temperature) 
           THEN 'ANOMALY'
           ELSE 'NORMAL'
       END as anomaly_status
FROM stream
GROUP BY deviceId, SlidingWindow('10m', '1m')
```

### 4. å¤šçª—å£åˆ†æ?
```sql
-- å¤šå±‚çº§æ—¶é—´åˆ†æ?
SELECT deviceId,
       '1m' as window_type,
       AVG(temperature) as avg_temp,
       window_start() as start_time
FROM stream
GROUP BY deviceId, TumblingWindow('1m')

UNION ALL

SELECT deviceId,
       '5m' as window_type, 
       AVG(temperature) as avg_temp,
       window_start() as start_time
FROM stream  
GROUP BY deviceId, TumblingWindow('5m')
```

::: warning æ³¨æ„
ä¸Šè¿°UNION ALLç¤ºä¾‹ä»…ä¸ºè¯­æ³•å±•ç¤ºï¼ŒStreamSQLå½“å‰ä¸æ”¯æŒUNIONæ“ä½œã€?
:::

## è¯­æ³•é™åˆ¶

### ä¸æ”¯æŒçš„ç‰¹æ€?

- `JOIN` æ“ä½œï¼ˆå¤šè¡¨è¿æ¥ï¼‰
- `UNION` æ“ä½œï¼ˆç»“æœåˆå¹¶ï¼‰  
- `å­æŸ¥è¯¢` ï¼ˆåµŒå¥—SELECTï¼?
- `INSERT/UPDATE/DELETE` ï¼ˆæ•°æ®ä¿®æ”¹ï¼‰
- `CREATE TABLE` ï¼ˆè¡¨å®šä¹‰ï¼?
- `è§†å›¾` ï¼ˆVIEWï¼?
- `å­˜å‚¨è¿‡ç¨‹` ï¼ˆPROCEDUREï¼?
- `è§¦å‘å™¨` ï¼ˆTRIGGERï¼?

### é™åˆ¶è¯´æ˜

1. **å•æ•°æ®æº**ï¼šåªæ”¯æŒå•ä¸ªæ•°æ®æµå¤„ç?
2. **æ— æŒä¹…åŒ–**ï¼šä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–å­˜å‚?
3. **æ— äº‹åŠ?*ï¼šä¸æ”¯æŒäº‹åŠ¡æ“ä½œ
4. **å†…å­˜é™åˆ¶**ï¼šå—é™äºå•æœºå†…å­˜å®¹é‡

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. WHEREå­å¥ä¼˜åŒ–
```sql
-- å¥½çš„å®è·µï¼šæ—©æœŸè¿‡æ»?
SELECT deviceId, AVG(temperature) 
FROM stream
WHERE temperature BETWEEN 0 AND 100  -- å…ˆè¿‡æ»¤å¼‚å¸¸æ•°æ?
GROUP BY deviceId, TumblingWindow('5m')

-- é¿å…ï¼šå¤æ‚WHEREæ¡ä»¶
WHERE UPPER(CONCAT(deviceId, status)) LIKE '%ACTIVE%'
```

### 2. åˆç†ä½¿ç”¨çª—å£
```sql
-- å¥½çš„å®è·µï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çª—å?
GROUP BY TumblingWindow('1m')    -- éœ€è¦ç²¾ç¡®å‘¨æœŸç»Ÿè®?
GROUP BY SlidingWindow('5m', '1m') -- éœ€è¦å¹³æ»‘åˆ†æ?

-- é¿å…ï¼šè¿‡å°çš„çª—å£é—´éš”
GROUP BY SlidingWindow('1h', '1s')   -- è®¡ç®—å¼€é”€å·¨å¤§
```

### 3. è¡¨è¾¾å¼ä¼˜åŒ?
```sql
-- å¥½çš„å®è·µï¼šç®€å•è¡¨è¾¾å¼
SELECT temperature * 1.8 + 32 as fahrenheit

-- é¿å…ï¼šå¤æ‚åµŒå¥—è¡¨è¾¾å¼  
SELECT POWER(SQRT(ABS(temperature - AVG(temperature))), 2)
```

## ä¸‹ä¸€æ­?

ç°åœ¨æ‚¨å·²ç»æŒæ¡äº†StreamSQLçš„SQLè¯­æ³•ï¼Œå»ºè®®ç»§ç»­å­¦ä¹ ï¼š

- ğŸªŸ [çª—å£å‡½æ•°](../05.çª—å£å‡½æ•°/) - æ·±å…¥äº†è§£çª—å£å¤„ç†
- ğŸ”§ [è‡ªå®šä¹‰å‡½æ•°](../06.è‡ªå®šä¹‰å‡½æ•?) - æ‰©å±•SQLå¤„ç†èƒ½åŠ›  
- ğŸ’¡ [ç¤ºä¾‹é›†åˆ](../07.ç¤ºä¾‹/) - æŸ¥çœ‹å®é™…åº”ç”¨æ¡ˆä¾‹
- ğŸ“– [æœ€ä½³å®è·µ](../09.æœ€ä½³å®è·?) - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å»ºè®®
