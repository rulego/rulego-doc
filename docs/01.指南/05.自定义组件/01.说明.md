---
title: è‡ªå®šä¹‰ç»„ä»¶æ¦‚è¿°
article: false
author: 
  name: rulego
  link: https://github.com/rulego/rulego
date: 2023-09-13 15:24:41
permalink: /pages/caed1b/
---

ä½ å¯ä»¥æŠŠä½ çš„ä¸šåŠ¡é€»è¾‘æˆ–è€…é€šç”¨é€»è¾‘å°è£…æˆç»„ä»¶ï¼Œç„¶ååœ¨è§„åˆ™é“¾é€šè¿‡é…ç½®è§„åˆ™èŠ‚ç‚¹è°ƒç”¨å®ƒã€‚æ­¥éª¤ï¼š
1. å®ç°ç»„ä»¶æ¥å£ã€‚
2. æŠŠè‡ªå®šç»„ä»¶æ³¨å†Œåˆ°æ³¨å†Œå™¨ã€‚
3. é€šè¿‡è§„åˆ™é“¾é…ç½®è°ƒç”¨ç»„ä»¶ã€‚

## è‡ªå®šä¹‰ç»„ä»¶

### ç»„ä»¶æ¥å£

å®ç°[types.Node](https://github.com/rulego/rulego/blob/main/api/types/types.go)æ¥å£ï¼š

```go
// Node èŠ‚ç‚¹ç»„ä»¶æ¥å£
//æŠŠä¸šåŠ¡å°æˆ–è€…é€šç”¨é€»è¾‘è£…æˆç»„ä»¶ï¼Œç„¶åé€šè¿‡è§„åˆ™é“¾é…ç½®æ–¹å¼è°ƒç”¨è¯¥ç»„ä»¶
type Node interface {
  //New åˆ›å»ºä¸€ä¸ªç»„ä»¶æ–°å®ä¾‹
  //æ¯ä¸ªè§„åˆ™é“¾çš„è§„åˆ™èŠ‚ç‚¹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œæ•°æ®æ˜¯éš”ç¦»çš„
  New() Node
  //Type ç»„ä»¶ç±»å‹ï¼Œç±»å‹ä¸èƒ½é‡å¤ã€‚
  //ç”¨äºè§„åˆ™é“¾ï¼Œnode.typeé…ç½®ï¼Œåˆå§‹åŒ–å¯¹åº”çš„ç»„ä»¶
  //å»ºè®®ä½¿ç”¨`/`åŒºåˆ†å‘½åç©ºé—´ï¼Œé˜²æ­¢å†²çªã€‚ä¾‹å¦‚ï¼šx/httpClient
  Type() string
  //Init ç»„ä»¶åˆå§‹åŒ–ï¼Œä¸€èˆ¬åšä¸€äº›ç»„ä»¶å‚æ•°é…ç½®æˆ–è€…å®¢æˆ·ç«¯åˆå§‹åŒ–æ“ä½œ
  //è§„åˆ™é“¾é‡Œçš„è§„åˆ™èŠ‚ç‚¹åˆå§‹åŒ–ä¼šè°ƒç”¨ä¸€æ¬¡
  //Configuration å‚æ•°ä¸ºèŠ‚ç‚¹é…ç½®æ•°æ®
  Init(ruleConfig Config, configuration Configuration) error
  //OnMsg å¤„ç†æ¶ˆæ¯ï¼Œå¹¶æ§åˆ¶æµå‘å­èŠ‚ç‚¹çš„å…³ç³»ã€‚æ¯æ¡æµå…¥ç»„ä»¶çš„æ•°æ®ä¼šç»è¿‡è¯¥æ–¹æ³•å¤„ç†
  //ctx:è§„åˆ™å¼•æ“å¤„ç†æ¶ˆæ¯ä¸Šä¸‹æ–‡
  //msg:æ¶ˆæ¯
  OnMsg(ctx RuleContext, msg RuleMsg)
  //Destroy é”€æ¯ï¼Œåšä¸€äº›èµ„æºé‡Šæ”¾æ“ä½œ
  Destroy()
}
```

### ç”Ÿå‘½å‘¨æœŸ

- **New:** ç”¨äºåˆ›å»ºèŠ‚ç‚¹ç»„ä»¶å®ä¾‹æ—¶è°ƒç”¨ã€‚
- **Init:** ç”¨äºè§£æå½“å‰èŠ‚ç‚¹çš„JSONçš„é…ç½®ï¼Œåˆå§‹åŒ–è§„åˆ™é“¾æ—¶å€™åˆå§‹åŒ–ä¸€æ¬¡ã€‚
- **OnMsg:** ç”¨äºå¤„ç†æ¶ˆæ¯ï¼Œå¹¶æ§åˆ¶æµå‘å­èŠ‚ç‚¹çš„å…³ç³»ã€‚æ¯æ¡æµå…¥ç»„ä»¶çš„æ•°æ®ä¼šç»è¿‡è¯¥å‡½æ•°å¤„ç†ã€‚
- **Destroy:** ç”¨äºèŠ‚ç‚¹é”€æ¯æ—¶è°ƒç”¨ã€‚è§„åˆ™å¼•æ“é”€æ¯æ—¶ã€è§„åˆ™é“¾æ›´æ–°æˆ–èŠ‚ç‚¹é…ç½®æ›´æ–°æ—¶ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚
>å¦‚æœåŠ¨æ€æ›´æ–°èŠ‚ç‚¹é…ç½®ï¼Œåˆ™å…ˆè°ƒç”¨è¯¥èŠ‚ç‚¹æ–°å®ä¾‹`Init`æ–¹æ³•ï¼Œå¦‚æœåˆå§‹åŒ–æˆåŠŸåï¼Œå†è°ƒç”¨æ—§å®ä¾‹çš„`Destroy`æ–¹æ³•ã€‚

### åˆå§‹åŒ–
ä¸€èˆ¬æˆ‘ä»¬å…ˆå®šä¹‰è¯¥ç»„ä»¶çš„é…ç½®ç»“æ„ä½“ï¼Œé…ç½®ç»“æ„ä½“æ”¯æŒåµŒå¥—è‡ªå®šä¹‰ç»“æ„ä½“ï¼ŒåµŒå¥—ç»“æ„ä½“çš„å­—æ®µåªæ”¯æŒåŸºç¡€ç±»å‹ï¼Œå¦å¤–éœ€è¦ä½¿ç”¨jsonæ ‡ç­¾å®šä¹‰å­—æ®µçš„ç¼–è§£ç ï¼Œå­—æ®µæ ¼å¼ä½¿ç”¨å°é©¼å³°å‘½åæ–¹å¼ã€‚
ä¾‹å¦‚ä»¥ä¸‹MQTTå®¢æˆ·ç«¯é…ç½®ç»“æ„ä½“ï¼š
```go
type MqttClientNodeConfiguration struct {
	Server   string `json:"server"`
	Username string `json:"username"`
	Password string `json:"password"`
	// Topic å‘å¸ƒä¸»é¢˜ å¯ä»¥ä½¿ç”¨ ${metadata.key} è¯»å–å…ƒæ•°æ®ä¸­çš„å˜é‡æˆ–è€…ä½¿ç”¨ ${msg.key} è¯»å–æ¶ˆæ¯è´Ÿè·ä¸­çš„å˜é‡è¿›è¡Œæ›¿æ¢
	Topic string `json:"topic"`
	//MaxReconnectInterval é‡è¿é—´éš” å•ä½ç§’
	MaxReconnectInterval int `json:"maxReconnectInterval"`
	QOS                  uint8 `json:"qos"`
	CleanSession         bool `json:"cleanSession"`
	ClientID             string `json:"clientID"`
	CAFile               string `json:"cAFile"`
	CertFile             string `json:"certFile"`
	CertKeyFile          string `json:"certKeyFile"`
}
```
ç»„ä»¶ä½¿ç”¨`Config`å­—æ®µè‡ªå®šä¹‰ç»„ä»¶é…ç½®ï¼ˆå¯è§†åŒ–ç¼–è¾‘å™¨ä¼šæ ¹æ®Configå­—æ®µçš„ç»“æ„ä½“ç”Ÿæˆå¯è§†åŒ–èŠ‚ç‚¹é…ç½®ï¼‰ï¼š
```go
type MqttClientNode struct {
	//èŠ‚ç‚¹é…ç½®
	Config MqttClientNodeConfiguration
	//topic æ¨¡æ¿
	topicTemplate str.Template
	//å®¢æˆ·ç«¯
	client        *mqtt.Client
}
```
> `global`,`vars`,`secrets`,`label`,`desc` ,`icon` ä¸ºä¿ç•™å­—æ®µã€‚

ç„¶ååœ¨ç»„ä»¶åˆå§‹åŒ–æ—¶ï¼ŒæŠŠè¯¥èŠ‚ç‚¹çš„å®ä¾‹åŒ–é…ç½®è½¬æˆç»„ä»¶é…ç½®ç»“æ„ä½“ï¼Œä¾‹å¦‚ä»¥ä¸‹èŠ‚ç‚¹é…ç½®ï¼š
```json
{
     "id": "s3",
     "type": "mqttClient",
     "name": "mqttæ¨é€æ•°æ®",
     "debugMode": false,
     "configuration": {
       "Server": "127.0.0.1:1883",
       "Topic": "/device/msg"
     }
}
```
Initæ–¹æ³• `configuration` å‚æ•°ä¼ é€’çš„å°±æ˜¯è¯¥èŠ‚ç‚¹é…ç½®çš„`configuration`æ•°æ®
```go
// Init åˆå§‹åŒ–
func (x *MqttClientNode) Init(ruleConfig types.Config, configuration types.Configuration) error {
	//æŠŠèŠ‚ç‚¹é…ç½®è½¬æˆç»„ä»¶é…ç½®ç»“æ„ä½“
    err := maps.Map2Struct(configuration, &x.Config)
    //å…¶ä»–åˆå§‹åŒ–
    return err
}
```
æœ€ååœ¨OnMsgä¸­ï¼Œæˆ–è€…å…¶ä»–ä½¿ç”¨è¯¥é…ç½®
```go
// OnMsg å¤„ç†æ¶ˆæ¯
func (x *MqttClientNode) OnMsg(ctx types.RuleContext, msg types.RuleMsg) {
	//ä½¿ç”¨é…ç½®
    topic:= x.Config.Topic,
}
```
### å¤„ç†æ¶ˆæ¯

å½“å‰è§„åˆ™èŠ‚ç‚¹å¤„ç†å®Œåï¼ŒæŠŠæ¶ˆæ¯é€šè¿‡ä»¥ä¸‹æ–¹æ³•é€šçŸ¥ä¸‹ä¸€ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹ã€‚è§„åˆ™å¼•æ“ä¼šæŸ¥è¯¢æ»¡è¶³å…³ç³»çš„å­èŠ‚ç‚¹ï¼Œå¹¶å‘è§¦å‘å…¶`OnMsg`æ–¹æ³•ï¼Œè¿›è¡Œé“¾å¼æ•°æ®æµè°ƒç”¨
```go
//TellSuccess é€šçŸ¥è§„åˆ™å¼•æ“å¤„ç†å½“å‰æ¶ˆæ¯å¤„ç†æˆåŠŸï¼Œå¹¶æŠŠæ¶ˆæ¯é€šè¿‡`Success`å…³ç³»å‘é€åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
TellSuccess(msg RuleMsg)
//TellNext ä½¿ç”¨æŒ‡å®šçš„relationTypesï¼Œå‘é€æ¶ˆæ¯åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
TellNext(msg RuleMsg, relationTypes ...string)
//TellFailure é€šçŸ¥è§„åˆ™å¼•æ“å¤„ç†å½“å‰æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œå¹¶æŠŠæ¶ˆæ¯é€šè¿‡`Failure`å…³ç³»å‘é€åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
TellFailure(msg RuleMsg, err error)
```

ç¤ºä¾‹ï¼š
```go
// OnMsg å¤„ç†æ¶ˆæ¯
func (x *MqttClientNode) OnMsg(ctx types.RuleContext, msg types.RuleMsg) {
	//ä½¿ç”¨æ¨¡æ¿æ›¿æ¢topic
	topic := x.topicTemplate.ExecuteFn(func() map[string]any {
		return base.NodeUtils.GetEvnAndMetadata(ctx, msg)
	})
	//è·å–mqttå®¢æˆ·ç«¯
	if client, err := x.SharedNode.Get(); err != nil {
		ctx.TellFailure(msg, err)
	} else {
		//æŠŠä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºï¼Œå‘å¸ƒåˆ°mqtt broker
		if err := client.Publish(topic, x.Config.QOS, []byte(msg.Data)); err != nil {
			//å¤±è´¥åˆ™é€šè¿‡å¤±è´¥é“¾å‘é€åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
			ctx.TellFailure(msg, err)
		} else {
			//æˆåŠŸåˆ™é€šè¿‡æˆåŠŸé“¾å‘é€åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸æ”¹æ¶ˆæ¯è´Ÿè·
			ctx.TellSuccess(msg)
		}
	}
}
```

### å¹¶å‘å®‰å…¨

åœ¨å®ç°è‡ªå®šä¹‰ç»„ä»¶æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„**OnMsg()å’ŒDestroy()ä¹‹é—´çš„å¹¶å‘å®‰å…¨é—®é¢˜**ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨`SharedNode`çš„ç»„ä»¶ã€‚

#### ğŸš¨ é‡è¦è­¦å‘Šï¼šç«äº‰æ¡ä»¶é£é™©

ä½¿ç”¨SharedNodeçš„ç»„ä»¶å¿…é¡»æ­£ç¡®å¤„ç†OnMsg()å’ŒDestroy()ä¹‹é—´çš„ç«äº‰æ¡ä»¶ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ï¼š
- ä½¿ç”¨å·²å…³é—­çš„å®¢æˆ·ç«¯è¿æ¥
- æ•°æ®ä¸¢å¤±æˆ–æŸå
- ç¨‹åºå´©æºƒæˆ–èµ„æºæ³„æ¼

#### âŒ é”™è¯¯çš„å®ç°æ¨¡å¼

```go
// å±é™©ï¼šå­˜åœ¨ç«äº‰æ¡ä»¶
type MyNode struct {
    base.SharedNode[*SomeClient]
    client *SomeClient
}

func (x *MyNode) OnMsg(ctx types.RuleContext, msg types.RuleMsg) {
    // è·å–å®¢æˆ·ç«¯
    client, err := x.SharedNode.Get()
    if err != nil {
        ctx.TellFailure(msg, err)
        return
    }
    
    // å±é™©åŒºåŸŸï¼šæ­¤æ—¶Destroy()å¯èƒ½è¢«è°ƒç”¨å¹¶å…³é—­å®¢æˆ·ç«¯
    // ä½¿ç”¨å¯èƒ½å·²å…³é—­çš„å®¢æˆ·ç«¯ - ç«äº‰æ¡ä»¶ï¼
    result, err := client.DoSomething(msg.GetData())
    if err != nil {
        ctx.TellFailure(msg, err)
    } else {
        msg.SetData(result)
        ctx.TellSuccess(msg)
    }
}

func (x *MyNode) Destroy() {
    // å¼ºåˆ¶å…³é—­ - å¯èƒ½æ‰“æ–­æ­£åœ¨è¿›è¡Œçš„æ“ä½œ
    if x.client != nil {
        x.client.Close()
    }
}
```

#### âœ… æ­£ç¡®çš„å®ç°æ¨¡å¼

```go
// å®‰å…¨ï¼šä½¿ç”¨SharedNodeå¹¶å‘å®‰å…¨æœºåˆ¶
type MyNode struct {
    base.SharedNode[*SomeClient]
    client *SomeClient
}

func (x *MyNode) OnMsg(ctx types.RuleContext, msg types.RuleMsg) {
    // 1. å¼€å§‹æ“ä½œè®¡æ•°
    x.SharedNode.BeginOp()
    defer x.SharedNode.EndOp()

    // 2. æ£€æŸ¥å…³é—­çŠ¶æ€
    if x.SharedNode.IsShuttingDown() {
        ctx.TellFailure(msg, fmt.Errorf("component is shutting down"))
        return
    }

    // 3. è·å–å®¢æˆ·ç«¯
    client, err := x.SharedNode.Get()
    if err != nil {
        ctx.TellFailure(msg, err)
        return
    }

    // 4. å†æ¬¡æ£€æŸ¥å…³é—­çŠ¶æ€
    if x.SharedNode.IsShuttingDown() {
        ctx.TellFailure(msg, fmt.Errorf("component is shutting down"))
        return
    }

    // 5. å®‰å…¨ä½¿ç”¨å®¢æˆ·ç«¯
    result, err := client.DoSomething(msg.GetData())
    if err != nil {
        ctx.TellFailure(msg, err)
    } else {
        msg.SetData(result)
        ctx.TellSuccess(msg)
    }
}

func (x *MyNode) Destroy() {
    // ä¼˜é›…å…³é—­ï¼šç­‰å¾…æ´»è·ƒæ“ä½œå®Œæˆåå†å…³é—­èµ„æº
    x.SharedNode.GracefulShutdown(0, func() {
        // åªåœ¨éèµ„æºæ± æ¨¡å¼ä¸‹å…³é—­æœ¬åœ°èµ„æº
        if x.client != nil {
            x.client.Close()
            x.client = nil
        }
    })
}
```

#### SharedNode å¹¶å‘å®‰å…¨è¦æ±‚æ¸…å•

ä½¿ç”¨SharedNodeçš„ç»„ä»¶å¿…é¡»éµå¾ªä»¥ä¸‹å¹¶å‘å®‰å…¨åŸåˆ™ï¼š

âœ… **OnMsgæ–¹æ³•ä¸­ï¼š**
- ä½¿ç”¨ `BeginOp()` / `EndOp()` è¿›è¡Œæ“ä½œè®¡æ•°
- åœ¨ `Get()` å‰åæ£€æŸ¥ `IsShuttingDown()` çŠ¶æ€
- å®ç°ä¼˜é›…é™çº§å¤„ç†

âœ… **Destroyæ–¹æ³•ä¸­ï¼š**
- ä½¿ç”¨ `GracefulShutdown()` è€Œä¸æ˜¯ç›´æ¥å…³é—­èµ„æº
- ç­‰å¾…æ´»è·ƒæ“ä½œå®Œæˆåå†æ¸…ç†èµ„æº
- é¿å…å¼ºåˆ¶ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„æ“ä½œ

âœ… **èµ„æºç®¡ç†ï¼š**
- åªåœ¨éèµ„æºæ± æ¨¡å¼ä¸‹å…³é—­æœ¬åœ°èµ„æº
- å°†clientå­—æ®µè®¾ç½®ä¸ºnilé˜²æ­¢é‡å¤å…³é—­
- å®ç°å¹‚ç­‰çš„æ¸…ç†é€»è¾‘

#### å¹¶å‘å®‰å…¨çš„é‡è¦æ€§

æ­£ç¡®çš„å¹¶å‘å®‰å…¨å®ç°å¯ä»¥ï¼š
- é˜²æ­¢ä½¿ç”¨å·²å…³é—­çš„è¿æ¥å¯¼è‡´çš„å´©æºƒ
- ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
- æä¾›ä¼˜é›…çš„æœåŠ¡é™çº§èƒ½åŠ›
- é¿å…èµ„æºæ³„æ¼å’Œå†…å­˜æ³„æ¼

#### é€šç”¨å¹¶å‘å®‰å…¨è¦æ±‚

**æ‰€æœ‰**å…·æœ‰å…±äº«å¯å˜çŠ¶æ€çš„ç»„ä»¶éƒ½å¿…é¡»å®ç°é€‚å½“çš„å¹¶å‘å®‰å…¨æœºåˆ¶ï¼Œä¸ä»…ä»…æ˜¯SharedNodeç»„ä»¶ï¼š

#### âŒ é€šç”¨é”™è¯¯æ¨¡å¼

```go
// å±é™©ï¼šä»»ä½•æœ‰å…±äº«çŠ¶æ€çš„ç»„ä»¶éƒ½å¯èƒ½å­˜åœ¨ç«äº‰æ¡ä»¶
type MyNode struct {
    client      *SomeClient  // å…±äº«å¯å˜çŠ¶æ€
    config      Config       // å¦‚æœè¿è¡Œæ—¶ä¿®æ”¹ä¹Ÿå¯èƒ½æœ‰é—®é¢˜
    counter     int64        // å…±äº«è®¡æ•°å™¨
    isConnected bool         // å…±äº«çŠ¶æ€æ ‡å¿—
}

func (x *MyNode) OnMsg(ctx types.RuleContext, msg types.RuleMsg) {
    // å±é™©ï¼šæ£€æŸ¥-ç„¶å-ä½¿ç”¨ç«äº‰æ¡ä»¶
    if x.client == nil {
        // ... æ­¤æ—¶Destroy()å¯èƒ½è¢«è°ƒç”¨
        return
    }
    
    // å±é™©ï¼šä½¿ç”¨å¯èƒ½å·²è¢«ä¿®æ”¹çš„çŠ¶æ€
    if !x.isConnected {
        return
    }
    
    // å±é™©ï¼šä½¿ç”¨å¯èƒ½å·²å…³é—­çš„client
    result := x.client.DoSomething()
    
    // å±é™©ï¼šéåŸå­æ“ä½œ
    x.counter++
}

func (x *MyNode) Destroy() {
    // å±é™©ï¼šæ²¡æœ‰åŒæ­¥æœºåˆ¶ç›´æ¥ä¿®æ”¹å…±äº«çŠ¶æ€
    if x.client != nil {
        x.client.Close()
        x.client = nil
    }
    x.isConnected = false
}

func (x *MyNode) SomeOtherMethod() {
    // å±é™©ï¼šè¿è¡Œæ—¶ä¿®æ”¹é…ç½®
    x.config.SomeField = "new value"
}
```

#### âœ… é€šç”¨æ­£ç¡®æ¨¡å¼

```go
// å®‰å…¨ï¼šä½¿ç”¨é€‚å½“çš„åŒæ­¥æœºåˆ¶ä¿æŠ¤å…±äº«çŠ¶æ€
type MyNode struct {
    // å…±äº«çŠ¶æ€å­—æ®µ
    client      *SomeClient
    config      Config
    counter     int64
    isConnected bool
    
    // åŒæ­¥ä¿æŠ¤æœºåˆ¶
    clientMutex     sync.RWMutex  // ä¿æŠ¤clientå’ŒisConnected
    configMutex     sync.RWMutex  // ä¿æŠ¤config
    // ä½¿ç”¨atomicæ“ä½œä¿æŠ¤counterï¼Œä¸éœ€è¦mutex
}

func (x *MyNode) OnMsg(ctx types.RuleContext, msg types.RuleMsg) {
    // å®‰å…¨ï¼šåŸå­æ€§è·å–å…±äº«çŠ¶æ€
    x.clientMutex.RLock()
    client := x.client
    connected := x.isConnected
    x.clientMutex.RUnlock()
    
    if client == nil || !connected {
        ctx.TellFailure(msg, fmt.Errorf("client not available"))
        return
    }
    
    // å®‰å…¨ï¼šä½¿ç”¨æœ¬åœ°å‰¯æœ¬ï¼Œé¿å…å¹¶å‘ä¿®æ”¹
    result := client.DoSomething()
    
    // å®‰å…¨ï¼šåŸå­æ“ä½œ
    atomic.AddInt64(&x.counter, 1)
    
    ctx.TellSuccess(msg)
}

func (x *MyNode) Destroy() {
    // å®‰å…¨ï¼šä½¿ç”¨å†™é”ä¿æŠ¤çŠ¶æ€ä¿®æ”¹
    x.clientMutex.Lock()
    defer x.clientMutex.Unlock()
    
    if x.client != nil {
        _ = x.client.Close()
        x.client = nil
    }
    x.isConnected = false
}

func (x *MyNode) UpdateConfig(newConfig Config) {
    // å®‰å…¨ï¼šé…ç½®æ›´æ–°ä¹Ÿéœ€è¦åŒæ­¥ä¿æŠ¤
    x.configMutex.Lock()
    defer x.configMutex.Unlock()
    x.config = newConfig
}

func (x *MyNode) getConfig() Config {
    // å®‰å…¨ï¼šè¯»å–é…ç½®ä½¿ç”¨è¯»é”
    x.configMutex.RLock()
    defer x.configMutex.RUnlock()
    return x.config
}
```

#### å¹¶å‘å®‰å…¨æ ¸å¿ƒåŸåˆ™

1. **è¯†åˆ«å…±äº«çŠ¶æ€**ï¼š
   - å®¢æˆ·ç«¯è¿æ¥ï¼ˆdatabaseã€HTTPã€TCPç­‰ï¼‰
   - é…ç½®ä¿¡æ¯ï¼ˆå¦‚æœè¿è¡Œæ—¶å¯ä¿®æ”¹ï¼‰
   - è®¡æ•°å™¨ã€çŠ¶æ€æ ‡å¿—
   - ç¼“å­˜ã€ç¼“å†²åŒº

2. **é€‰æ‹©åˆé€‚çš„åŒæ­¥æœºåˆ¶**ï¼š
   - `sync.RWMutex`ï¼šä¿æŠ¤å¤æ‚ç»“æ„ä½“ã€è¿æ¥å¯¹è±¡
   - `sync.Mutex`ï¼šä¿æŠ¤ç®€å•çŠ¶æ€ã€ç‹¬å è®¿é—®
   - `atomic`æ“ä½œï¼šä¿æŠ¤è®¡æ•°å™¨ã€ç®€å•æ•°å€¼
   - `sync.Once`ï¼šç¡®ä¿åªæ‰§è¡Œä¸€æ¬¡çš„åˆå§‹åŒ–

3. **é¿å…å¸¸è§é™·é˜±**ï¼š
   - æ£€æŸ¥-ç„¶å-ä½¿ç”¨ç«äº‰æ¡ä»¶
   - æŒæœ‰é”æ—¶é—´è¿‡é•¿
   - åµŒå¥—é”å¯¼è‡´æ­»é”
   - å¿˜è®°ä¿æŠ¤"è¯»å–"æ“ä½œ

4. **æœ€ä½³å®è·µ**ï¼š
   - æœ€å°åŒ–é”çš„ç²’åº¦å’ŒæŒæœ‰æ—¶é—´
   - ä½¿ç”¨deferç¡®ä¿é”çš„é‡Šæ”¾
   - ä¼˜å…ˆä½¿ç”¨è¯»é”è¿›è¡Œè¯»æ“ä½œ
   - åœ¨å‡½æ•°è¿”å›å‰è·å–çŠ¶æ€çš„æœ¬åœ°å‰¯æœ¬

> **é‡è¦æé†’**ï¼šå³ä½¿æ˜¯"ç®€å•"çš„ç»„ä»¶ï¼Œåªè¦æœ‰å…±äº«å¯å˜çŠ¶æ€ï¼Œå°±éœ€è¦è€ƒè™‘å¹¶å‘å®‰å…¨ï¼

### SharedNode ä¸“ç”¨è¦æ±‚

å¯¹äºä½¿ç”¨SharedNodeçš„ç»„ä»¶ï¼Œé™¤äº†é€šç”¨è¦æ±‚å¤–ï¼Œè¿˜éœ€è¦ï¼š

### è¯¦ç»†èŠ‚ç‚¹æ‰§è¡Œæ§åˆ¶ä¸Šä¸‹æ–‡æ¥å£

èŠ‚ç‚¹æ¥å£ä¸­å¤„ç†æ¶ˆæ¯å‡½æ•°ï¼š`OnMsg(ctx RuleContext, msg RuleMsg)`ï¼Œå…¶ä¸­æ‰§è¡Œä¸Šä¸‹æ–‡`ctx`å¯ä»¥å¯¹è§„åˆ™å¼•æ“èŠ‚ç‚¹è¿›è¡Œæµè½¬å·²ç»ç¼–æ’æ§åˆ¶ã€‚

`ctx`æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š
```go
// RuleContext æ˜¯è§„åˆ™å¼•æ“ä¸­æ¶ˆæ¯å¤„ç†ä¸Šä¸‹æ–‡çš„æ¥å£ã€‚
// å®ƒå°†æ¶ˆæ¯ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ã€‚å¹¶è§¦å‘å®ƒä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚
// ä»¥åŠå¯¹æœ¬æ¬¡æ‰§è¡Œå®ä¾‹çš„èŠ‚ç‚¹æµç¨‹è¿›è¡Œæ§åˆ¶å’Œç¼–æ’
type RuleContext interface {
	// TellSuccess é€šçŸ¥è§„åˆ™å¼•æ“å½“å‰æ¶ˆæ¯å·²æˆåŠŸå¤„ç†ï¼Œå¹¶é€šè¿‡ 'Success' å…³ç³»å°†æ¶ˆæ¯å‘é€åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚
	TellSuccess(msg RuleMsg)
	// TellFailure é€šçŸ¥è§„åˆ™å¼•æ“å½“å‰æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œå¹¶é€šè¿‡ 'Failure' å…³ç³»å°†æ¶ˆæ¯å‘é€åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚
	TellFailure(msg RuleMsg, err error)
	// TellNext ä½¿ç”¨æŒ‡å®šçš„ relationTypes å°†æ¶ˆæ¯å‘é€åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚
	TellNext(msg RuleMsg, relationTypes ...string)
	// TellSelf åœ¨æŒ‡å®šçš„å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰åå°†æ¶ˆæ¯å‘é€åˆ°å½“å‰èŠ‚ç‚¹ã€‚
	TellSelf(msg RuleMsg, delayMs int64)
	// TellNextOrElse ä½¿ç”¨æŒ‡å®šçš„ relationTypes å°†æ¶ˆæ¯å‘é€åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚å¦‚æœç›¸åº”çš„ relationType æ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™ä½¿ç”¨ defaultRelationType è¿›è¡Œæœç´¢ã€‚
	TellNextOrElse(msg RuleMsg, defaultRelationType string, relationTypes ...string)
	// TellFlow æ‰§è¡Œå­è§„åˆ™é“¾ã€‚
	TellFlow(ctx context.Context, ruleChainId string, msg RuleMsg, endFunc OnEndFunc, onAllNodeCompleted func())
	// TellNode ä»æŒ‡å®šèŠ‚ç‚¹å¼€å§‹æ‰§è¡Œã€‚å¦‚æœ skipTellNext=trueï¼Œåˆ™åªæ‰§è¡Œå½“å‰èŠ‚ç‚¹ï¼Œä¸é€šçŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚
	// onEnd ç”¨äºæŸ¥çœ‹æœ€ç»ˆæ‰§è¡Œç»“æœã€‚
	TellNode(ctx context.Context, nodeId string, msg RuleMsg, skipTellNext bool, onEnd OnEndFunc, onAllNodeCompleted func())
	// NewMsg åˆ›å»ºä¸€ä¸ªæ–°æ¶ˆæ¯å®ä¾‹ã€‚
	NewMsg(msgType string, metaData Metadata, data string) RuleMsg
	// GetSelfId æ£€ç´¢å½“å‰èŠ‚ç‚¹ IDã€‚
	GetSelfId() string
	// Self æ£€ç´¢å½“å‰èŠ‚ç‚¹å®ä¾‹ã€‚
	Self() NodeCtx
	// From æ£€ç´¢æ¶ˆæ¯è¿›å…¥å½“å‰èŠ‚ç‚¹çš„èŠ‚ç‚¹å®ä¾‹ã€‚
	From() NodeCtx
	// RuleChain æ£€ç´¢å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„è§„åˆ™é“¾å®ä¾‹ã€‚
	RuleChain() NodeCtx
	// Config æ£€ç´¢è§„åˆ™å¼•æ“çš„é…ç½®ã€‚
	Config() Config
	// SubmitTack æäº¤ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ä»¥ä¾›æ‰§è¡Œã€‚
	SubmitTack(task func())
	// SetEndFunc è®¾ç½®å½“å‰æ¶ˆæ¯å¤„ç†ç»“æŸæ—¶çš„å›è°ƒå‡½æ•°ã€‚
	SetEndFunc(f OnEndFunc) RuleContext
	// GetEndFunc æ£€ç´¢å½“å‰æ¶ˆæ¯å¤„ç†ç»“æŸæ—¶çš„å›è°ƒå‡½æ•°ã€‚
	GetEndFunc() OnEndFunc
	// SetContext è®¾ç½®å…±äº«ä¿¡å·é‡æˆ–æ•°æ®çš„ä¸Šä¸‹æ–‡ï¼Œè·¨ä¸åŒç»„ä»¶å®ä¾‹ã€‚
	SetContext(c context.Context) RuleContext
	// GetContext æ£€ç´¢å…±äº«ä¿¡å·é‡æˆ–æ•°æ®çš„ä¸Šä¸‹æ–‡ï¼Œè·¨ä¸åŒç»„ä»¶å®ä¾‹ã€‚
	GetContext() context.Context
	// SetOnAllNodeCompleted è®¾ç½®æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œå®Œæˆæ—¶çš„å›è°ƒã€‚
	SetOnAllNodeCompleted(onAllNodeCompleted func())
	// DoOnEnd è§¦å‘ OnEnd å›è°ƒå‡½æ•°ã€‚
	DoOnEnd(msg RuleMsg, err error, relationType string)
	// SetCallbackFunc è®¾ç½®å›è°ƒå‡½æ•°ã€‚
	SetCallbackFunc(functionName string, f interface{})
	// GetCallbackFunc æ£€ç´¢å›è°ƒå‡½æ•°ã€‚
	GetCallbackFunc(functionName string) interface{}
	// OnDebug è°ƒç”¨é…ç½®çš„ OnDebug å›è°ƒå‡½æ•°ã€‚
	OnDebug(ruleChainId string, flowType string, nodeId string, msg RuleMsg, relationType string, err error)
	// SetExecuteNode è®¾ç½®å½“å‰èŠ‚ç‚¹ã€‚
	// å¦‚æœ relationTypes ä¸ºç©ºï¼Œåˆ™æ‰§è¡Œå½“å‰èŠ‚ç‚¹ï¼›å¦åˆ™ï¼Œ
	// æŸ¥æ‰¾å¹¶æ‰§è¡Œå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚
	SetExecuteNode(nodeId string, relationTypes ...string)
}
```

### ç¤ºä¾‹

å®ç°[types.Node](https://github.com/rulego/rulego/blob/main/api/types/types.go)æ¥å£ï¼Œå®šä¹‰ç»„ä»¶ï¼š

```go
//UpperNode A plugin that converts the message data to uppercase
type UpperNode struct{}

func (n *UpperNode) Type() string {
   return "test/upper"
}
func (n *UpperNode) New() types.Node {
  return &UpperNode{}
}
func (n *UpperNode) Init(ruleConfig types.Config, configuration types.Configuration) error {
  // Do some initialization work
  return nil
}
//å¤„ç†æ¶ˆæ¯
func (n *UpperNode) OnMsg(ctx types.RuleContext, msg types.RuleMsg)  {
  msg.Data = strings.ToUpper(msg.Data)
  // Send the modified message to the next node
  ctx.TellSuccess(msg)
}

func (n *UpperNode) Destroy() {
// Do some cleanup work
}
```

æŠŠç»„ä»¶æ³¨å†Œåˆ°æ³¨å†Œå™¨ï¼š
```go
rulego.Registry.Register(&MyNode{})
```

ç„¶ååœ¨è§„åˆ™é“¾æ–‡ä»¶ä½¿ç”¨ä½ çš„è‡ªå®šä¹‰ç»„ä»¶ï¼š

``` json
{
  "ruleChain": {
    "name": "æµ‹è¯•è§„åˆ™é“¾",
    "root": true,
    "debugMode": false
  },
  "metadata": {
    "nodes": [
      {
        "id": "s1",
        "type": "test/upper",
        "name": "åç§°",
        "debugMode": true,
        "configuration": {
          "field1": "ç»„ä»¶å®šä¹‰çš„é…ç½®å‚æ•°",
          "....": "..."
        }
      }
    ],
    "connections": [
      {
        "fromId": "s1",
        "toId": "è¿æ¥ä¸‹ä¸€ä¸ªç»„ä»¶ID",
        "type": "ä¸ç»„ä»¶çš„è¿æ¥å…³ç³»"
      }
    ]
  }
}
```

## `go plugin` æ–¹å¼æä¾›ç»„ä»¶

è¿™ç§æ–¹å¼æ”¯æŒåŠ¨æ€åŠ è½½ç»„ä»¶ï¼Œä½†æ˜¯åªèƒ½æ”¯æŒéwindowsç³»ç»Ÿã€‚ ä¸€ä¸ªæ’ä»¶å¯ä»¥æä¾›å¤šä¸ªç»„ä»¶ã€‚    

å®ç°[types.PluginRegistry](https://github.com/rulego/rulego/blob/main/api/types/types.go)æ¥å£ã€‚
å¹¶å¯¼å‡ºå˜é‡åç§°:`Plugins`,å‚è€ƒ[examples/plugin](https://github.com/rulego/rulego/tree/main/examples/plugin)

### ç¤ºä¾‹
å®ç°[types.PluginRegistry](https://github.com/rulego/rulego/blob/main/api/types/types.go)æ¥å£

```go
// å¯¼å‡ºæ’ä»¶å˜é‡
var Plugins MyPlugins

type MyPlugins struct{}

func (p *MyPlugins) Init() error {
    return nil
}
func (p *MyPlugins) Components() []types.Node {
  //ä¸€ä¸ªæ’ä»¶å¯ä»¥æä¾›å¤šä¸ªç»„ä»¶
  return []types.Node{&UpperNode{}, &TimeNode{}, &FilterNode{}}
}
```

ç¼–è¯‘æ’ä»¶ï¼š
``` shell
#ç¼–è¯‘æ’ä»¶ï¼Œç”Ÿæˆplugin.soæ–‡ä»¶ï¼Œéœ€è¦åœ¨macæˆ–è€…linuxç¯å¢ƒä¸‹ç¼–è¯‘
go build -buildmode=plugin -o plugin.so plugin.go
```

æŠŠç»„ä»¶æ³¨å†Œåˆ°æ³¨å†Œå™¨ï¼š
```go
rulego.Registry.RegisterPlugin("test", "./plugin.so")
```

## å¯è§†åŒ–
- [ç»„ä»¶é…ç½®è¡¨å•çº¦å®š](/pages/af0195/)
- è‡ªå®šä¹‰ç»„ä»¶å¯è§†åŒ–å‚è€ƒï¼š[è·å–ç»„ä»¶é…ç½®è¡¨å•](/pages/cf0194/) ç« èŠ‚

## è´¡çŒ®ç»„ä»¶

RuleGo çš„æ ¸å¿ƒç‰¹æ€§æ˜¯ç»„ä»¶åŒ–ï¼Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½æ˜¯ç»„ä»¶ï¼Œå¹¶èƒ½çµæ´»é…ç½®å’Œé‡ç”¨å®ƒä»¬ã€‚ç›®å‰RuleGo å·²ç»å†…ç½®äº†å¤§é‡å¸¸ç”¨çš„ç»„ä»¶ã€‚     
ä½†æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“è¿™äº›ç»„ä»¶è¿˜è¿œè¿œä¸èƒ½æ»¡è¶³æ‰€æœ‰ç”¨æˆ·çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›èƒ½æœ‰æ›´å¤šçš„å¼€å‘è€…ä¸º RuleGo è´¡çŒ®æ‰©å±•ç»„ä»¶ï¼Œè®© RuleGo çš„ç”Ÿæ€æ›´åŠ ä¸°å¯Œå’Œå¼ºå¤§ã€‚

* å¦‚æœæ‚¨æäº¤çš„ç»„ä»¶ä»£ç æ²¡æœ‰ç¬¬ä¸‰æ–¹ä¾èµ–æˆ–è€…æ˜¯é€šç”¨æ€§ç»„ä»¶è¯·æäº¤åˆ°ä¸»åº“ä¸‹çš„æ ‡å‡†ç»„ä»¶[components](https://github.com/rulego/rulego) 
* å¸¸ç”¨ç»„ä»¶æäº¤åˆ°æ‰©å±•ç»„ä»¶ä»“åº“ï¼š[rulego-components](https://github.com/rulego/rulego-components)
* CI/CDç›¸å…³ç»„ä»¶æäº¤åˆ°ï¼š[rulego-components-ci](https://github.com/rulego/rulego-components-ci)
* AIç›¸å…³ç»„ä»¶æäº¤åˆ°ï¼š[rulego-components-ai](https://github.com/rulego/rulego-components-ai)
* IoTç›¸å…³ç»„ä»¶æäº¤åˆ°ï¼š[rulego-components-iot](https://github.com/rulego/rulego-components-iot)