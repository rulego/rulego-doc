---
title: 包容分支
article: false
author:
  name: rulego
  link: https://github.com/rulego/rulego
date: 2025-11-27 10:00:00
permalink: /pages/inclusive/
---
`inclusive`组件：包容分支组件。与`switch`条件分支不同，`inclusive`会评估所有配置的`case`表达式，并将消息同时路由到所有匹配的关系；如果无任何匹配，则路由到默认的`Default`关系；当表达式执行出错时，消息将被路由到`Failure`关系。

## 配置

| 字段    | 类型     | 说明           | 默认值 |
|-------|--------|--------------|-----|
| cases | Case列表 | 条件表达式列表 | 无   |

**Case配置项:**

| 字段   | 类型     | 说明        | 默认值 |
|------|--------|-----------|-----|
| case | string | 条件表达式   | 无   |
| then | string | 路由关系名称 | 无   |

表达式使用 [expr](https://expr-lang.org/docs/language-definition) 引擎，支持以下内置变量：
- `id` - 消息ID
- `ts` - 消息时间戳(毫秒)
- `data` - 消息原始内容
- `msg` - 消息体。若`dataType`为JSON，可通过 `msg.field` 访问字段，例如: `msg.temperature > 50`
- `metadata` - 消息元数据，例如 `metadata.customerName`
- `type` - 消息类型
- `dataType` - 数据类型

表达式示例：
- `msg.temperature > 50`
- `msg.temperature > 50 && metadata.customerName == 'rulego'`
- `upper(metadata.customerName[:4]) == 'GO'`
- `replace(toJSON(msg),'name','productName')`
- `msg.humidity >= 80 || msg.temperature >= 30`

> 更多expr表达式语法和函数请参考：[expr语言定义](https://expr-lang.org/docs/language-definition)

## Relation Type

- ***Case.then:*** 当匹配到某个`case`表达式时，消息将被路由到该`case`配置的`then`关系链（可能同时命中多个分支）
- ***Default:*** 当所有`case`表达式都匹配失败时，消息将被路由到`Default`关系链
- ***Failure:*** 当表达式执行出错时，消息将被路由到`Failure`关系链

## 执行结果

该组件是纯路由组件，不会修改传入的`msg`、`metadata`和`msgType`内容。它会为每个匹配到的`case`分支分别转发一次消息；当无任何匹配时转发到`Default`关系。

实现参考：在 `d:\github\rulego\components\common\inclusive_node.go:66` 中，组件遍历所有`case`表达式，命中后收集对应关系并通过 `TellNext` 同时路由到多个关系；未命中则路由到默认关系。

## 与条件分支的区别

- `switch`（条件分支）：按顺序匹配`case`表达式，命中第一个后停止匹配，仅路由到一个分支。
- `inclusive`（包容分支）：评估所有`case`表达式，命中的所有分支会被同时路由；若全部未命中则路由到`Default`。
- 错误处理：两者一致，表达式执行错误时路由到`Failure`。

## 配置示例

```json
{
  "ruleChain": {
    "id": "inc-01",
    "name": "测试包容分支",
    "debugMode": true,
    "root": true
  },
  "metadata": {
    "endpoints": [],
    "nodes": [
      {
        "id": "node_inclusive",
        "additionalInfo": {
          "description": "",
          "layoutX": 480,
          "layoutY": 280
        },
        "type": "inclusive",
        "name": "包容分支",
        "debugMode": false,
        "configuration": {
          "cases": [
            {
              "case": "msg.temperature>=20 && msg.temperature<=50",
              "then": "Case1"
            },
            {
              "case": "msg.temperature>50",
              "then": "Case2"
            }
          ]
        }
      },
      {
        "id": "node_case1",
        "additionalInfo": {
          "description": "",
          "layoutX": 840,
          "layoutY": 160
        },
        "type": "jsTransform",
        "name": "case1",
        "debugMode": false,
        "configuration": {
          "jsScript": "msg=msg||{}\nmsg.match='Case1'\nreturn {'msg':msg,'metadata':metadata,'msgType':msgType};"
        }
      },
      {
        "id": "node_case2",
        "additionalInfo": {
          "description": "",
          "layoutX": 840,
          "layoutY": 280
        },
        "type": "jsTransform",
        "name": "case2",
        "debugMode": false,
        "configuration": {
          "jsScript": "msg=msg||{}\nmsg.match='Case2'\nreturn {'msg':msg,'metadata':metadata,'msgType':msgType};"
        }
      },
      {
        "id": "node_default",
        "additionalInfo": {
          "description": "",
          "layoutX": 840,
          "layoutY": 380
        },
        "type": "jsTransform",
        "name": "default",
        "debugMode": false,
        "configuration": {
          "jsScript": "msg=msg||{}\nmsg.match='Default'\nreturn {'msg':msg,'metadata':metadata,'msgType':msgType};"
        }
      }
    ],
    "connections": [
      { "fromId": "node_inclusive", "toId": "node_case1", "type": "Case1" },
      { "fromId": "node_inclusive", "toId": "node_case2", "type": "Case2" },
      { "fromId": "node_inclusive", "toId": "node_default", "type": "Default" }
    ]
  }
}
```
